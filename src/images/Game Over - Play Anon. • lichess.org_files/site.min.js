var _i=Object.defineProperty;var gt=(e,t)=>{for(var o in t)_i(e,o,{get:t[o],enumerable:!0})};var u={date:"2024-03-15T20:36:45+00:00",commit:"aa133ca08044e214bcbb68cf2be3626a02b06ed8",message:"faster main broadcast button reaction"};var Re="\uE025";var xo="\uE038";var ko="\uE03A";var vt="\uE03F";var To="\uE048";var Po="\uE04D";var Co="\uE056";var Mo="\uE05A";var So="\uE065";var Fe={};gt(Fe,{fenColor:()=>Ve,init:()=>Oo,initAll:()=>je,initWith:()=>Ho,renderClock:()=>Hi});function bt(e,t,o,n,i){let r=t===void 0?void 0:t.key;return{sel:e,data:t,children:o,text:n,elm:i,key:r}}var wt=Array.isArray;function Be(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function Eo(e,t,o){if(e.ns="http://www.w3.org/2000/svg",o!=="foreignObject"&&t!==void 0)for(let n=0;n<t.length;++n){let i=t[n];if(typeof i=="string")continue;let r=i.data;r!==void 0&&Eo(r,i.children,i.sel)}}function J(e,t,o){let n={},i,r,s;if(o!==void 0?(t!==null&&(n=t),wt(o)?i=o:Be(o)?r=o.toString():o&&o.sel&&(i=[o])):t!=null&&(wt(t)?i=t:Be(t)?r=t.toString():t&&t.sel?i=[t]:n=t),i!==void 0)for(s=0;s<i.length;++s)Be(i[s])&&(i[s]=bt(void 0,void 0,void 0,i[s],void 0));return e[0]==="s"&&e[1]==="v"&&e[2]==="g"&&(e.length===3||e[3]==="."||e[3]==="#")&&Eo(n,i,e),bt(e,n,i,r,void 0)}var $o=e=>`lichess-${e}`,We=(e,t)=>e[$o(t)],ae=(e,t,o)=>e[$o(t)]=o;var Ao=["white","black"],ce=["a","b","c","d","e","f","g","h"],he=["1","2","3","4","5","6","7","8"];var Do=[...he].reverse(),qe=Array.prototype.concat(...ce.map(e=>he.map(t=>e+t))),P=e=>qe[8*e[0]+e[1]],h=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],ge=e=>{if(e)return e[1]==="@"?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},ze=qe.map(h);function _o(e){let t,o=()=>(t===void 0&&(t=e()),t);return o.clear=()=>{t=void 0},o}var Io=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},ve=e=>e==="white"?"black":"white",Z=(e,t)=>{let o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},be=(e,t)=>e.role===t.role&&e.color===t.color,ee=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],A=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},xt=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},we=(e,t)=>{e.style.visibility=t?"visible":"hidden"},z=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Ke=e=>{var t;return(((t=e.buttons)!==null&&t!==void 0?t:0)&2)===2},L=(e,t)=>{let o=document.createElement(e);return t&&(o.className=t),o};function Ue(e,t,o){let n=h(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}var Oo=e=>{let[t,o,n]=e.getAttribute("data-state").split(",");Ho(e,t,o,n)},Ho=(e,t,o,n)=>{ae(e,"chessground",site.makeChessground(e,{orientation:o,coordinates:!1,viewOnly:!e.getAttribute("data-playable"),fen:t,lastMove:ge(n),drawable:{enabled:!1,visible:!1}}))},je=e=>Array.from((e||document).getElementsByClassName("mini-board--init")).forEach(t=>{t.classList.remove("mini-board--init"),Oo(t)}),Ve=e=>e.includes(" w")?"white":"black",Hi=(e,t)=>J(`span.mini-game__clock.mini-game__clock--${e}`,{attrs:{"data-time":t,"data-managed":1}});var Xe={};gt(Xe,{finish:()=>Lt,init:()=>Zo,initAll:()=>Ge,update:()=>At});var No=e=>{let t=new Date(Math.max(0,e+500)),o=t.getUTCHours(),n=t.getUTCMinutes(),i=t.getUTCSeconds();return o>0?o+":"+kt(n)+":"+kt(i):n+":"+kt(i)};var Tt=(e,t)=>t=="white"?!e.includes("PPPPPPPP/RNBQKBNR"):!e.startsWith("rnbqkbnr/pppppppp"),kt=e=>(e<10?"0":"")+e;function ye(e,t){let o=We(e,"clock");o?o.set(t):ae(e,"clock",new Pt(e,t))}var Pt=class{constructor(t,o){this.el=t;this.opts=o;this.set=t=>{this.opts=t,this.target=t.time*1e3+Date.now(),this.render(),clearInterval(this.interval),t.pause||(this.interval=setInterval(this.render,1e3))};this.render=()=>{document.body.contains(this.el)?(this.el.textContent=No(this.target-Date.now()),this.el.classList.toggle("clock--run",!this.opts.pause)):clearInterval(this.interval)};this.target=o.time*1e3+Date.now(),o.pause||(this.interval=setInterval(this.render,1e3)),this.render()}};var xe=e=>e!==void 0,ke=e=>e!=null;var I=e=>{let t;return()=>(t===void 0&&(t=e()),t)},Ro=(e,t,o=!1)=>Ni(e,e.querySelector(t),o),Ni=(e,t,o=!1)=>{t&&(o?e.scrollLeft=t.offsetLeft-e.offsetWidth/2+t.offsetWidth/2:e.scrollTop=t.offsetTop-e.offsetHeight/2+t.offsetHeight/2)};var Ri={cache:"no-cache",credentials:"same-origin"},Bi={"X-Requested-With":"XMLHttpRequest"},Wi=e=>{if(e.ok)return e;throw e.status==429?new Error("Too many requests"):e.status==413?new Error("The uploaded file is too large"):new Error(`Error ${e.status}`)};var K=(e,t={})=>qi(e,t).then(o=>Wi(o).text()),qi=(e,t={})=>fetch(e,{...Ri,headers:{...Bi},...t}),Bo=e=>new Promise((t,o)=>{let n=document.body.getAttribute("data-nonce"),i=document.createElement("script");n&&i.setAttribute("nonce",n),i.onload=t,i.onerror=o,i.src=e,document.head.append(i)});var Wo=(e,t)=>{let o=new URLSearchParams;for(let i of Object.keys(t))xe(t[i])&&o.append(i,t[i]);let n=o.toString();return n?`${e}?${n}`:e};function Te(e,t,o){let n=["mousemove","touchstart"],i=!1,r=!0,s=performance.now(),a=()=>{r||o(),r=!0,s=performance.now(),l()},c=()=>{i||(n.forEach(d=>document.addEventListener(d,a)),i=!0)},l=()=>{i&&(n.forEach(d=>document.removeEventListener(d,a)),i=!1)};setInterval(()=>{r&&performance.now()-s>e&&(t(),r=!1),c()},1e4)}var qo=()=>{try{let e=window.crypto.getRandomValues(new Uint8Array(9));return btoa(String.fromCharCode(...e)).replace(/[/+]/g,"_")}catch(e){return Math.random().toString(36).slice(2,12)}};var zi=qo(),V=zi;function zo(e,t){if(t.length)if(e.includes("%s"))e=e.replace("%s",t[0]);else for(let o=0;o<t.length;o++)e=e.replace("%"+(o+1)+"$s",t[o]);return e}function Ko(e,t){let o=e.split(/(%(?:\d\$)?s)/g);if(t.length){let n=o.indexOf("%s");if(n!==-1)o[n]=t[0];else for(let i=0;i<t.length;i++){let r=o.indexOf("%"+(i+1)+"$s");r!==-1&&(o[r]=t[i])}}return o}var Ct=e=>{let t=(n,...i)=>{let r=e[n];return r?zo(r,i):n},o=(n,i)=>e[`${n}:${site.quantity(i)}`]||e[`${n}:other`]||e[n]||e[`${n}:one`];return t.pluralSame=(n,i,...r)=>t.plural(n,i,i,...r),t.plural=function(n,i,...r){let s=o(n,i);return s?zo(s,r):n},t.noarg=n=>e[n]||n,t.vdom=(n,...i)=>{let r=e[n];return r?Ko(r,i):[n]},t.vdomPlural=(n,i,...r)=>{let s=o(n,i);return s?Ko(s,r):[n]},t},Uo,E=Ct(((Uo=window.site)==null?void 0:Uo.siteI18n)||{});async function jo(e,t){let o,n=new Promise((r,s)=>{o=setTimeout(()=>s(new Error("Async call timeout limit reached")),t)}),i=await Promise.race([e,n]);return o&&clearTimeout(o),i}var Vo=!1,Fo=async(e,t)=>{try{t&&await jo(site.sound.play("genericNotify"),1e3)}catch(i){console.warn(i)}let o;if(typeof e=="string")o=e;else if(o=e.url,e.cookie){let i=[encodeURIComponent(e.cookie.name)+"="+e.cookie.value,"; max-age="+e.cookie.maxAge,"; path=/","; domain="+location.hostname].join("");document.cookie=i}let n="//"+location.host+"/"+o.replace(/^\//,"");Vo=n,location.href=n},Mt={expected:!1},Pe=e=>{e&&console.warn(e),!Vo&&(Mt.expected=!0,site.socket.disconnect(),location.hash?location.reload():location.assign(location.href))};var Go=e=>{let t={get:o=>e.getItem(o),set:(o,n)=>e.setItem(o,n),fire:(o,n)=>e.setItem(o,JSON.stringify({sri:V,nonce:Math.random(),value:n})),remove:o=>e.removeItem(o),make:(o,n)=>{let i=n&&`${o}--bd`,r=()=>{t.remove(o),i&&t.remove(i)};return{get:()=>{if(!i)return t.get(o);let s=Number(t.get(i));return s?Date.now()-s>n&&r():t.set(i,String(Date.now())),t.get(o)},set:s=>{t.set(o,s),i&&t.set(i,String(Date.now()))},fire:s=>t.fire(o,s),remove:r,listen:s=>window.addEventListener("storage",a=>{if(a.key!==o||a.storageArea!==e||a.newValue===null)return;let c;try{c=JSON.parse(a.newValue)}catch(l){return}c!=null&&c.sri&&c.sri!==V&&s(c)})}},boolean:o=>({get:()=>t.get(o)=="1",getOrDefault:n=>{let i=t.get(o);return i===null?n:i=="1"},set:n=>t.set(o,n?"1":"0"),toggle:()=>t.set(o,t.get(o)=="1"?"0":"1")})};return t},D=Go(window.localStorage),Xo=Go(window.sessionStorage);function Yo(e,t,o,n){let i="analyse."+e,r;return function(s){if(xe(s)&&s!=r)r=s,site.storage.set(e,n(s));else if(!xe(r)){let a=site.storage.get(i);ke(a)&&(site.storage.set(e,a),site.storage.remove(i));let c=site.storage.get(e);r=c===null?t:o(c)}return r}}var Qo=(e,t)=>Yo(e,t,o=>o,o=>o);var St=(e,t)=>Yo(e,t,o=>Number(o),o=>o+"");function Ce(e,t){return t==="always"?!0:D.get(e)?!1:(D.set(e,"1"),!0)}var Ki=WebSocket.prototype.send,Et=()=>!("onLine"in navigator)||navigator.onLine,F=class F{constructor(t,o,n={}){this.url=t;this.pubsub=site.pubsub;this.ackable=new $t((t,o,n)=>this.send(t,o,n));this.lastPingTime=performance.now();this.pongCount=0;this.averageLag=0;this.tryOtherUrl=!1;this.autoReconnect=!0;this.nbConnects=0;this.storage=D.make(document.body.dataset.socketAlternates?"surl-alt":"surl17",30*60*1e3);this.resendWhenOpen=[];this.baseUrls=(document.body.dataset.socketAlts||document.body.dataset.socketDomains).split(",");this.sign=t=>{this._sign=t,this.ackable.sign(t)};this.connect=()=>{if(this.destroy(),!Et()){document.body.classList.remove("online"),document.body.classList.add("offline"),$("#network-status").text(site?E("noNetwork"):"Offline"),this.scheduleConnect(1e3);return}this.autoReconnect=!0;let t=Wo(this.options.protocol+"//"+this.baseUrl()+this.url,{...this.settings.params,v:this.version===!1?void 0:this.version});this.debug("connection attempt to "+t);try{let o=this.ws=new WebSocket(t);o.onerror=n=>this.onError(n),o.onclose=n=>this.onClose(n,t),o.onopen=()=>{this.debug("connected to "+t),this.onSuccess();let n=document.body.classList;n.remove("offline"),n.add("online"),n.toggle("reconnected",this.nbConnects>1),this.pingNow(),this.resendWhenOpen.forEach(([i,r,s])=>this.send(i,r,s)),this.resendWhenOpen=[],this.pubsub.emit("socket.open"),this.ackable.resend()},o.onmessage=n=>{if(n.data==0)return this.pong();let i=JSON.parse(n.data);i.t==="n"&&this.pong(),this.handle(i)}}catch(o){this.onClose({code:4e3,reason:String(o)},t)}this.scheduleConnect(this.options.pingMaxLag)};this.send=(t,o,n={},i=!1)=>{let r={t};o!==void 0&&(n.withLag&&(o.l=Math.round(this.averageLag)),n.millis>=0&&(o.s=Math.round(n.millis*.1).toString(36)),r.d=o),n.ackable&&(r.d=r.d||{},this.ackable.register(t,r.d));let s=JSON.stringify(r);if(!(t=="racerScore"&&n.sign!=this._sign)){if(t=="move"&&n.sign!=this._sign){let a;try{a=new Error().stack.split(`
`).join(" / ").replace(/\s+/g," ")}catch(c){a=`${c.message} ${navigator.userAgent}`}a.includes("round.nvui")||setTimeout(()=>{Ce(`socket.rep.${Math.round(Date.now()/1e3/3600/3)}`)?this.send("rep",{n:`soc: ${s} ${a}`}):site.socket.destroy()},1e4)}this.debug("send "+s),!this.ws||this.ws.readyState===WebSocket.CONNECTING?i||this.resendWhenOpen.push([t,r.d,n]):Ki.apply(this.ws,[s])}};this.scheduleConnect=t=>{this.options.idle&&(t=10*1e3+Math.random()*10*1e3),clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.connectSchedule=setTimeout(()=>{document.body.classList.add("offline"),document.body.classList.remove("online"),$("#network-status").text(site?E("reconnecting"):"Reconnecting"),!this.tryOtherUrl&&Et()&&(this.tryOtherUrl=!0,site.log(`sri ${this.settings.params.sri} timeout ${t}ms, trying ${this.baseUrl()}${this.url}`)),this.connect()},t)};this.schedulePing=t=>{clearTimeout(this.pingSchedule),this.pingSchedule=setTimeout(this.pingNow,t)};this.pingNow=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule);let t=this.options.isAuth&&this.pongCount%10==2?JSON.stringify({t:"p",l:Math.round(.1*this.averageLag)}):"null";try{this.ws.send(t),this.lastPingTime=performance.now()}catch(o){this.debug(o,!0)}this.scheduleConnect(this.options.pingMaxLag)};this.computePingDelay=()=>this.options.pingDelay+(this.options.idle?1e3:0);this.pong=()=>{clearTimeout(this.connectSchedule),this.schedulePing(this.computePingDelay());let t=Math.min(performance.now()-this.lastPingTime,1e4);this.pongCount++;let o=this.pongCount>4?.1:1/this.pongCount;this.averageLag+=o*(t-this.averageLag),this.pubsub.emit("socket.lag",this.averageLag)};this.handle=t=>{if(t.v&&this.version!==!1){if(t.v<=this.version){this.debug("already has event "+t.v);return}if(t.v>this.version+1)return Pe();this.version=t.v}switch(t.t||!1){case!1:break;case"resync":Pe("lila-ws resync");break;case"ack":this.ackable.onServerAck(t.d);break;default:this.settings.receive&&this.settings.receive(t.t,t.d)||this.settings.events[t.t]&&this.settings.events[t.t](t.d||null,t)||this.pubsub.emit("socket.in."+t.t,t.d,t)}};this.debug=(t,o=!1)=>{(o||this.options.debug)&&console.debug(t)};this.destroy=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.disconnect(),this.ws=void 0};this.disconnect=()=>{let t=this.ws;t&&(this.debug("Disconnect"),this.autoReconnect=!1,t.onerror=t.onclose=t.onopen=t.onmessage=()=>{},t.close())};this.onError=t=>{this.options.debug=!0,this.debug(`error: ${t} ${JSON.stringify(t)}`)};this.onClose=(t,o)=>{this.pubsub.emit("socket.close"),this.autoReconnect&&(this.debug("Will autoreconnect in "+this.options.autoReconnectDelay),this.scheduleConnect(this.options.autoReconnectDelay)),!(t.wasClean&&t.code<1002)&&(Et()&&site.log(`${V?"sri "+V:""} unclean close ${t.code} ${o} ${t.reason}`),this.tryOtherUrl=!0,clearTimeout(this.pingSchedule))};this.onSuccess=()=>{if(this.nbConnects++,this.nbConnects==1){F.resolveFirstConnect(this.send);let t;Te(10*60*1e3,()=>{this.options.idle=!0,t=setTimeout(this.destroy,2*60*60*1e3)},()=>{this.options.idle=!1,this.ws?clearTimeout(t):location.reload()})}};this.baseUrl=()=>{let t=this.storage.get();if(!t||!this.baseUrls.includes(t))t=this.baseUrls[Math.floor(Math.random()*this.baseUrls.length)],this.storage.set(t);else if(this.tryOtherUrl){let o=this.baseUrls.findIndex(n=>n===t);t=this.baseUrls[(o+1)%this.baseUrls.length],this.storage.set(t)}return this.tryOtherUrl=!1,t};this.pingInterval=()=>this.computePingDelay()+this.averageLag;this.getVersion=()=>this.version;this.settings={receive:n.receive,events:n.events||{},params:{...F.defaultParams,...n.params||{}}};let i=St("socket.ping.interval",2500)();this.options={...F.defaultOptions,...n.options||{},pingDelay:i>400?i:2500},this.version=o,this.pubsub.on("socket.send",this.send),this.connect()}};F.defaultOptions={idle:!1,pingMaxLag:9e3,pingDelay:2500,autoReconnectDelay:3500,protocol:location.protocol==="https:"?"wss:":"ws:",isAuth:document.body.hasAttribute("data-user")},F.defaultParams={sri:V},F.firstConnect=new Promise(t=>{F.resolveFirstConnect=t});var G=F,$t=class{constructor(t){this.send=t;this.currentId=1;this.messages=[];this.sign=t=>this._sign=t;this.resend=()=>{let t=performance.now()-2500;this.messages.forEach(o=>{o.at<t&&this.send(o.t,o.d,{sign:this._sign})})};this.register=(t,o)=>{o.a=this.currentId++,this.messages.push({t,d:o,at:performance.now()})};this.onServerAck=t=>{this.messages=this.messages.filter(o=>o.d.a!==t)};setInterval(this.resend,1200)}};var Zo=(e,t)=>{let[o,n,i]=e.getAttribute("data-state").split(","),r={coordinates:!1,viewOnly:!0,fen:o,orientation:n,lastMove:ge(i),drawable:{enabled:!1,visible:!1}},s=$(e).removeClass("mini-game--init"),a=s.find(".cg-wrap"),c=Ve(o);return ae(a[0],"chessground",(t!=null?t:site.makeChessground)(a[0],r)),["white","black"].forEach(l=>s.find(".mini-game__clock--"+l).each(function(){ye(this,{time:parseInt(this.getAttribute("data-time")),pause:l!=c||!Tt(o,l)})})),e.getAttribute("data-live")},Ge=e=>{let t=Array.from((e||document).getElementsByClassName("mini-game--init")),o=t.map(n=>Zo(n)).filter(n=>n);o.length&&G.firstConnect.then(n=>n("startWatching",o.join(" ")))},At=(e,t)=>{let o=$(e),n=t.lm,i=We(e.querySelector(".cg-wrap"),"chessground");i&&i.set({fen:t.fen,lastMove:ge(n)});let r=Ve(t.fen),s=(a,c)=>{var l;isNaN(a)||ye((l=o[0])==null?void 0:l.querySelector(".mini-game__clock--"+c),{time:a,pause:c!=r||!Tt(t.fen,c)})};s(t.wc,"white"),s(t.bc,"black")},Lt=(e,t)=>["white","black"].forEach(o=>{let n=e.querySelector(".mini-game__clock--"+o);n&&!n.dataset.managed&&$(n).replaceWith(`<span class="mini-game__result">${t?t===o[0]?1:0:"\xBD"}</span>`)});var Ui=[["nbYearsAgo","inNbYears",60*60*24*365,1],["nbMonthsAgo","inNbMonths",60*60*24*365/12,1],["nbWeeksAgo","inNbWeeks",60*60*24*7,1],["nbDaysAgo","inNbDays",60*60*24,2],["nbHoursAgo","inNbHours",60*60,1],["nbMinutesAgo","inNbMinutes",60,1],[void 0,"inNbSeconds",1,9],["rightNow","justNow",1,0]],en=e=>e instanceof Date?e:new Date(isNaN(e)?e:parseInt(e)),tn=e=>{let t=Math.abs(e),o=e<0?1:0,n=Ui.find(i=>t>=i[2]*i[3]&&i[o]);return E.pluralSame(n[o],Math.floor(t/n[2]))},ji=e=>e<1?E.noarg("completed"):e<3600?E.pluralSame("nbMinutesRemaining",Math.floor(e/60)):E.pluralSame("nbHoursRemaining",Math.floor(e/3600)),Dt=I(()=>window.Intl?new Intl.DateTimeFormat(document.documentElement.lang.startsWith("ar-")?"ar-ly":document.documentElement.lang,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"}).format:e=>e.toLocaleString()),on=e=>tn((Date.now()-en(e).getTime())/1e3),_t=e=>requestAnimationFrame(()=>{let t=Date.now();[].slice.call((e||document).getElementsByClassName("timeago"),0,99).forEach(o=>{let n=o.classList,i=n.contains("abs"),r=n.contains("set");if(o.lichessDate=o.lichessDate||en(o.getAttribute("datetime")),!r){let s=Dt()(o.lichessDate);i?o.textContent=s:o.setAttribute("title",s),n.add("set"),(i||n.contains("once"))&&n.remove("timeago")}if(n.contains("remaining")){let s=(o.lichessDate.getTime()-t)/1e3;o.textContent=ji(s)}else if(!i){let s=(t-o.lichessDate.getTime())/1e3;o.textContent=tn(s),Math.abs(s)>9999&&n.remove("timeago")}})}),It=e=>{_t(),setTimeout(()=>It(e*1.1),e)};var oe=(e,t)=>{window.requestIdleCallback?window.requestIdleCallback(e,t?{timeout:t}:void 0):requestAnimationFrame(e)},Ye=e=>/[&<>"']/.test(e)?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;"):e;var Qe,Ot=()=>{Qe&&clearTimeout(Qe),Qe=void 0,$("#announce").remove()},Fi=e=>{Ot(),e.msg&&($("body").append('<div id="announce" class="announce">'+Ye(e.msg)+(e.date?'<time class="timeago" datetime="'+e.date+'"></time>':"")+'<div class="actions"><a class="close">\xD7</a></div></div>').find("#announce .close").on("click",Ot),Qe=setTimeout(Ot,e.date?new Date(e.date).getTime()-Date.now():5e3),e.date&&site.contentLoaded())},Me=Fi;var de={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"};for(let e=1;e<20;++e)de[111+e]="f"+e;for(let e=0;e<=9;++e)de[e+96]=e.toString();var Gi={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},Xi={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},Yi=e=>{if(e.type=="keypress"){let t=String.fromCharCode(e.which);return e.shiftKey?t:t.toLowerCase()}return de[e.which]||Gi[e.which]||String.fromCharCode(e.which).toLowerCase()},Qi=(e,t)=>e.sort().join(",")===t.sort().join(","),Ji=e=>{let t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t},nn=e=>e=="shift"||e=="ctrl"||e=="alt"||e=="meta",Zi=(()=>{let e;return()=>{if(!e){e={};for(let t in de)parseInt(t,10)>95&&parseInt(t,10)<112||Object.prototype.hasOwnProperty.call(de,t)&&(e[de[t]]=t)}return e}})(),er=(e,t,o)=>(o=o||(Zi()[e]?"keydown":"keypress"),o=="keypress"&&t.length?"keydown":o),tr=e=>e==="+"?["+"]:e.replace(/\+{2}/g,"+plus").split("+"),or=(e,t)=>{let o,n=[];for(o of tr(e))o=Xi[o]||o,nn(o)&&n.push(o);return{key:o,modifiers:n,action:er(o,n,t)}},Se=class{constructor(t){this.bindings={};this.bind=(t,o,n)=>(this.bindMultiple(t instanceof Array?t:[t],o,n),this);this.bindMultiple=(t,o,n)=>{for(let i of t)this.bindSingle(i,o,n)};this.bindSingle=(t,o,n)=>{let i=or(t,n);(this.bindings[i.key]=this.bindings[i.key]||[]).push({combination:t,callback:o,modifiers:i.modifiers,action:i.action})};this.handleKeyEvent=t=>{typeof t.which!="number"&&(t.which=t.keyCode);let o=t.target;for(let n of this.getMatches(t))(n.combination=="esc"||o.tagName!="INPUT"&&o.tagName!="SELECT"&&o.tagName!="TEXTAREA"&&!o.isContentEditable&&!o.hasAttribute("trap-bypass"))&&(n.callback(t),t.preventDefault(),t.stopPropagation())};this.getMatches=t=>{let o=Yi(t),n=t.type,i=n=="keyup"&&nn(o)?[o]:Ji(t);return(this.bindings[o]||[]).filter(r=>n==r.action&&(n=="keypress"&&!t.metaKey&&!t.ctrlKey||Qi(i,r.modifiers)))};t=t||document,t.addEventListener("keypress",o=>this.handleKeyEvent(o)),t.addEventListener("keydown",o=>this.handleKeyEvent(o)),t.addEventListener("keyup",o=>this.handleKeyEvent(o))}};var rn='<div class="spinner" aria-label="loading"><svg viewBox="-2 -2 54 54"><g mask="url(#mask)" fill="none"><path id="a" stroke-width="3.779" d="m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"/><path id="b" stroke-width="4.157" d="m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"/><path id="c" stroke-width="4.535" d="m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"/></g></svg></div>';var ln=e=>{var t;return(t=document.querySelector(".crosstable"))==null?void 0:t.contains(e)},dn=(e,t)=>o=>{let n=(o.dataset.href||o.href).replace(/\?.+$/,"");t&&t(n),K(n+"/mini").then(i=>{let r=document.getElementById(e);r.innerHTML=i,site.contentLoaded(r)})},Ht=(e,t)=>`<a class="btn-rack__btn" href="${e}" data-icon="${t}"></a>`,Nt=(e,t)=>$(e).removeClass("ulpt").powerTip({preRender:dn("powerTip",o=>{let n=o.slice(3),i=e.dataset.name||$(e).html();$("#powerTip").html('<div class="upt__info"><div class="upt__info__top"><span class="user-link offline">'+i+'</span></div></div><div class="upt__actions btn-rack">'+Ht("/@/"+n+"/tv",Re)+Ht("/inbox/new?user="+n,Co)+Ht("/?user="+n+"#friend",To)+'<a class="btn-rack__btn relation-button" disabled></a></div>')}),placement:t||e.getAttribute("data-pt-pos")||(ln(e)?"n":"s")}),Rt=e=>$(e).removeClass("glpt").powerTip({preRender:dn("miniGame",()=>site.spinnerHtml),placement:ln(e)?"n":"w",popupId:"miniGame"});function sn(e,t,o){"ontouchstart"in window||(o(e),$.powerTip.show(e,t))}function an(e,t,o){oe(()=>Array.prototype.forEach.call(e.querySelectorAll(t),n=>o(n)),800)}var nr={watchMouse(){document.body.addEventListener("mouseover",e=>{let t=e.target;t.classList.contains("ulpt")?sn(t,e,Nt):t.classList.contains("glpt")&&sn(t,e,Rt)})},manualGameIn(e){an(e,".glpt",Rt)},manualGame:Rt,manualUser:Nt,manualUserIn(e){an(e,".ulpt",Nt)}},Je=nr,f={scoped:{},currentX:0,currentY:0,previousX:0,previousY:0,mouseTrackingActive:!1,delayInProgress:!1,windowWidth:0,windowHeight:0,scrollTop:0,scrollLeft:0},ue={none:0,top:1,bottom:2,left:4,right:8};$.fn.powerTip=function(e){if(!this.length)return this;let t=Object.assign({},ir,e),o=new qt(t);return ar(),this.each((n,i)=>{let r=$(i);"displayController"in i&&$.powerTip.destroy(r),i.displayController=new Wt(r,t,o)}),this.on({mouseenter:function(n){$.powerTip.show(this,n)},mouseleave:function(){$.powerTip.hide(this)}}),this};var ir={popupId:"powerTip",intentSensitivity:7,intentPollInterval:150,closeDelay:150,placement:"n",smartPlacement:!0,defaultSize:[260,120],offset:10},rr={n:["n","ne","nw","s","se","sw","e","w"],e:["e","ne","se","w","nw","sw","n","s"],s:["s","se","sw","n","ne","nw","e","w"],w:["w","nw","sw","e","ne","se","n","s"],nw:["nw","w","sw","n","s","se","nw","e"],ne:["ne","e","se","n","s","sw","ne","w"],sw:["sw","w","nw","s","n","ne","sw","e"],se:["se","e","ne","s","n","nw","se","w"]};$.powerTip={show(e,t){return t?(un(t),f.previousX=t.pageX,f.previousY=t.pageY,e.displayController.show()):e.displayController.show(!0,!0),e},reposition(e){return e.displayController.resetPosition(),e},hide(e,t){return e.displayController.hide(t),e},destroy(e){return $(e).off(".powertip").each(()=>{delete this.displayController,delete this.hasActiveHover,delete this.forcedOpen}),e}};$.powerTip.showTip=$.powerTip.show;$.powerTip.closeTip=$.powerTip.hide;function Bt(){return{left:"auto",top:"auto",right:"auto",bottom:"auto"}}var Wt=class{constructor(t,o,n){this.element=t;this.options=o;this.tipController=n;this.scoped={};this.el=$as(t),this.scoped=f.scoped[o.popupId]}show(t,o){this.cancel(),this.el.hasActiveHover||(t?(o&&(this.el.forcedOpen=!0),this.tipController.showTip(this.element)):(this.scoped.tipOpenImminent=!0,this.hoverTimer=setTimeout(()=>{this.hoverTimer=void 0,this.checkForIntent()},this.options.intentPollInterval)))}hide(t){this.cancel(),this.scoped.tipOpenImminent=!1,this.el.hasActiveHover&&(this.el.forcedOpen=!1,t?this.tipController.hideTip(this.element):(this.scoped.delayInProgress=!0,this.hoverTimer=setTimeout(()=>{this.hoverTimer=void 0,this.tipController.hideTip(this.element),f.delayInProgress=!1},this.options.closeDelay)))}checkForIntent(){var i;let t=Math.abs(f.previousX-f.currentX),o=Math.abs(f.previousY-f.currentY);t+o<((i=this.options.intentSensitivity)!=null?i:0)?this.tipController.showTip(this.element):(f.previousX=f.currentX,f.previousY=f.currentY,this.show())}cancel(){clearTimeout(this.hoverTimer),this.scoped.delayInProgress=!1}resetPosition(){this.tipController.resetPosition(this.element)}};function sr(){return{compute(t,o,n,i,r){let s=o.split("-")[0],a=Bt(),c=e(t,s);switch(o){case"n":a.left=c.left-n/2,a.bottom=f.windowHeight-c.top+r;break;case"e":a.left=c.left+r,a.top=c.top-i/2;break;case"s":a.left=c.left-n/2,a.top=c.top+r;break;case"w":a.top=c.top-i/2,a.right=f.windowWidth-c.left+r;break;case"nw":a.bottom=f.windowHeight-c.top+r,a.right=f.windowWidth-c.left-20;break;case"ne":a.left=c.left-20,a.bottom=f.windowHeight-c.top+r;break;case"sw":a.top=c.top+r,a.right=f.windowWidth-c.left-20;break;case"se":a.left=c.left-20,a.top=c.top+r;break}return a}};function e(t,o){let n=t.offset(),i=t.outerWidth(),r=t.outerHeight(),s=0,a=0;switch(o){case"n":s=n.left+i/2,a=n.top;break;case"e":s=n.left+i,a=n.top+r/2;break;case"s":s=n.left+i/2,a=n.top+r;break;case"w":s=n.left,a=n.top+r/2;break;case"nw":s=n.left,a=n.top;break;case"ne":s=n.left+i,a=n.top;break;case"sw":s=n.left,a=n.top+r;break;case"se":s=n.left+i,a=n.top+r;break}return{left:s,top:a}}}var qt=class{constructor(t){this.options=t;this.placementCalculator=sr();var o,n,i;if(this.tipElement=$("#"+t.popupId),this.scoped=(i=(o=f.scoped)[n=t.popupId])!=null?i:o[n]={},this.tipElement.length===0){let r=document.createElement("div");r.id=t.popupId,this.tipElement=$(r),$("body").append(this.tipElement)}this.tipElement.on({mouseenter:()=>{this.scoped.activeHover&&this.scoped.activeHover[0].displayController.cancel()},mouseleave:()=>{this.scoped.activeHover&&this.scoped.activeHover[0].displayController.hide()}})}showTip(t){$as(t).hasActiveHover=!0,this.doShowTip(t)}doShowTip(t){if($as(t).hasActiveHover){if(this.scoped.isTipOpen){this.scoped.isClosing||this.hideTip(this.scoped.activeHover),setTimeout(()=>{this.doShowTip(t)},100);return}this.tipElement.empty(),this.options.preRender&&this.options.preRender($as(t)),this.scoped.activeHover=t,this.scoped.isTipOpen=!0,this.resetPosition(t),this.tipElement.show(),this.scoped.desyncTimeout||(this.scoped.desyncTimeout=setInterval(()=>this.closeDesyncedTip(),500))}}hideTip(t){this.scoped.isClosing=!0,this.scoped.activeHover=null,this.scoped.isTipOpen=!1,this.scoped.desyncTimeout=clearInterval(this.scoped.desyncTimeout),$as(t).hasActiveHover=!1,$as(t).forcedOpen=!1,this.tipElement.hide();let o=Bt();this.scoped.isClosing=!1,this.tipElement.removeClass(),o.top=f.currentY+this.options.offset,o.left=f.currentX+this.options.offset,this.tipElement.css(o)}resetPosition(t){let o;this.options.smartPlacement?(o=rr[this.options.placement],$.each(o,(n,i)=>{if(cr(this.placeTooltip(t,i),this.tipElement.outerWidth()||this.options.defaultSize[0],this.tipElement.outerHeight()||this.options.defaultSize[1])===ue.none)return!1})):this.placeTooltip(t,this.options.placement)}placeTooltip(t,o){let n=0,i,r,s=Bt();s.top=0,s.left=0,this.tipElement.css(s);do i=this.tipElement.outerWidth()||this.options.defaultSize[0],r=this.tipElement.outerHeight()||this.options.defaultSize[1],s=this.placementCalculator.compute(t,o,i,r,this.options.offset),this.tipElement.css(s);while(++n<=5&&(i!==this.tipElement.outerWidth()||r!==this.tipElement.outerHeight()));return s}closeDesyncedTip(){let t=!1;this.scoped.isTipOpen&&!this.scoped.isClosing&&!this.scoped.delayInProgress&&(this.scoped.activeHover[0].hasActiveHover===!1||this.scoped.activeHover.is(":disabled")?t=!0:!cn(this.scoped.activeHover)&&!this.scoped.activeHover.is(":focus")&&!this.scoped.activeHover[0].forcedOpen&&(cn(this.tipElement)||(t=!0)),t&&this.hideTip(this.scoped.activeHover))}};function ar(){if(!f.mouseTrackingActive){f.mouseTrackingActive=!0;let e=$(window);f.scrollLeft=window.scrollX,f.scrollTop=window.scrollY,f.windowWidth=e.width(),f.windowHeight=e.height(),document.addEventListener("mousemove",un),window.addEventListener("resize",function(){f.windowWidth=e.width(),f.windowHeight=e.height()},{passive:!0}),window.addEventListener("scroll",function(){let t=window.scrollX,o=window.scrollY;t!==f.scrollLeft&&(f.currentX+=t-f.scrollLeft,f.scrollLeft=t),o!==f.scrollTop&&(f.currentY+=o-f.scrollTop,f.scrollTop=o)},{passive:!0})}}function un(e){f.currentX=e.pageX,f.currentY=e.pageY}function cn(e){let t=e.offset();return f.currentX>=t.left&&f.currentX<=t.left+e.width()&&f.currentY>=t.top&&f.currentY<=t.top+e.height()}function cr(e,t,o){let n=f.scrollTop,i=f.scrollLeft,r=n+f.windowHeight,s=i+f.windowWidth,a=ue.none;return(e.top<n||Math.abs(Number(e.bottom)-f.windowHeight)-o<n)&&(a|=ue.top),(Number(e.top)+o>r||Math.abs(Number(e.bottom)-f.windowHeight)>r)&&(a|=ue.bottom),(e.left<i||Number(e.right)+t>s)&&(a|=ue.left),(Number(e.left)+t>s||e.right<i)&&(a|=ue.right),a}var jt={};gt(jt,{baseUrl:()=>fn,embedChessground:()=>fr,flairSrc:()=>dr,hopscotch:()=>pr,jsModule:()=>Ze,loadCss:()=>Ut,loadCssPath:()=>pe,loadEsm:()=>ne,loadIife:()=>mn,url:()=>U,userComplete:()=>ur});var pn=()=>window.matchMedia("(prefers-color-scheme: light)").media!=="not all";var fn=I(()=>document.body.getAttribute("data-asset-url")||""),lr=I(()=>document.body.getAttribute("data-asset-version")),U=(e,t={})=>{t=t||{};let o=t.sameDomain?"":fn(),n=t.version||lr();return`${o}/assets${t.noVersion?"":"/_"+n}/${e}`},dr=e=>U(`flair/img/${e}.webp`,{version:"_____2"}),zt=new Map,Ut=(e,t)=>{if(!zt.has(e)){let o=document.createElement("link");o.rel="stylesheet",o.href=U(site.debug?`${e}?_=${Date.now()}`:e),t&&(o.media=`(prefers-color-scheme: ${t})`),zt.set(e,new Promise(n=>{o.onload=()=>n()})),document.head.append(o)}return zt.get(e)},pe=async e=>{let t=document.body.dataset.theme,o=(n,i)=>Ut(`css/${e}.${document.dir||"ltr"}.${n}.${document.body.dataset.dev?"dev":"min"}.css`,i);t==="system"?pn()?await Promise.all([o("dark","dark"),o("light","light")]):await o("dark"):await o(t)},Ze=e=>`compiled/${e}${document.body.dataset.dev?"":".min"}.js`,Kt=new Map,mn=(e,t={})=>(Kt.has(e)||Kt.set(e,Bo(U(e,t))),Kt.get(e));async function ne(e,t){let o=await import(U(Ze(e),t==null?void 0:t.url));return o.initModule?o.initModule(t==null?void 0:t.init):o.default(t==null?void 0:t.init)}var ur=async e=>{let[t]=await Promise.all([ne("userComplete",{init:e}),pe("complete")]);return t},pr=()=>Promise.all([Ut("npm/hopscotch/dist/css/hopscotch.min.css"),mn("npm/hopscotch/dist/js/hopscotch.min.js",{noVersion:!0})]);function fr(){return import(U("npm/chessground.min.js"))}async function et(e){let t=await mr(e);function o(i){return t.transaction(e.store,i).objectStore(e.store)}function n(i){return new Promise((r,s)=>{let a=i();a.onsuccess=c=>r(c.target.result),a.onerror=c=>s(c.target.result)})}return{list:()=>n(()=>o("readonly").getAllKeys()),get:i=>n(()=>o("readonly").get(i)),getMany:i=>n(()=>o("readonly").getAll(i)),put:(i,r)=>n(()=>o("readwrite").put(r,i)),count:i=>n(()=>o("readonly").count(i)),remove:i=>n(()=>o("readwrite").delete(i)),clear:()=>n(()=>o("readwrite").clear()),txn:i=>t.transaction(e.store,i)}}async function mr(e){let t=(e==null?void 0:e.db)||`${e.store}--db`;return new Promise((o,n)=>{var i;let r=window.indexedDB.open(t,(i=e==null?void 0:e.version)!==null&&i!==void 0?i:1);r.onsuccess=s=>o(s.target.result),r.onerror=s=>{var a;return n((a=s.target.error)!==null&&a!==void 0?a:"IndexedDB Unavailable")},r.onupgradeneeded=s=>{var a;let c=s.target.result,l=s.target.transaction,d=c.objectStoreNames.contains(e.store)?l.objectStore(e.store):c.createObjectStore(e.store);(a=e.upgrade)===null||a===void 0||a.call(e,s,d)}})}var hn={db:"log--db",store:"log",version:2,upgrade:(e,t)=>t==null?void 0:t.clear()},gn=100;function Vt(){let e,t,o=0,n=.001,i=new Promise(c=>t=c);et(hn).then(async c=>{var l;try{let d=await c.list(),p=parseInt((l=localStorage.getItem("log.window"))!=null?l:`${gn}`),g=p>=0&&p<=1e4?p:gn;d.length>g&&await c.remove(IDBKeyRange.upperBound(d[d.length-g],!0)),e=c}catch(d){console.error(d),c.clear()}t()}).catch(c=>{console.error(c),window.indexedDB.deleteDatabase(hn.db),t()});function r(c){return!c||typeof c=="string"?String(c):JSON.stringify(c)}let s=async(...c)=>{let l=`#${site.info.commit.substr(0,7)} - ${c.map(r).join(" ")}`,d=Date.now();console.log(...c),d===o?(d+=n,n+=.001):(n=.001,o=d),await i,await(e==null?void 0:e.put(d,l))};s.clear=async()=>{await i,await(e==null?void 0:e.clear()),o=0},s.get=async()=>{if(await i,!e)return"";let[c,l]=await Promise.all([e.list(),e.getMany()]);return c.map((d,p)=>`${new Date(d).toISOString().replace(/[TZ]/g," ")}${l[p]}`).join(`
`)};function a(){return window.location.href.replace(/^(https:\/\/)?lichess\.org\//,"/")}return window.addEventListener("error",async c=>{var d,p;let l=c.filename?` - (${c.filename}:${c.lineno}:${c.colno})`:"";s(`${a()} - ${c.message}${l}
${(p=(d=c.error)==null?void 0:d.stack)!=null?p:""}`.trim())}),window.addEventListener("unhandledrejection",async c=>{s(`${a()} - ${c.reason}`)}),s}var tt=Object.create(null),hr={on(e,t){(tt[e]=tt[e]||new Set).add(t)},off(e,t){var o;(o=tt[e])==null||o.delete(t)},emit(e,...t){for(let o of tt[e]||[])o.apply(null,t)}},w=hr;function Ee(e){return{insert:t=>e(t.elm)}}var bn=e=>e&&e!==!0||e==="",vn=e=>(Array.isArray(e)?e:[e]).filter(bn);function ie(e,t,o){return o?J(e,t,vn(o)):bn(t)?Array.isArray(t)||typeof t=="object"&&"sel"in t?J(e,vn(t)):J(e,t):J(e)}var $e=e=>{let t=vr();if(!e||!t)return t;let o=parseFloat(navigator.userAgent.slice(navigator.userAgent.indexOf("Version/")+8));return e!=null&&e.below&&(t=o<e.below),t&&(e!=null&&e.atLeast)&&(t=o>=e.atLeast),t};var Ft=()=>!br(),gr=()=>(navigator==null?void 0:navigator.maxTouchPoints)>2&&/iPad|Macintosh/.test(navigator.userAgent);var mc=I(()=>{let e=[];if(typeof WebAssembly=="object"&&typeof WebAssembly.validate=="function"&&WebAssembly.validate(Uint8Array.from([0,97,115,109,1,0,0,0]))&&(e.push("wasm"),wr())){e.push("sharedMem");let t=Uint8Array.from([0,97,115,109,1,0,0,0,1,12,2,96,2,123,123,1,123,96,1,123,1,123,3,3,2,0,1,7,9,2,1,97,0,0,1,98,0,1,10,19,2,9,0,32,0,32,1,253,186,1,11,7,0,32,0,253,253,1,11]);WebAssembly.validate(t)&&e.push("simd")}return Object.freeze(e)}),vr=I(()=>/iPhone|iPod/.test(navigator.userAgent)||gr()),br=I(()=>window.matchMedia("(hover: hover) and (pointer: fine)").matches);function wr(){if(typeof Atomics!="object"||typeof SharedArrayBuffer!="function")return!1;let e;try{if(e=new WebAssembly.Memory({shared:!0,initial:1,maximum:2}),!(e.buffer instanceof SharedArrayBuffer))return!1;window.postMessage(e.buffer,"*")}catch(t){return!1}return e.buffer instanceof SharedArrayBuffer}function yr(e){let t,o;return function(...n){let i=this,r=()=>{o=void 0,t=e.apply(i,n).finally(()=>{t=void 0,o&&o()})};t?o=r:r()}}function Gt(e,t){return yr(function(...o){return t.apply(this,o),new Promise(n=>setTimeout(n,e))})}var xr=[8,1,-8,-1],kr=[9,-9,7,-7],xc=xr.concat(kr);var Xt=e=>({P:"pawn",N:"knight",B:"bishop",R:"rook",Q:"queen",K:"king"})[e];var xn=new class{constructor(){this.ctx=yn();this.sounds=new Map;this.paths=new Map;this.theme=document.body.dataset.soundSet;this.speechStorage=D.boolean("speech.enabled");this.volumeStorage=D.make("sound-volume");this.baseUrl=U("sound",{version:"_____1"});this.primerEvents=["touchend","pointerup","pointerdown","mousedown","keydown"];this.primer=()=>{var e;return(e=this.ctx)==null?void 0:e.resume().then(()=>{setTimeout(()=>$("#warn-no-autoplay").removeClass("shown"),500);for(let t of this.primerEvents)window.removeEventListener(t,this.primer,{capture:!0})})};this.throttled=Gt(100,e=>this.play(e));this.setVolume=this.volumeStorage.set;this.getVolume=()=>{let e=parseFloat(this.volumeStorage.get()||"");return e>=0?e:.7};this.enabled=()=>this.theme!=="silent";this.speech=e=>(e!==void 0&&this.speechStorage.set(e),this.speechStorage.get());this.say=(e,t=!1,o=!1,n=!1)=>{try{if(t&&speechSynthesis.cancel(),!this.speech()&&!o)return!1;let i=new SpeechSynthesisUtterance(e);return i.volume=this.getVolume(),i.lang=n?document.documentElement.lang:"en-US",$e()||(i.onstart=r=>site.mic.pause(),i.onend=i.onerror=r=>site.mic.resume()),speechSynthesis.speak(i),!0}catch(i){return console.error(i),!1}};this.sayOrPlay=(e,t)=>this.say(t)||this.play(e);this.publish=()=>w.emit("sound_set",this.theme);this.changeSet=e=>{var t;$e()&&((t=this.ctx)==null||t.resume()),this.theme=e,this.publish()};this.set=()=>this.theme;this.primerEvents.forEach(e=>window.addEventListener(e,this.primer,{capture:!0}))}async load(e,t){var s;if(!this.ctx||(t?this.paths.set(e,t):t=(s=this.paths.get(e))!=null?s:this.resolvePath(e),!t))return;if(this.sounds.has(t))return this.sounds.get(t);let o=await fetch(`${t}.mp3`);if(!o.ok)throw new Error(`${t}.mp3 failed ${o.status}`);let n=await o.arrayBuffer(),i=await new Promise((a,c)=>{var l,d,p;((l=this.ctx)==null?void 0:l.decodeAudioData.length)===1?(d=this.ctx)==null||d.decodeAudioData(n).then(a).catch(c):(p=this.ctx)==null||p.decodeAudioData(n,a,c)}),r=new Yt(this.ctx,i);return this.sounds.set(t,r),r}resolvePath(e){if(!this.enabled())return;let t=this.theme;if(this.theme==="music"||this.speech()){if(["move","capture","check"].includes(e))return;t="standard"}return`${this.baseUrl}/${t}/${e[0].toUpperCase()+e.slice(1)}`}async play(e,t=1){if(!this.enabled())return;let o=await this.load(e);o&&await this.resumeWithTest()&&await o.play(this.getVolume()*t)}async move(e){var t,o,n,i;(e==null?void 0:e.filter)!=="music"&&this.theme!=="music"&&(e!=null&&e.name?this.throttled(e.name):((t=e==null?void 0:e.san)!=null&&t.includes("x")?this.throttled("capture"):this.throttled("move"),((o=e==null?void 0:e.san)!=null&&o.includes("#")||(n=e==null?void 0:e.san)!=null&&n.includes("+"))&&this.throttled("check"))),!((e==null?void 0:e.filter)==="game"||this.theme!=="music")&&((i=this.music)!=null||(this.music=await site.asset.loadEsm("soundMove")),this.music(e))}async countdown(e,t=500){if(this.enabled())try{for(;e>0;){let o=[new Promise(n=>setTimeout(n,t)),this.play(`countDown${e}`)];--e>0&&o.push(this.load(`countDown${e}`)),await Promise.all(o)}await this.play("genericNotify")}catch(o){console.error(o)}}playOnce(e){let t=()=>{let o=site.storage.make("just-played");Date.now()-parseInt(o.get(),10)<2e3||(o.set(""+Date.now()),this.play(e))};document.hasFocus()?t():setTimeout(t,10+Math.random()*500)}saySan(e,t){let o=e?e.includes("O-O-O#")?"long castle checkmate":e.includes("O-O-O+")?"long castle check":e.includes("O-O-O")?"long castle":e.includes("O-O#")?"short castle checkmate":e.includes("O-O+")?"short castle check":e.includes("O-O")?"short castle":e.split("").map(n=>{if(n=="x")return"takes";if(n=="+")return"check";if(n=="#")return"checkmate";if(n=="=")return"promotes to";if(n=="@")return"at";let i=n.charCodeAt(0);return i>48&&i<58?n:i>96&&i<105?n.toUpperCase():Xt(n)||n}).join(" ").replace(/^A /,"A, ").replace(/(\d) E (\d)/,"$1,E $2").replace(/C /,"c ").replace(/F /,"f ").replace(/(\d) H (\d)/,"$1H$2"):"Game start";this.say(o,t)}preloadBoardSounds(){for(let e of["move","capture","check","genericNotify"])this.load(e)}async resumeWithTest(){var e,t;if(!this.ctx)return!1;if(this.ctx.state!=="running"&&this.ctx.state!=="suspended"&&(this.ctx.state!=="closed"&&this.ctx.close(),this.ctx=yn(),this.ctx))for(let o of this.sounds.values())o.rewire(this.ctx);return((e=this.ctx)==null?void 0:e.state)==="suspended"&&await new Promise(o=>{var i;let n=setTimeout(()=>{$("#warn-no-autoplay").addClass("shown"),o()},400);(i=this.ctx)==null||i.resume().then(()=>{clearTimeout(n),o()}).catch(o)}),((t=this.ctx)==null?void 0:t.state)!=="running"?!1:($("#warn-no-autoplay").removeClass("shown"),!0)}},Yt=class{constructor(t,o){this.buffer=o;this.rewire(t)}play(t=1){this.node.gain.setValueAtTime(t,this.ctx.currentTime);let o=this.ctx.createBufferSource();return o.buffer=this.buffer,o.connect(this.node),new Promise(n=>{o.onended=()=>{o.disconnect(),n()},o.start(0)})}rewire(t){var o;(o=this.node)==null||o.disconnect(),this.ctx=t,this.node=this.ctx.createGain(),this.node.connect(this.ctx.destination)}};function yn(){return window.webkitAudioContext?new window.webkitAudioContext:typeof AudioContext!="undefined"?new AudioContext:void 0}var nt=class{constructor(){this.group=new Map,this.key=!1}set ctx(t){var o,n,i,r;this.context!==t&&((n=(o=this.selected)===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context),this.context=t,(r=(i=this.selected)===null||i===void 0?void 0:i.select)===null||r===void 0||r.call(i,this.context))}get selected(){return this.key?this.group.get(this.key):void 0}select(t){var o,n,i,r;if(this.key){if(this.key===t)return;(n=(o=this.selected)===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context)}this.key=t,(r=(i=this.selected)===null||i===void 0?void 0:i.select)===null||r===void 0||r.call(i,this.context)}get(t){return this.group.get(t)}set(t,o){let n=this.key===t;this.close(t),this.group.set(t,o),n&&this.select(t)}close(t){var o,n,i,r;if(t===void 0){for(let s of this.group.keys())this.close(s);return}t===this.key&&((n=(o=this.group.get(t))===null||o===void 0?void 0:o.deselect)===null||n===void 0||n.call(o,this.context),this.key=!1),(r=(i=this.group.get(t))===null||i===void 0?void 0:i.close)===null||r===void 0||r.call(i,this.context)}delete(t){this.close(t),t?this.group.delete(t):this.group.clear()}};var Tn="_____1";var Qt=class{constructor(t,o){this.listenerMap=new Map;this.words=t,this.partial=o}select(t){!(t!=null&&t.source)||!this.node||(t.source.connect(this.node),this.node.connect(t.ctx.destination))}deselect(){var t;(t=this.node)==null||t.disconnect()}close(){this.node=void 0}get listeners(){return[...this.listenerMap.values()].reverse()}},Cn=new class{constructor(){this.language="en";this.deviceId=Qo("voice.micDeviceId","default");this.recs=new nt;this.recId="default";this.voskStatus="";this.busy=!1;this.interrupt=!1;this.paused=0}get lang(){return this.language}setLang(e){e!==this.language&&(this.stop(),this.language=e)}async getMics(){return navigator.mediaDevices.enumerateDevices().then(e=>e.filter(t=>t.kind=="audioinput"&&t.label))}get micId(){return this.deviceId()}setMic(e){var o;let t=this.isListening;site.mic.stop(),this.deviceId(e),this.recs.close(),(o=this.audioCtx)==null||o.close(),this.audioCtx=void 0,t&&this.start()}setController(e){this.ctrl=e,this.ctrl("","status")}addListener(e,t={}){var n,i;let o=(n=t.recId)!=null?n:"default";if(!this.recs.group.has(o))throw`No recognizer for '${o}'`;this.recs.group.get(o).listenerMap.set((i=t.listenerId)!=null?i:o,e)}removeListener(e){this.recs.group.forEach(t=>t.listenerMap.delete(e))}initRecognizer(e,t={}){var i,r;if(e.length===0){this.recs.delete(t.recId);return}let o=(i=t.recId)!=null?i:"default",n=new Qt(e.slice(),t.partial===!0);(r=this.vosk)!=null&&r.isLoaded(this.lang)&&this.initKaldi(o,n),this.recs.set(o,n),t.listener&&this.addListener(t.listener,{recId:o,listenerId:t.listenerId})}setRecognizer(e="default"){var t;this.recId=e,this.isListening&&(this.recs.select(e),(t=this.vosk)==null||t.select(e))}async start(e=!0){var t;try{if(e&&this.isListening&&this.recId===this.recs.key)return;if(this.busy=!0,await this.initModel(),!this.busy)throw"";for(let[o,n]of this.recs.group)this.initKaldi(o,n);this.recs.select(e&&this.recId),(t=this.vosk)==null||t.select(e&&this.recId),this.micTrack.enabled=e,this.busy=!1,this.broadcast(e?"Listening...":"","start")}catch(o){if(o instanceof DOMException&&o.name==="NotAllowedError"?this.stop(["No permission","error"]):this.stop([o.toString(),"error"]),o!=="")throw o}}stop(e=["","stop"]){var t,o;this.micTrack&&(this.micTrack.enabled=!1),(t=this.download)==null||t.abort(),this.download=void 0,this.busy=!1,this.recs.select(!1),(o=this.vosk)==null||o.select(!1),this.broadcast(...e)}pause(){var e;++this.paused!==1||!((e=this.micTrack)!=null&&e.enabled)||(this.micTrack.enabled=!1)}resume(){this.paused=Math.min(this.paused-1,0),!(this.paused!==0||this.micTrack===void 0)&&(this.micTrack.enabled=!!this.recs.selected)}get isListening(){var e;return!!this.recs.selected&&!!((e=this.micTrack)!=null&&e.enabled||this.paused)&&!this.isBusy}get isBusy(){return this.busy}get status(){return this.voskStatus}stopPropagation(){this.interrupt=!0}get micTrack(){var e;return(e=this.mediaStream)==null?void 0:e.getAudioTracks()[0]}initKaldi(e,t){var o;t.node||(t.node=(o=this.vosk)==null?void 0:o.initRecognizer({recId:e,audioCtx:this.audioCtx,partial:t.partial,words:t.words,broadcast:this.broadcast.bind(this)}))}async initModel(){var n,i;if((n=this.vosk)!=null&&n.isLoaded(this.lang)){await this.initAudio();return}this.broadcast("Loading...");let e=site.asset.url(Pn.get(this.lang),{noVersion:!0}),t=this.downloadModel(`/vosk/${e.replace(/[\W]/g,"_")}`),o=this.initAudio();(i=this.vosk)!=null||(this.vosk=await site.asset.loadEsm("voice.vosk",{url:{version:Tn}})),await t,await this.vosk.initModel(e,this.lang),await o}async initAudio(){var e,t;if(((e=this.audioCtx)==null?void 0:e.state)==="suspended"&&await this.audioCtx.resume(),((t=this.audioCtx)==null?void 0:t.state)!=="running"){if(this.audioCtx)throw`Error ${this.audioCtx.state}`;this.mediaStream=await navigator.mediaDevices.getUserMedia({video:!1,audio:{sampleRate:{ideal:16e3},echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0},deviceId:this.micId}}),this.audioCtx=new AudioContext({sampleRate:this.mediaStream.getAudioTracks()[0].getSettings().sampleRate}),this.micSource=this.audioCtx.createMediaStreamSource(this.mediaStream),this.recs.ctx={vosk:this.vosk,source:this.micSource,ctx:this.audioCtx}}}broadcast(e,t="status",o=0){var n,i,r;(n=this.ctrl)==null||n.call(this,e,t),(t==="status"||t==="full")&&window.clearTimeout(this.broadcastTimeout),this.voskStatus=e;for(let s of(r=(i=this.recs.get(this.recId))==null?void 0:i.listeners)!=null?r:[])this.interrupt||s(e,t);this.interrupt=!1,this.broadcastTimeout=o>0?window.setTimeout(()=>this.broadcast(""),o):void 0}async downloadModel(e){let t=await et({db:"/vosk",store:"FILE_DATA",version:21,upgrade:(i,r)=>{r==null||r.createIndex("timestamp","timestamp",{unique:!1})}});if(await t.count(`${e}/extracted.ok`)>0)return;let o=await new Promise((i,r)=>{this.download=new XMLHttpRequest,this.download.open("GET",site.asset.url(Pn.get(this.lang),{noVersion:!0}),!0),this.download.responseType="arraybuffer",this.download.onerror=s=>r("Failed. See console"),this.download.onabort=s=>r("Aborted"),this.download.onprogress=s=>{this.broadcast(s.total<=0?"Downloading...":`Downloaded ${Math.round(100*s.loaded/s.total)}% of ${Math.round(s.total/1e6)}MB`)},this.download.onload=s=>{var a,c,l;((a=this.download)==null?void 0:a.status)!==200?r(`${(c=this.download)==null?void 0:c.status} Failed`):i((l=this.download)==null?void 0:l.response)},this.download.send()});this.broadcast("Extracting...");let n=new Date;await t.put(e,{timestamp:n,mode:16877}),await t.put(`${e}/downloaded.ok`,{contents:new Uint8Array([]),timestamp:n,mode:33206}),await t.remove(`${e}/downloaded.tar.gz`),await t.put(`${e}/downloaded.tar.gz`,{contents:new Uint8Array(o),timestamp:n,mode:33188}),t.txn("readwrite").objectStore("FILE_DATA").index("timestamp")}},Pn=new Map([["ca","lifat/vosk/model-ca-0.4.tar.gz"],["cn","lifat/vosk/model-cn-0.22.tar.gz"],["cs","lifat/vosk/model-cs-0.4.tar.gz"],["de","lifat/vosk/model-de-0.15.tar.gz"],["en","lifat/vosk/model-en-us-0.15.tar.gz"],["eo","lifat/vosk/model-eo-0.42.tar.gz"],["es","lifat/vosk/model-es-0.42.tar.gz"],["fa","lifat/vosk/model-fa-0.4.tar.gz"],["fr","lifat/vosk/model-fr-0.22.tar.gz"],["hi","lifat/vosk/model-hi-0.22.tar.gz"],["it","lifat/vosk/model-it-0.22.tar.gz"],["ja","lifat/vosk/model-ja-0.22.tar.gz"],["ko","lifat/vosk/model-ko-0.22.tar.gz"],["kz","lifat/vosk/model-kz-0.15.tar.gz"],["nl","lifat/vosk/model-nl-0.22.tar.gz"],["pl","lifat/vosk/model-pl-0.22.tar.gz"],["pt","lifat/vosk/model-pt-0.3.tar.gz"],["ru","lifat/vosk/model-ru-0.22.tar.gz"],["tr","lifat/vosk/model-tr-0.3.tar.gz"],["uk","lifat/vosk/model-uk-v3.tar.gz"],["uz","lifat/vosk/model-uz-0.22.tar.gz"],["vi","lifat/vosk/model-vi-0.4.tar.gz"]]);var Jt,Er=e=>e.includes(" ")?e.split(" ")[1]:e;function Ae(e){if(e.dataset.watched)return;e.dataset.watched="1";let t=$('<div class="chat__members__inner">').appendTo(e),o=$(`<div class="chat__members__number" data-icon="${So}" title="Spectators"></div>`).appendTo(t),n=$("<div>").appendTo(t);site.pubsub.on("socket.in.crowd",r=>i(r.watchers||r));let i=r=>{if(Jt=r,!r||!r.nb){e.classList.add("none");return}if(o.text(""+r.nb),r.users){let s=r.users.map(a=>a||"").join(";");if(n.data("prevUsers")!==s){n.data("prevUsers",s);let a=r.users.map(c=>c?`<a class="user-link ulpt" href="/@/${Er(c)}">${c}</a>`:"Anonymous");r.anons===1?a.push("Anonymous"):r.anons&&a.push(`Anonymous (${r.anons})`),n.html(a.join(", "))}}else n.html("");e.classList.remove("none")};Jt&&i(Jt)}var re=(e,t)=>Math.abs(e-t),$r=e=>(t,o,n,i)=>re(t,n)<2&&(e==="white"?i===o+1||o<=1&&i===o+2&&t===n:i===o-1||o>=6&&i===o-2&&t===n),Zt=(e,t,o,n)=>{let i=re(e,o),r=re(t,n);return i===1&&r===2||i===2&&r===1},Mn=(e,t,o,n)=>re(e,o)===re(t,n),Sn=(e,t,o,n)=>e===o||t===n,eo=(e,t,o,n)=>Mn(e,t,o,n)||Sn(e,t,o,n),Ar=(e,t,o)=>(n,i,r,s)=>re(n,r)<2&&re(i,s)<2||o&&i===s&&i===(e==="white"?0:7)&&(n===4&&(r===2&&t.includes(0)||r===6&&t.includes(7))||t.includes(r));function Lr(e,t){let o=t==="white"?"1":"8",n=[];for(let[i,r]of e)i[1]===o&&r.color===t&&r.role==="rook"&&n.push(h(i)[0]);return n}function to(e,t,o){let n=e.get(t);if(!n)return[];let i=h(t),r=n.role,s=r==="pawn"?$r(n.color):r==="knight"?Zt:r==="bishop"?Mn:r==="rook"?Sn:r==="queen"?eo:Ar(n.color,Lr(e,n.color),o);return ze.filter(a=>(i[0]!==a[0]||i[1]!==a[1])&&s(i[0],i[1],a[0],a[1])).map(P)}function M(e,...t){e&&setTimeout(()=>e(...t),1)}function En(e){e.orientation=ve(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function $n(e,t){for(let[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}function An(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[o,n]of e.pieces)n.role==="king"&&n.color===t&&(e.check=o)}function Dr(e,t,o,n){H(e),e.premovable.current=[t,o],M(e.premovable.events.set,t,o,n)}function O(e){e.premovable.current&&(e.premovable.current=void 0,M(e.premovable.events.unset))}function _r(e,t,o){O(e),e.predroppable.current={role:t,key:o},M(e.predroppable.events.set,t,o)}function H(e){let t=e.predroppable;t.current&&(t.current=void 0,M(t.events.unset))}function Ir(e,t,o){if(!e.autoCastle)return!1;let n=e.pieces.get(t);if(!n||n.role!=="king")return!1;let i=h(t),r=h(o);if(i[1]!==0&&i[1]!==7||i[1]!==r[1])return!1;i[0]===4&&!e.pieces.has(o)&&(r[0]===6?o=P([7,r[1]]):r[0]===2&&(o=P([0,r[1]])));let s=e.pieces.get(o);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(o),i[0]<r[0]?(e.pieces.set(P([6,r[1]]),n),e.pieces.set(P([5,r[1]]),s)):(e.pieces.set(P([2,r[1]]),n),e.pieces.set(P([3,r[1]]),s)),!0)}function oo(e,t,o){let n=e.pieces.get(t),i=e.pieces.get(o);if(t===o||!n)return!1;let r=i&&i.color!==n.color?i:void 0;return o===e.selected&&C(e),M(e.events.move,t,o,r),Ir(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,M(e.events.change),r||!0}function it(e,t,o,n){if(e.pieces.has(o))if(n)e.pieces.delete(o);else return!1;return M(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,M(e.events.change),e.movable.dests=void 0,e.turnColor=ve(e.turnColor),!0}function Ln(e,t,o){let n=oo(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=ve(e.turnColor),e.animation.current=void 0),n}function no(e,t,o){if(st(e,t,o)){let n=Ln(e,t,o);if(n){let i=e.hold.stop();C(e);let r={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return n!==!0&&(r.captured=n),M(e.movable.events.after,t,o,r),!0}}else if(Hr(e,t,o))return Dr(e,t,o,{ctrlKey:e.stats.ctrlKey}),C(e),!0;return C(e),!1}function rt(e,t,o,n){let i=e.pieces.get(t);i&&(Or(e,t,o)||n)?(e.pieces.delete(t),it(e,i,o,n),M(e.movable.events.afterNewPiece,i.role,o,{premove:!1,predrop:!1})):i&&Nr(e,t,o)?_r(e,i.role,o):(O(e),H(e)),e.pieces.delete(t),C(e)}function Le(e,t,o){if(M(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){C(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==t&&no(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Dn(e,t)||ro(e,t))&&(io(e,t),e.hold.start())}function io(e,t){e.selected=t,ro(e,t)?e.premovable.customDests||(e.premovable.dests=to(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function C(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Dn(e,t){let o=e.pieces.get(t);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}var st=(e,t,o)=>{var n,i;return t!==o&&Dn(e,t)&&(e.movable.free||!!(!((i=(n=e.movable.dests)===null||n===void 0?void 0:n.get(t))===null||i===void 0)&&i.includes(o)))};function Or(e,t,o){let n=e.pieces.get(t);return!!n&&(t===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function ro(e,t){let o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function Hr(e,t,o){var n,i;let r=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(t))!==null&&i!==void 0?i:to(e.pieces,t,e.premovable.castle);return t!==o&&ro(e,t)&&r.includes(o)}function Nr(e,t,o){let n=e.pieces.get(t),i=e.pieces.get(o);return!!n&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function _n(e,t){let o=e.pieces.get(t);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function In(e){let t=e.premovable.current;if(!t)return!1;let o=t[0],n=t[1],i=!1;if(st(e,o,n)){let r=Ln(e,o,n);if(r){let s={premove:!0};r!==!0&&(s.captured=r),M(e.movable.events.after,o,n,s),i=!0}}return O(e),i}function On(e,t){let o=e.predroppable.current,n=!1;if(!o)return!1;if(t(o)){let i={role:o.role,color:e.movable.color};it(e,i,o.key)&&(M(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0)}return H(e),n}function De(e){O(e),H(e),C(e)}function so(e){e.movable.color=e.movable.dests=e.animation.current=void 0,De(e)}function N(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let i=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(i=7-i),n>=0&&n<8&&i>=0&&i<8?P([n,i]):void 0}function Hn(e,t,o,n){let i=h(e),r=ze.filter(l=>eo(i[0],i[1],l[0],l[1])||Zt(i[0],i[1],l[0],l[1])),a=r.map(l=>Ue(P(l),o,n)).map(l=>Z(t,l)),[,c]=a.reduce((l,d,p)=>l[0]<d?l:[d,p],[a[0],0]);return P(r[c])}var x=e=>e.orientation==="white";var co="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Rr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Br={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function at(e){e==="start"&&(e=co);let t=new Map,o=7,n=0;for(let i of e)switch(i){case" ":case"[":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{let r=t.get(P([n-1,o]));r&&(r.promoted=!0);break}default:{let r=i.charCodeAt(0);if(r<57)n+=r-48;else{let s=i.toLowerCase();t.set(P([n,o]),{role:Rr[s],color:i===s?"black":"white"}),++n}}}return t}function Nn(e){return Do.map(t=>ce.map(o=>{let n=e.get(o+t);if(n){let i=Br[n.role];return n.color==="white"&&(i=i.toUpperCase()),n.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function lo(e,t){t.animation&&(uo(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function ct(e,t){var o,n,i;if(!((o=t.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((n=t.drawable)===null||n===void 0)&&n.autoShapes&&(e.drawable.autoShapes=[]),uo(e,t),t.fen&&(e.pieces=at(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&An(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&io(e,e.selected),lo(e,t),!e.movable.rookCastle&&e.movable.dests){let r=e.movable.color==="white"?"1":"8",s="e"+r,a=e.movable.dests.get(s),c=e.pieces.get(s);if(!a||!c||c.role!=="king")return;e.movable.dests.set(s,a.filter(l=>!(l==="a"+r&&a.includes("c"+r))&&!(l==="h"+r&&a.includes("g"+r))))}}function uo(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&Rn(e[o])&&Rn(t[o])?uo(e[o],t[o]):e[o]=t[o])}function Rn(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var X=(e,t)=>t.animation.enabled?Kr(e,t):Y(e,t);function Y(e,t){let o=e(t);return t.dom.redraw(),o}var po=(e,t)=>({key:e,pos:h(e),piece:t}),qr=(e,t)=>t.sort((o,n)=>Z(e.pos,o.pos)-Z(e.pos,n.pos))[0];function zr(e,t){let o=new Map,n=[],i=new Map,r=[],s=[],a=new Map,c,l,d;for(let[p,g]of e)a.set(p,po(p,g));for(let p of qe)c=t.pieces.get(p),l=a.get(p),c?l?be(c,l.piece)||(r.push(l),s.push(po(p,c))):s.push(po(p,c)):l&&r.push(l);for(let p of s)l=qr(p,r.filter(g=>be(p.piece,g.piece))),l&&(d=[l.pos[0]-p.pos[0],l.pos[1]-p.pos[1]],o.set(p.key,d.concat(d)),n.push(l.key));for(let p of r)n.includes(p.key)||i.set(p.key,p.piece);return{anims:o,fadings:i}}function Bn(e,t){let o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}let n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{let i=Ur(n);for(let r of o.plan.anims.values())r[2]=r[0]*i,r[3]=r[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((r=performance.now())=>Bn(e,r))}}function Kr(e,t){let o=new Map(t.pieces),n=e(t),i=zr(o,t);if(i.anims.size||i.fadings.size){let r=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},r||Bn(t,performance.now())}else t.dom.redraw();return n}var Ur=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var jr=["green","red","blue","yellow"];function Wn(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?C(e):De(e);let o=z(t),n=N(o,x(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:Vr(t),snapToValidMove:e.drawable.defaultSnapToValidMove},qn(e))}function qn(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let o=N(t.pos,x(e),e.dom.bounds());o||(t.snapToValidMove=!1);let n=t.snapToValidMove?Hn(t.orig,t.pos,x(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),qn(e)}})}function zn(e,t){e.drawable.current&&(e.drawable.current.pos=z(t))}function Kn(e){let t=e.drawable.current;t&&(t.mouseSq&&Fr(e.drawable,t),fo(e))}function fo(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Un(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),jn(e.drawable))}function Vr(e){var t;let o=(e.shiftKey||e.ctrlKey)&&Ke(e),n=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return jr[(o?1:0)+(n?2:0)]}function Fr(e,t){let o=i=>i.orig===t.orig&&i.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter(i=>!o(i))),(!n||n.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),jn(e)}function jn(e){e.onChange&&e.onChange(e.shapes)}function Vn(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let o=e.dom.bounds(),n=z(t),i=N(n,x(e),o);if(!i)return;let r=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!r||r.color!==e.turnColor)&&Un(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||r||s||Xr(e,n)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&st(e,e.selected,i)?X(p=>Le(p,i),e):Le(e,i);let l=e.selected===i,d=Qn(e,i);if(r&&d&&l&&_n(e,i)){e.draggable.current={orig:i,piece:r,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:d,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},d.cgDragging=!0,d.classList.add("dragging");let p=e.dom.elements.ghost;p&&(p.className=`ghost ${r.color} ${r.role}`,A(p,ee(o)(h(i),x(e))),we(p,!0)),mo(e)}else a&&O(e),c&&H(e);e.dom.redraw()}function Xr(e,t){let o=x(e),n=e.dom.bounds(),i=Math.pow(n.width/8,2);for(let r of e.pieces.keys()){let s=Ue(r,o,n);if(Z(s,t)<=i)return!0}return!1}function Fn(e,t,o,n){let i="a0";e.pieces.set(i,t),e.dom.redraw();let r=z(o);e.draggable.current={orig:i,piece:t,origPos:r,pos:r,started:!0,element:()=>Qn(e,i),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},mo(e)}function mo(e){requestAnimationFrame(()=>{var t;let o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);let n=e.pieces.get(o.orig);if(!n||!be(n,o.piece))se(e);else if(!o.started&&Z(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let r=o.element();if(!r)return;r.cgDragging=!0,r.classList.add("dragging"),o.element=r}let i=e.dom.bounds();A(o.element,[o.pos[0]-i.left-i.width/16,o.pos[1]-i.top-i.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==N(o.pos,x(e),i))}mo(e)})}function Gn(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=z(t))}function Xn(e,t){let o=e.draggable.current;if(!o)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&o.originTarget!==t.target&&!o.newPiece){e.draggable.current=void 0;return}O(e),H(e);let n=z(t)||o.pos,i=N(n,x(e),e.dom.bounds());i&&o.started&&o.orig!==i?o.newPiece?rt(e,o.orig,i,o.force):(e.stats.ctrlKey=t.ctrlKey,no(e,o.orig,i)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(o.orig),M(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===i||!i)?C(e):e.selectable.enabled||C(e),Yn(e),e.draggable.current=void 0,e.dom.redraw()}function se(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,C(e),Yn(e),e.dom.redraw())}function Yn(e){let t=e.dom.elements;t.ghost&&we(t.ghost,!1)}function Qn(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}function Zn(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Jn(e,2),setTimeout(()=>Jn(e,void 0),120)},120)}function Jn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function ei(e,t){function o(){En(e),t()}return{set(n){n.orientation&&n.orientation!==e.orientation&&o(),lo(e,n),(n.fen?X:Y)(i=>ct(i,n),e)},state:e,getFen:()=>Nn(e.pieces),toggleOrientation:o,setPieces(n){X(i=>$n(i,n),e)},selectSquare(n,i){n?X(r=>Le(r,n,i),e):e.selected&&(C(e),e.dom.redraw())},move(n,i){X(r=>oo(r,n,i),e)},newPiece(n,i){X(r=>it(r,n,i),e)},playPremove(){if(e.premovable.current){if(X(In,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){let i=On(e,n);return e.dom.redraw(),i}return!1},cancelPremove(){Y(O,e)},cancelPredrop(){Y(H,e)},cancelMove(){Y(n=>{De(n),se(n)},e)},stop(){Y(n=>{so(n),se(n)},e)},explode(n){Zn(e,n)},setAutoShapes(n){Y(i=>i.drawable.autoShapes=n,e)},setShapes(n){Y(i=>i.drawable.shapes=n,e)},getKeyAtDomPos(n){return N(n,x(e),e.dom.bounds())},redrawAll:t,dragNewPiece(n,i,r){Fn(e,n,i,r)},destroy(){so(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function ti(){return{pieces:at(co),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Io()}}var oi={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function ri(){let e=k("defs"),t=T(k("filter"),{id:"cg-filter-blur"});return t.appendChild(T(k("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function si(e,t,o){var n;let i=e.drawable,r=i.current,s=r&&r.mouseSq?r:void 0,a=new Map,c=e.dom.bounds(),l=i.autoShapes.filter(b=>!b.piece);for(let b of i.shapes.concat(l).concat(s?[s]:[])){if(!b.dest)continue;let v=(n=a.get(b.dest))!==null&&n!==void 0?n:new Set,m=ut(dt(h(b.orig),e.orientation),c),R=ut(dt(h(b.dest),e.orientation),c);v.add(go(m,R)),a.set(b.dest,v)}let d=i.shapes.concat(l).map(b=>({shape:b,current:!1,hash:ni(b,ho(b.dest,a),!1,c)}));s&&d.push({shape:s,current:!0,hash:ni(s,ho(s.dest,a),!0,c)});let p=d.map(b=>b.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;let g=t.querySelector("defs");Qr(i,d,g),Jr(d,t.querySelector("g"),o.querySelector("g"),b=>ts(e,b,i.brushes,a,c))}function Qr(e,t,o){var n;let i=new Map,r;for(let c of t.filter(l=>l.shape.dest&&l.shape.brush))r=ai(e.brushes[c.shape.brush],c.shape.modifiers),!((n=c.shape.modifiers)===null||n===void 0)&&n.hilite&&i.set(lt(r).key,lt(r)),i.set(r.key,r);let s=new Set,a=o.firstElementChild;for(;a;)s.add(a.getAttribute("cgKey")),a=a.nextElementSibling;for(let[c,l]of i.entries())s.has(c)||o.appendChild(is(l))}function Jr(e,t,o,n){let i=new Map;for(let r of e)i.set(r.hash,!1);for(let r of[t,o]){let s=[],a=r.firstElementChild,c;for(;a;)c=a.getAttribute("cgHash"),i.has(c)?i.set(c,!0):s.push(a),a=a.nextElementSibling;for(let l of s)r.removeChild(l)}for(let r of e.filter(s=>!i.get(s.hash)))for(let s of n(r))s.isCustom?o.appendChild(s.el):t.appendChild(s.el)}function ni({orig:e,dest:t,brush:o,piece:n,modifiers:i,customSvg:r,label:s},a,c,l){var d,p;return[l.width,l.height,c,e,t,o,a&&"-",n&&Zr(n),i&&es(i),r&&`custom-${ii(r.html)},${(p=(d=r.center)===null||d===void 0?void 0:d[0])!==null&&p!==void 0?p:"o"}`,s&&`label-${ii(s.text)}`].filter(g=>g).join(",")}function Zr(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function es(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function ii(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return t.toString()}function ts(e,{shape:t,current:o,hash:n},i,r,s){var a,c;let l=ut(dt(h(t.orig),e.orientation),s),d=t.dest?ut(dt(h(t.dest),e.orientation),s):l,p=t.brush&&ai(i[t.brush],t.modifiers),g=r.get(t.dest),b=[];if(p){let v=T(k("g"),{cgHash:n});b.push({el:v}),l[0]!==d[0]||l[1]!==d[1]?v.appendChild(ns(t,p,l,d,o,ho(t.dest,r))):v.appendChild(os(i[t.brush],l,o,s))}if(t.label){let v=t.label;(a=v.fill)!==null&&a!==void 0||(v.fill=t.brush&&i[t.brush].color);let m=t.brush?void 0:"tr";b.push({el:rs(v,n,l,d,g,m),isCustom:!0})}if(t.customSvg){let v=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[m,R]=v==="label"?li(l,d,g).map(S=>S-.5):v==="dest"?d:l,_=T(k("g"),{transform:`translate(${m},${R})`,cgHash:n});_.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,b.push({el:_,isCustom:!0})}return b}function os(e,t,o,n){let i=ss(),r=(n.width+n.height)/(4*Math.max(n.width,n.height));return T(k("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:ci(e,o),cx:t[0],cy:t[1],r:r-i[1]/2})}function lt(e){return["#ffffff","#fff","white"].includes(e.color)?oi.hilitePrimary:oi.hiliteWhite}function ns(e,t,o,n,i,r){var s;function a(d){var p;let g=cs(r&&!i),b=n[0]-o[0],v=n[1]-o[1],m=Math.atan2(v,b),R=Math.cos(m)*g,_=Math.sin(m)*g;return T(k("line"),{stroke:d?lt(t).color:t.color,"stroke-width":as(t,i)+(d?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${d?lt(t).key:t.key})`,opacity:!((p=e.modifiers)===null||p===void 0)&&p.hilite?1:ci(t,i),x1:o[0],y1:o[1],x2:n[0]-R,y2:n[1]-_})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return a(!1);let c=k("g"),l=T(k("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(ls(o,n)),l.appendChild(a(!0)),c.appendChild(l),c.appendChild(a(!1)),c}function is(e){let t=T(k("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(T(k("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function rs(e,t,o,n,i,r){var s;let c=.4*.75**e.text.length,l=li(o,n,i),d=r==="tr"?.4:0,p=T(k("g"),{transform:`translate(${l[0]+d},${l[1]-d})`,cgHash:t});p.appendChild(T(k("circle"),{r:.4/2,"fill-opacity":r?1:.8,"stroke-opacity":r?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));let g=T(k("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return g.innerHTML=e.text,p.appendChild(g),p}function dt(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function ho(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function k(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function T(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function ai(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(o=>o).join("")}:e}function ss(){return[3/64,4/64]}function as(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function ci(e,t){return(e.opacity||1)*(t?.9:1)}function cs(e){return(e?20:10)/64}function ut(e,t){let o=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*n]}function ls(e,t){let o={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return T(k("rect"),{x:o.from[0],y:o.from[1],width:o.to[0]-o.from[0],height:o.to[1]-o.from[1],fill:"none",stroke:"none"})}function go(e,t,o=!0){let n=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return o?(Math.round(n*8/Math.PI)+16)%16:n}function ds(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((o,n)=>o+n*n,0))}function li(e,t,o){let n=ds(e,t),i=go(e,t,!1);if(o&&(n-=33/64,o.size>1)){n-=10/64;let r=go(e,t);(o.has((r+1)%16)||o.has((r+15)%16))&&r&1&&(n-=.4)}return[e[0]-Math.cos(i)*n,e[1]-Math.sin(i)*n].map(r=>r+.5)}function ui(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let c of Ao)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);let o=L("cg-container");e.appendChild(o);let n=L("cg-board");o.appendChild(n);let i,r,s;if(t.drawable.visible&&(i=T(k("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(ri()),i.appendChild(k("g")),r=T(k("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(k("g")),s=L("cg-auto-pieces"),o.appendChild(i),o.appendChild(r),o.appendChild(s)),t.coordinates){let c=t.orientation==="black"?" black":"",l=t.ranksPosition==="left"?" left":"";o.appendChild(di(he,"ranks"+c+l)),o.appendChild(di(ce,"files"+c))}let a;return t.draggable.enabled&&t.draggable.showGhost&&(a=L("piece","ghost"),we(a,!1),o.appendChild(a)),{board:n,container:o,wrap:e,ghost:a,svg:i,customSvg:r,autoPieces:s}}function di(e,t){let o=L("coords",t),n;for(let i of e)n=L("coord"),n.textContent=i,o.appendChild(n);return o}function pi(e,t){if(!e.dropmode.active)return;O(e),H(e);let o=e.dropmode.piece;if(o){e.pieces.set("a0",o);let n=z(t),i=n&&N(n,x(e),e.dom.bounds());i&&rt(e,"a0",i)}e.dom.redraw()}function mi(e,t){let o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;let n=ps(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1})}function hi(e,t){let o=[];if("ResizeObserver"in window||o.push(_e(document.body,"chessground.resize",t)),!e.viewOnly){let n=fi(e,Gn,zn),i=fi(e,Xn,Kn);for(let s of["touchmove","mousemove"])o.push(_e(document,s,n));for(let s of["touchend","mouseup"])o.push(_e(document,s,i));let r=()=>e.dom.bounds.clear();o.push(_e(document,"scroll",r,{capture:!0,passive:!0})),o.push(_e(window,"resize",r,{passive:!0}))}return()=>o.forEach(n=>n())}function _e(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}var ps=e=>t=>{e.draggable.current?se(e):e.drawable.current?fo(e):t.shiftKey||Ke(t)?e.drawable.enabled&&Wn(e,t):e.viewOnly||(e.dropmode.active?pi(e,t):Vn(e,t))},fi=(e,t,o)=>n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)};function vi(e){let t=x(e),o=ee(e.dom.bounds()),n=e.dom.elements.board,i=e.pieces,r=e.animation.current,s=r?r.plan.anims:new Map,a=r?r.plan.fadings:new Map,c=e.draggable.current,l=ms(e),d=new Set,p=new Set,g=new Map,b=new Map,v,m,R,_,S,fe,mt,B,ht,He;for(m=n.firstChild;m;){if(v=m.cgKey,wi(m))if(R=i.get(v),S=s.get(v),fe=a.get(v),_=m.cgPiece,m.cgDragging&&(!c||c.orig!==v)&&(m.classList.remove("dragging"),A(m,o(h(v),t)),m.cgDragging=!1),!fe&&m.cgFading&&(m.cgFading=!1,m.classList.remove("fading")),R){if(S&&m.cgAnimating&&_===Ie(R)){let y=h(v);y[0]+=S[2],y[1]+=S[3],m.classList.add("anim"),A(m,o(y,t))}else m.cgAnimating&&(m.cgAnimating=!1,m.classList.remove("anim"),A(m,o(h(v),t)),e.addPieceZIndex&&(m.style.zIndex=vo(h(v),t)));_===Ie(R)&&(!fe||!m.cgFading)?d.add(v):fe&&_===Ie(fe)?(m.classList.add("fading"),m.cgFading=!0):bo(g,_,m)}else bo(g,_,m);else if(yi(m)){let y=m.className;l.get(v)===y?p.add(v):bo(b,y,m)}m=m.nextSibling}for(let[y,me]of l)if(!p.has(y)){ht=b.get(me),He=ht&&ht.pop();let W=o(h(y),t);if(He)He.cgKey=y,A(He,W);else{let q=L("square",me);q.cgKey=y,A(q,W),n.insertBefore(q,n.firstChild)}}for(let[y,me]of i)if(S=s.get(y),!d.has(y))if(mt=g.get(Ie(me)),B=mt&&mt.pop(),B){B.cgKey=y,B.cgFading&&(B.classList.remove("fading"),B.cgFading=!1);let W=h(y);e.addPieceZIndex&&(B.style.zIndex=vo(W,t)),S&&(B.cgAnimating=!0,B.classList.add("anim"),W[0]+=S[2],W[1]+=S[3]),A(B,o(W,t))}else{let W=Ie(me),q=L("piece",W),Ne=h(y);q.cgPiece=W,q.cgKey=y,S&&(q.cgAnimating=!0,Ne[0]+=S[2],Ne[1]+=S[3]),A(q,o(Ne,t)),e.addPieceZIndex&&(q.style.zIndex=vo(Ne,t)),n.appendChild(q)}for(let y of g.values())gi(e,y);for(let y of b.values())gi(e,y)}function bi(e){let t=x(e),o=ee(e.dom.bounds()),n=e.dom.elements.board.firstChild;for(;n;)(wi(n)&&!n.cgAnimating||yi(n))&&A(n,o(h(n.cgKey),t)),n=n.nextSibling}function wo(e){var t,o;let n=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,r=n.height/n.width,s=Math.floor(n.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,a=s*r;i.style.width=s+"px",i.style.height=a+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",s+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",a+"px")}var wi=e=>e.tagName==="PIECE",yi=e=>e.tagName==="SQUARE";function gi(e,t){for(let o of t)e.dom.elements.board.removeChild(o)}function vo(e,t){let n=e[1];return`${t?10-n:3+n}`}var Ie=e=>`${e.color} ${e.role}`;function ms(e){var t,o,n;let i=new Map;if(e.lastMove&&e.highlight.lastMove)for(let a of e.lastMove)Q(i,a,"last-move");if(e.check&&e.highlight.check&&Q(i,e.check,"check"),e.selected&&(Q(i,e.selected,"selected"),e.movable.showDests)){let a=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(a)for(let l of a)Q(i,l,"move-dest"+(e.pieces.has(l)?" oc":""));let c=(n=(o=e.premovable.customDests)===null||o===void 0?void 0:o.get(e.selected))!==null&&n!==void 0?n:e.premovable.dests;if(c)for(let l of c)Q(i,l,"premove-dest"+(e.pieces.has(l)?" oc":""))}let r=e.premovable.current;if(r)for(let a of r)Q(i,a,"current-premove");else e.predroppable.current&&Q(i,e.predroppable.current.key,"current-premove");let s=e.exploding;if(s)for(let a of s.keys)Q(i,a,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((a,c)=>{Q(i,c,a)}),i}function Q(e,t,o){let n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function bo(e,t,o){let n=e.get(t);n?n.push(o):e.set(t,[o])}function xi(e,t,o){let n=new Map,i=[];for(let a of e)n.set(a.hash,!1);let r=t.firstElementChild,s;for(;r;)s=r.getAttribute("cgHash"),n.has(s)?n.set(s,!0):i.push(r),r=r.nextElementSibling;for(let a of i)t.removeChild(a);for(let a of e)n.get(a.hash)||t.appendChild(o(a))}function ki(e,t){let n=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:gs(i),current:!1}));xi(n,t,i=>hs(e,i,e.dom.bounds()))}function Ti(e){var t;let o=x(e),n=ee(e.dom.bounds()),i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)xt(i,n(h(i.cgKey),o),i.cgScale),i=i.nextSibling}function hs(e,{shape:t,hash:o},n){var i,r,s;let a=t.orig,c=(i=t.piece)===null||i===void 0?void 0:i.role,l=(r=t.piece)===null||r===void 0?void 0:r.color,d=(s=t.piece)===null||s===void 0?void 0:s.scale,p=L("piece",`${c} ${l}`);return p.setAttribute("cgHash",o),p.cgKey=a,p.cgScale=d,xt(p,ee(n)(h(a),x(e)),d),p}var gs=e=>{var t,o,n;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(o=e.piece)===null||o===void 0?void 0:o.color,(n=e.piece)===null||n===void 0?void 0:n.scale].join(",")};function Pi(e,t){let o=ti();ct(o,t||{});function n(){let i="dom"in o?o.dom.unbind:void 0,r=ui(e,o),s=_o(()=>r.board.getBoundingClientRect()),a=d=>{vi(l),r.autoPieces&&ki(l,r.autoPieces),!d&&r.svg&&si(l,r.svg,r.customSvg)},c=()=>{wo(l),bi(l),r.autoPieces&&Ti(l)},l=o;return l.dom={elements:r,bounds:s,redraw:bs(a),redrawNow:a,unbind:i},l.drawable.prevSvgHash="",wo(l),a(!1),mi(l,c),i||(l.dom.unbind=hi(l,c)),l.events.insert&&l.events.insert(r),l}return ei(n(),n)}function bs(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}var pt,yo=site.load.then(async()=>{var e;return window.addEventListener("resize",ys),window.HTMLDialogElement?!0:(pt=(e=await import(site.asset.url("npm/dialog-polyfill.esm.js")).catch(()=>{}))==null?void 0:e.default,pt!==void 0)});async function Ci(e){var s,a,c,l,d;let[t]=await Si(e),o=document.createElement("dialog");for(let[p,g]of Object.entries((a=(s=e.attrs)==null?void 0:s.dialog)!=null?a:{}))o.setAttribute(p,String(g));if(Ft()&&o.classList.add("touch-scroll"),e.parent&&(o.style.position="absolute"),!e.noCloseButton){let p=$as('<div class="close-button-anchor">');p.innerHTML=`<button class="close-button" aria-label="Close" data-icon="${vt}">`,o.appendChild(p)}let n=$as('<div class="dialog-content">');e.class&&n.classList.add(...e.class.split("/[. ]/").filter(p=>p));for(let[p,g]of Object.entries((l=(c=e.attrs)==null?void 0:c.view)!=null?l:{}))n.setAttribute(p,String(g));t&&(n.innerHTML=t);let i=$as('<div class="scrollable">');i.appendChild(n),o.appendChild(i),((d=e.parent)!=null?d:document.body).appendChild(o);let r=new ft(o,n,e);return e.show&&e.show==="modal"?r.showModal():e.show?r.show():r}function Mi(e){var n,i,r;let t=Si(e),o;return ie(`dialog${Ft()?".touch-scroll":""}`,{key:(n=e.class)!=null?n:"dialog",attrs:(i=e.attrs)==null?void 0:i.dialog,hook:Ee(s=>o=s)},[e.noCloseButton||ie("div.close-button-anchor",ie("button.close-button",{attrs:{"data-icon":vt,"aria-label":"Close"}})),ie("div.scrollable",ie("div.dialog-content"+(e.class?"."+e.class.split(/[. ]/).filter(s=>s).join("."):""),{attrs:(r=e.attrs)==null?void 0:r.view,hook:Ee(async s=>{let[a]=await t;!e.vnodes&&a&&(s.innerHTML=a);let c=new ft(o,s,e);e.onInsert?e.onInsert(c):c.showModal()})},e.vnodes))])}var ft=class{constructor(t,o,n){this.dialog=t;this.view=o;this.o=n;this.observer=new MutationObserver(t=>{for(let o of t)if(o.type==="childList"){for(let n of o.removedNodes)if(n===this.dialog){this.onRemove();return}}});this.show=()=>(this.returnValue="",this.dialog.show(),new Promise(t=>this.resolve=t));this.showModal=()=>{var t;return this.restore={focus:document.activeElement,overflow:document.body.style.overflow},(t=$(Ei,this.view)[1])==null||t.focus(),document.body.style.overflow="hidden",this.view.scrollTop=0,this.dialog.addEventListener("keydown",ws),this.returnValue="",this.dialog.showModal(),new Promise(o=>this.resolve=o)};this.close=t=>{this.dialog.close(this.returnValue||t||"ok")};this.onRemove=()=>{var t,o,n,i,r;this.observer.disconnect(),this.dialog.returnValue||(this.dialog.returnValue="cancel"),(t=this.restore)==null||t.focus.focus(),((o=this.restore)==null?void 0:o.overflow)!==void 0&&(document.body.style.overflow=this.restore.overflow),this.restore=void 0,(n=this.resolve)==null||n.call(this,this),(r=(i=this.o).onClose)==null||r.call(i,this),this.dialog.remove()};var s,a,c,l;pt&&pt.registerDialog(t);let i=Date.now(),r=()=>Date.now()-i>200&&this.close("cancel");this.observer.observe(document.body,{childList:!0,subtree:!0}),(s=o.parentElement)==null||s.style.setProperty("--vh",`${window.innerHeight}px`),o.addEventListener("click",d=>d.stopPropagation()),t.addEventListener("cancel",()=>!this.returnValue&&(this.returnValue="cancel")),t.addEventListener("close",this.onRemove),(a=t.querySelector(".close-button-anchor > .close-button"))==null||a.addEventListener("click",r),n.noClickAway||setTimeout(()=>t.addEventListener("click",r));for(let d of(c=n.append)!=null?c:[])(d.selector?o.querySelector(d.selector):o).appendChild(d.node);if(n.action)for(let d of Array.isArray(n.action)?n.action:[n.action])(l=o.querySelector(d.selector))==null||l.addEventListener("click",()=>{!d.action||typeof d.action=="string"?this.close(d.action):d.action(this,d)})}get open(){return this.dialog.open}get returnValue(){return this.dialog.returnValue}set returnValue(t){this.dialog.returnValue=t}};function Si(e){var o;let t=((o=e.css)!=null?o:[]).map(n=>"themed"in n?site.asset.loadCssPath(n.themed):"url"in n?site.asset.loadCss(n.url):Promise.resolve());return Promise.all([e.htmlUrl?K(e.htmlUrl):Promise.resolve(e.cash?$as($(e.cash).clone().removeClass("none")).outerHTML:e.htmlText),...t])}function ws(e){if(e.key==="Tab"){let t=$(Ei,e.currentTarget),o=$as(t.first()),n=$as(t.last()),i=document.activeElement;if(i===n&&!e.shiftKey)o.focus();else if(i===o&&e.shiftKey)n.focus();else return;e.preventDefault()}e.stopPropagation()}function ys(){$("dialog > div.scrollable").css("--vh",`${window.innerHeight}px`)}var Ei=["button","input","select","textarea"].map(e=>`${e}:not(:disabled)`).concat(["[href]",'[tabindex="0"]','[role="tab"]']).join(",");var $i=()=>{let e=window.site;e.debug=!1,e.info=u,e.StrongSocket=G,e.mousetrap=new Se(document),e.requestIdleCallback=oe,e.sri=V,e.storage=D,e.tempStorage=Xo,e.once=Ce,e.powertip=Je,e.clockWidget=ye,e.spinnerHtml=rn,e.asset=jt,e.idleTimer=Te,e.pubsub=w,e.unload=Mt,e.redirect=Fo,e.reload=Pe,e.watchers=Ae,e.escapeHtml=Ye,e.announce=Me,e.trans=Ct,e.sound=xn,e.mic=Cn,e.miniBoard=Fe,e.miniGame=Xe,e.timeago=on,e.dateFormat=Dt,e.contentLoaded=t=>w.emit("content-loaded",t),e.blindMode=document.body.classList.contains("blind-mode"),e.makeChat=t=>site.asset.loadEsm("chat",{init:{el:document.querySelector(".mchat"),...t}}),e.makeChessground=Pi,e.log=Vt(),e.dialog={ready:yo},yo.then(()=>{e.dialog.dom=Ci,e.dialog.snab=Mi})};var Oe=class{constructor(t){this.el=t;this.loaded=!1;this.receive=(t,o)=>{this.users.clear(),t.forEach(this.insert),o.playing.map(n=>this.users.get(n)).filter(ke).forEach(n=>n.playing=!0),o.patrons.map(n=>this.users.get(n)).filter(ke).forEach(n=>n.patron=!0),this.repaint()};this.repaint=()=>{this.loaded&&requestAnimationFrame(()=>{var o;let t=Array.from(this.users.keys()).sort();this.titleEl.innerHTML=E.pluralSame("nbFriendsOnline",t.length,this.loaded?`<strong>${t.length}</strong>`:"-"),(o=this.el.querySelector(".nobody"))==null||o.classList.toggle("none",!!t[0]),this.el.querySelector(".list").innerHTML=t.map(n=>this.renderFriend(this.users.get(n))).join("")})};this.renderFriend=t=>{let o=`<i class="line${t.patron?" patron":""}"></i>`,n=t.title?`<span class="utitle"${t.title==="BOT"?" data-bot":""}>${t.title}</span>&nbsp;`:"",i="/@/"+t.name,r=t.playing?`<a data-icon="${Re}" class="tv ulpt" data-pt-pos="nw" href="${i}/tv" data-href="${i}"></a>`:"";return`<div><a class="user-link ulpt" data-pt-pos="nw" href="${i}">${o}${n}${t.name}</a>${r}</div>`};this.enters=(t,o)=>{let n=this.insert(t);n.playing=o.playing,n.patron=o.patron,this.repaint()};this.leaves=t=>{this.users.delete(this.getId(t)),this.repaint()};this.playing=t=>{this.insert(t).playing=!0,this.repaint()};this.stopped_playing=t=>{this.insert(t).playing=!1,this.repaint()};this.insert=t=>{let o=this.getId(t);return this.users.has(o)||this.users.set(o,this.toFriend(t)),this.users.get(o)};this.getId=t=>t.toLowerCase().replace(/^\w+\s/,"");this.toFriend=t=>{let o=t.split(" ");return{id:o[o.length-1].toLowerCase(),name:o[o.length-1],title:o.length>1?o[0]:void 0,playing:!1,patron:!1}};this.titleEl=this.el.querySelector(".friend_box_title"),this.titleEl.addEventListener("click",()=>{var o;(o=this.el.querySelector(".content_wrap"))==null||o.classList.toggle("none"),this.loaded||(this.loaded=!0,w.emit("socket.send","following_onlines"))}),this.users=new Map,w.on("socket.in.following_onlines",this.receive),["enters","leaves","playing","stopped_playing"].forEach(o=>w.on("socket.in.following_"+o,this[o]))}};async function Ai(){var r;if(!("serviceWorker"in navigator&&"Notification"in window&&"PushManager"in window))return;let e=new URL(U(Ze("serviceWorker"),{sameDomain:!0}),self.location.href);e.searchParams.set("asset-url",document.body.getAttribute("data-asset-url")),document.body.getAttribute("data-dev")&&e.searchParams.set("dev","1");let t=document.body.getAttribute("data-dev")?"none":"all",o=await navigator.serviceWorker.register(e.href,{scope:"/",updateViaCache:t}),n=D.make("push-subscribed"),i=document.body.getAttribute("data-vapid");if(i&&Notification.permission=="granted"){let s=await o.pushManager.getSubscription(),a=parseInt(n.get()||"0",10)+432e5<Date.now(),c=Uint8Array.from(atob(i),l=>l.charCodeAt(0));if(!s||a){let l=await o.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:c});try{let d=await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});d.ok&&!d.redirected?n.set(""+Date.now()):l.unsubscribe()}catch(d){console.log("push subscribe failed",d.message),l==null||l.unsubscribe()}}}else n.remove(),(r=await o.pushManager.getSubscription())==null||r.unsubscribe()}function Li(){let e=`<div class="initiating">${site.spinnerHtml}</div>`,t=o=>{let n=document.querySelector(o),i=n&&window.getComputedStyle(n).display;return i&&i!="none"};"ontouchstart"in window&&!window.matchMedia("(max-width: 979px)").matches&&$("#topnav > section > a").removeAttr("href"),$("#tn-tg").on("change",o=>document.body.classList.toggle("masked",o.target.checked)),$("#top").on("click",".toggle",function(){let o=$(this).parent().toggleClass("shown");return o.siblings(".shown").removeClass("shown"),setTimeout(()=>{let n=i=>{var s;let r=i.target;!r.isConnected||(s=o[0])!=null&&s.contains(r)||(o.removeClass("shown"),$("html").off("click",n))};$("html").on("click",n)},10),!1});{let o,n=$("#challenge-toggle"),i=n.find("span");n.one("mouseover click",()=>r());let r=function(s){if(o)return;let a=$("#challenge-app").html(e);pe("challenge"),o=ne("challenge",{init:{el:a[0],data:s,show(){t("#challenge-app")||n.trigger("click")},setCount(c){let l=i.attr("title").replace(/\d+/,c.toString());i.data("count",c).attr("title",l).attr("aria-label",l)},pulse(){n.addClass("pulse")}}})};w.on("socket.in.challenges",async s=>{o?(await o).update(s):r(s)}),w.on("challenge-app.open",()=>n.trigger("click"))}{let o,n=$("#notify-toggle"),i=n.find("span"),r="#notify-app",s=a=>{if(o)return;let c=$("#notify-app").html(e);pe("notify"),o=ne("notify",{init:{el:c.empty()[0],data:a,isVisible:()=>t(r),updateUnread(l){let d=i.data("count")||0;l=="increment"&&(l=d+1),this.isVisible()&&(l=0);let p=i.attr("title").replace(/\d+/,l.toString());return i.data("count",l).attr("title",p).attr("aria-label",p),l&&l!=d},show(){t(r)||n.trigger("click")},setNotified(){site.socket.send("notified")},pulse(){n.addClass("pulse")}}})};n.one("mouseover click",()=>s()).on("click",()=>{"Notification"in window&&Notification.requestPermission(),setTimeout(async()=>{o&&t(r)&&(await o).onShow()},200)}),w.on("socket.in.notifications",async a=>{o?(await o).update(a):s(a)}),w.on("notify-app.set-read",async a=>{o?(await o).setMsgRead(a):s()})}{let o=I(()=>ne("dasher"));$("#top .dasher .toggle").one("mouseover click",function(){$(this).removeAttr("href"),pe("dasher"),o()})}{let o=$("#clinput");if(!o.length)return;let n=o.find("input"),i=!1,r=()=>{i||(i=!0,ne("cli",{init:{input:n[0]}}).catch(()=>i=!1))};n.on({blur(){n.val(""),$("body").removeClass("clinput")},focus(){r(),$("body").addClass("clinput")}}),o.find("a").on({mouseover:r,click(){$("body").hasClass("clinput")?n[0].blur():n[0].focus()}}),site.mousetrap.bind("/",()=>{n.val("/"),n[0].focus()}).bind("s",()=>n[0].focus())}}var Di=()=>document.body.dispatchEvent(new Event("chessground.resize"));window.$as=e=>(typeof e=="string"?$(e):e)[0];$i();site.load.then(()=>{$("#user_tag").removeAttr("href");let e=location.hash==="#blind",t=location.hash.startsWith("#debug");requestAnimationFrame(()=>{je(),Ge(),w.on("content-loaded",je),w.on("content-loaded",Ge),It(1e3),w.on("content-loaded",_t)}),oe(()=>{let o=document.getElementById("friend_box");o&&new Oe(o);let n=document.querySelector(".chat__members");if(n&&Ae(n),$(".subnav__inner").each(function(){Ro(this,".active",!0)}),$("#main-wrap").on("click",".autoselect",function(){this.select()}).on("click","button.copy",function(){let r=()=>$(this).attr("data-icon",xo);return $("#"+this.dataset.rel).each(function(){try{navigator.clipboard.writeText(this.value).then(r)}catch(s){console.error(s)}}),!1}),$("body").on("click","a.relation-button",function(){let r=$(this).addClass("processing").css("opacity",.3);return K(this.href,{method:"post"}).then(s=>{s.includes("relation-actions")?r.parent().replaceWith(s):r.replaceWith(s)}),!1}),$(".mselect .button").on("click",function(){let r=$(this).parent();r.toggleClass("shown"),oe(()=>{let s=a=>{r[0].contains(a.target)||(r.removeClass("shown"),$("html").off("click",s))};$("html").on("click",s)},200)}),Je.watchMouse(),setTimeout(()=>{site.socket||(site.socket=new G("/socket/v5",!1))},300),Li(),window.addEventListener("resize",Di),$(".user-autocomplete").each(function(){let r=!!this.autofocus,s=()=>site.asset.userComplete({input:this,friend:!!this.dataset.friend,tag:this.dataset.tag,focus:r});r?s():$(this).one("focus",s)}),$("input.confirm, button.confirm").on("click",function(){return confirm(this.title||"Confirm this action?")}),$("#main-wrap").on("click","a.bookmark",function(){let r=$(this).toggleClass("bookmarked");K(this.href,{method:"post"});let s=(parseInt(r.text(),10)||0)+(r.hasClass("bookmarked")?1:-1);return r.find("span").html(""+(s>0?s:"")),!1}),navigator.userAgent.includes("Edge/")&&setTimeout(()=>{let r=document.getElementById("piece-sprite");r.href=r.href.replace(".css",".external.css")},1e3),$e()&&!("MSStream"in window)){let r=document.querySelector("meta[name=viewport]");r.setAttribute("content",r.getAttribute("content")+",maximum-scale=1.0")}e&&!site.blindMode&&setTimeout(()=>$("#blind-mode button").trigger("click"),1500),t&&site.asset.loadEsm("diagnosticDialog");let i=document.body.getAttribute("data-announce");i&&Me(JSON.parse(i)),Ai(),w.on("socket.in.redirect",r=>{site.unload.expected=!0,site.redirect(r)}),w.on("socket.in.fen",r=>document.querySelectorAll(".mini-game-"+r.id).forEach(s=>At(s,r))),w.on("socket.in.finish",r=>document.querySelectorAll(".mini-game-"+r.id).forEach(s=>Lt(s,r.win))),w.on("socket.in.announce",Me),w.on("socket.in.tournamentReminder",r=>{if($("#announce").length||document.body.dataset.tournamentId==r.id)return;let s="/tournament/"+r.id;$("body").append($('<div id="announce">').append($(`<a data-icon="${Mo}" class="text">`).attr("href",s).text(r.name)).append($('<div class="actions">').append($(`<a class="withdraw text" data-icon="${Po}">`).attr("href",s+"/withdraw").text(E("pause")).on("click",function(){return K(this.href,{method:"post"}),$("#announce").remove(),!1})).append($(`<a class="text" data-icon="${ko}">`).attr("href",s).text(E("resume")))))})},800)});
