function gi(e,t){return document.createElement(e,t)}function vi(e,t,o){return document.createElementNS(e,t,o)}function bi(){return oe(document.createDocumentFragment())}function yi(e){return document.createTextNode(e)}function ki(e){return document.createComment(e)}function wi(e,t,o){if(V(e)){let n=e;for(;n&&V(n);)n=oe(n).parent;e=n!=null?n:e}V(t)&&(t=oe(t,e)),o&&V(o)&&(o=oe(o).firstChildNode),e.insertBefore(t,o)}function xi(e,t){e.removeChild(t)}function Ci(e,t){V(t)&&(t=oe(t,e)),e.appendChild(t)}function Po(e){if(V(e)){for(;e&&V(e);)e=oe(e).parent;return e!=null?e:null}return e.parentNode}function Mi(e){var t;if(V(e)){let o=oe(e),n=Po(o);if(n&&o.lastChildNode){let r=Array.from(n.childNodes),i=r.indexOf(o.lastChildNode);return(t=r[i+1])!==null&&t!==void 0?t:null}return null}return e.nextSibling}function Pi(e){return e.tagName}function Ti(e,t){e.textContent=t}function Si(e){return e.textContent}function Ri(e){return e.nodeType===1}function Di(e){return e.nodeType===3}function Li(e){return e.nodeType===8}function V(e){return e.nodeType===11}function oe(e,t){var o,n,r;let i=e;return(o=i.parent)!==null&&o!==void 0||(i.parent=t!=null?t:null),(n=i.firstChildNode)!==null&&n!==void 0||(i.firstChildNode=e.firstChild),(r=i.lastChildNode)!==null&&r!==void 0||(i.lastChildNode=e.lastChild),i}var To={createElement:gi,createElementNS:vi,createTextNode:yi,createDocumentFragment:bi,createComment:ki,insertBefore:wi,removeChild:xi,appendChild:Ci,parentNode:Po,nextSibling:Mi,tagName:Pi,setTextContent:Ti,getTextContent:Si,isElement:Ri,isText:Di,isComment:Li,isDocumentFragment:V};function ne(e,t,o,n,r){let i=t===void 0?void 0:t.key;return{sel:e,data:t,children:o,text:n,elm:r,key:i}}var ke=Array.isArray;function le(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function yt(e){return e===void 0}function _(e){return e!==void 0}var kt=ne("",{},[],void 0,void 0);function we(e,t){var o,n;let r=e.key===t.key,i=((o=e.data)===null||o===void 0?void 0:o.is)===((n=t.data)===null||n===void 0?void 0:n.is),s=e.sel===t.sel,a=!e.sel&&e.sel===t.sel?typeof e.text==typeof t.text:!0;return s&&r&&i&&a}function Ai(){throw new Error("The document fragment is not supported on this platform.")}function Ei(e,t){return e.isElement(t)}function $i(e,t){return e.isDocumentFragment(t)}function Oi(e,t,o){var n;let r={};for(let i=t;i<=o;++i){let s=(n=e[i])===null||n===void 0?void 0:n.key;s!==void 0&&(r[s]=i)}return r}var Ni=["create","update","remove","destroy","pre","post"];function wt(e,t,o){let n={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},r=t!==void 0?t:To;for(let d of Ni)for(let g of e){let v=g[d];v!==void 0&&n[d].push(v)}function i(d){let g=d.id?"#"+d.id:"",v=d.getAttribute("class"),b=v?"."+v.split(" ").join("."):"";return ne(r.tagName(d).toLowerCase()+g+b,{},[],void 0,d)}function s(d){return ne(void 0,{},[],void 0,d)}function a(d,g){return function(){if(--g===0){let b=r.parentNode(d);r.removeChild(b,d)}}}function l(d,g){var v,b,C,P;let y,T=d.data;if(T!==void 0){let M=(v=T.hook)===null||v===void 0?void 0:v.init;_(M)&&(M(d),T=d.data)}let x=d.children,S=d.sel;if(S==="!")yt(d.text)&&(d.text=""),d.elm=r.createComment(d.text);else if(S!==void 0){let M=S.indexOf("#"),L=S.indexOf(".",M),O=M>0?M:S.length,E=L>0?L:S.length,N=M!==-1||L!==-1?S.slice(0,Math.min(O,E)):S,K=d.elm=_(T)&&_(y=T.ns)?r.createElementNS(y,N,T):r.createElement(N,T);for(O<E&&K.setAttribute("id",S.slice(O+1,E)),L>0&&K.setAttribute("class",S.slice(E+1).replace(/\./g," ")),y=0;y<n.create.length;++y)n.create[y](kt,d);if(ke(x))for(y=0;y<x.length;++y){let Mo=x[y];Mo!=null&&r.appendChild(K,l(Mo,g))}else le(d.text)&&r.appendChild(K,r.createTextNode(d.text));let qe=d.data.hook;_(qe)&&((b=qe.create)===null||b===void 0||b.call(qe,kt,d),qe.insert&&g.push(d))}else if(!((C=o==null?void 0:o.experimental)===null||C===void 0)&&C.fragments&&d.children){for(d.elm=((P=r.createDocumentFragment)!==null&&P!==void 0?P:Ai)(),y=0;y<n.create.length;++y)n.create[y](kt,d);for(y=0;y<d.children.length;++y){let M=d.children[y];M!=null&&r.appendChild(d.elm,l(M,g))}}else d.elm=r.createTextNode(d.text);return d.elm}function u(d,g,v,b,C,P){for(;b<=C;++b){let y=v[b];y!=null&&r.insertBefore(d,l(y,P),g)}}function p(d){var g,v;let b=d.data;if(b!==void 0){(v=(g=b==null?void 0:b.hook)===null||g===void 0?void 0:g.destroy)===null||v===void 0||v.call(g,d);for(let C=0;C<n.destroy.length;++C)n.destroy[C](d);if(d.children!==void 0)for(let C=0;C<d.children.length;++C){let P=d.children[C];P!=null&&typeof P!="string"&&p(P)}}}function m(d,g,v,b){for(var C,P;v<=b;++v){let y,T,x=g[v];if(x!=null)if(_(x.sel)){p(x),y=n.remove.length+1,T=a(x.elm,y);for(let M=0;M<n.remove.length;++M)n.remove[M](x,T);let S=(P=(C=x==null?void 0:x.data)===null||C===void 0?void 0:C.hook)===null||P===void 0?void 0:P.remove;_(S)?S(x,T):T()}else x.children?(p(x),m(d,x.children,0,x.children.length-1)):r.removeChild(d,x.elm)}}function k(d,g,v,b){let C=0,P=0,y=g.length-1,T=g[0],x=g[y],S=v.length-1,M=v[0],L=v[S],O,E,N,K;for(;C<=y&&P<=S;)T==null?T=g[++C]:x==null?x=g[--y]:M==null?M=v[++P]:L==null?L=v[--S]:we(T,M)?(R(T,M,b),T=g[++C],M=v[++P]):we(x,L)?(R(x,L,b),x=g[--y],L=v[--S]):we(T,L)?(R(T,L,b),r.insertBefore(d,T.elm,r.nextSibling(x.elm)),T=g[++C],L=v[--S]):we(x,M)?(R(x,M,b),r.insertBefore(d,x.elm,T.elm),x=g[--y],M=v[++P]):(O===void 0&&(O=Oi(g,C,y)),E=O[M.key],yt(E)?r.insertBefore(d,l(M,b),T.elm):(N=g[E],N.sel!==M.sel?r.insertBefore(d,l(M,b),T.elm):(R(N,M,b),g[E]=void 0,r.insertBefore(d,N.elm,T.elm))),M=v[++P]);P<=S&&(K=v[S+1]==null?null:v[S+1].elm,u(d,K,v,P,S,b)),C<=y&&m(d,g,C,y)}function R(d,g,v){var b,C,P,y,T,x,S,M;let L=(b=g.data)===null||b===void 0?void 0:b.hook;(C=L==null?void 0:L.prepatch)===null||C===void 0||C.call(L,d,g);let O=g.elm=d.elm;if(d===g)return;if(g.data!==void 0||_(g.text)&&g.text!==d.text){(P=g.data)!==null&&P!==void 0||(g.data={}),(y=d.data)!==null&&y!==void 0||(d.data={});for(let K=0;K<n.update.length;++K)n.update[K](d,g);(S=(x=(T=g.data)===null||T===void 0?void 0:T.hook)===null||x===void 0?void 0:x.update)===null||S===void 0||S.call(x,d,g)}let E=d.children,N=g.children;yt(g.text)?_(E)&&_(N)?E!==N&&k(O,E,N,v):_(N)?(_(d.text)&&r.setTextContent(O,""),u(O,null,N,0,N.length-1,v)):_(E)?m(O,E,0,E.length-1):_(d.text)&&r.setTextContent(O,""):d.text!==g.text&&(_(E)&&m(O,E,0,E.length-1),r.setTextContent(O,g.text)),(M=L==null?void 0:L.postpatch)===null||M===void 0||M.call(L,d,g)}return function(g,v){let b,C,P,y=[];for(b=0;b<n.pre.length;++b)n.pre[b]();for(Ei(r,g)?g=i(g):$i(r,g)&&(g=s(g)),we(g,v)?R(g,v,y):(C=g.elm,P=r.parentNode(C),l(v,y),P!==null&&(r.insertBefore(P,v.elm,r.nextSibling(C)),m(P,[g],0,0))),b=0;b<y.length;++b)y[b].data.hook.insert(y[b]);for(b=0;b<n.post.length;++b)n.post[b]();return v}}function Ro(e,t,o){if(e.ns="http://www.w3.org/2000/svg",o!=="foreignObject"&&t!==void 0)for(let n=0;n<t.length;++n){let r=t[n];if(typeof r=="string")continue;let i=r.data;i!==void 0&&Ro(i,r.children,r.sel)}}function h(e,t,o){let n={},r,i,s;if(o!==void 0?(t!==null&&(n=t),ke(o)?r=o:le(o)?i=o.toString():o&&o.sel&&(r=[o])):t!=null&&(ke(t)?r=t:le(t)?i=t.toString():t&&t.sel?r=[t]:n=t),r!==void 0)for(s=0;s<r.length;++s)le(r[s])&&(r[s]=ne(void 0,void 0,void 0,r[s],void 0));return e[0]==="s"&&e[1]==="v"&&e[2]==="g"&&(e.length===3||e[3]==="."||e[3]==="#")&&Ro(n,r,e),ne(e,n,r,i,void 0)}var _i="http://www.w3.org/1999/xlink",Bi="http://www.w3.org/XML/1998/namespace";function Do(e,t){let o,n=t.elm,r=e.data.attrs,i=t.data.attrs;if(!(!r&&!i)&&r!==i){r=r||{},i=i||{};for(o in i){let s=i[o];r[o]!==s&&(s===!0?n.setAttribute(o,""):s===!1?n.removeAttribute(o):o.charCodeAt(0)!==120?n.setAttribute(o,s):o.charCodeAt(3)===58?n.setAttributeNS(Bi,o,s):o.charCodeAt(5)===58?n.setAttributeNS(_i,o,s):n.setAttribute(o,s))}for(o in r)o in i||n.removeAttribute(o)}}var xt={create:Do,update:Do};function Lo(e,t){let o,n,r=t.elm,i=e.data.class,s=t.data.class;if(!(!i&&!s)&&i!==s){i=i||{},s=s||{};for(n in i)i[n]&&!Object.prototype.hasOwnProperty.call(s,n)&&r.classList.remove(n);for(n in s)o=s[n],o!==i[n]&&r.classList[o?"add":"remove"](n)}}var Ct={create:Lo,update:Lo};var U=e=>e!==void 0,Ao=e=>e!=null;var ce=(e,t)=>{let o=e;return n=>(U(n)&&(o=n,t(n)),o)},Mt=(e,t)=>o=>{let n;return U(o)?(n=e(o),t(o)):n=e(),n},Y=(e,t=()=>{})=>{let o=ce(e,t);return o.toggle=()=>o(!o()),o.effect=t,o},ue=e=>{let t;return()=>(t===void 0&&(t=e()),t)};var We=e=>t=>{let o=()=>$(document).one("click",n=>{document.contains(t)&&(t.contains(n.target)?o():e())});setTimeout(o,300)};var Eo={Accept:"application/web.lichess+json"},$o={cache:"no-cache",credentials:"same-origin"},Oo={"X-Requested-With":"XMLHttpRequest"},Pt=e=>{if(e.ok)return e;throw e.status==429?new Error("Too many requests"):e.status==413?new Error("The uploaded file is too large"):new Error(`Error ${e.status}`)},Tt=(e,t={})=>fetch(e,{headers:{...Eo},...t}).then(o=>Pt(o).json()),Fe=(e,t={})=>Ii(e,t).then(o=>Pt(o).json()),Ii=(e,t={})=>fetch(e,{...$o,headers:{...Eo,...Oo},...t}),W=(e,t={})=>Hi(e,t).then(o=>Pt(o).text()),Hi=(e,t={})=>fetch(e,{...$o,headers:{...Oo},...t});var Ke=e=>{let t=new FormData;for(let o of Object.keys(e))U(e[o])&&t.append(o,e[o]);return t};var Ue="\uE005";var No="\uE019";var _o="\uE034",Bo="\uE035";var Io="\uE038";var St="\uE03A";var de="\uE03F";var Ho="\uE042";var zo="\uE044";var qo="\uE049",Wo="\uE04A",Rt="\uE04B",Dt="\uE04C",Fo="\uE04D",Ko="\uE04E";var xe="\uE053";var Ce="\uE055";var Uo="\uE059";var Me="\uE05C",Go="\uE05D";var jo="\uE071";var Vo="\uE073";var re="\uE076";function D(e){return{insert:t=>e(t.elm)}}function w(e,t,o,n=!0){return D(r=>r.addEventListener(e,i=>{let s=t(i);return s===!1&&!n&&i.preventDefault(),o==null||o(),s},{passive:n}))}var Xo=e=>({"data-icon":e});var Jo=e=>e&&e!==!0||e==="",Yo=e=>(Array.isArray(e)?e:[e]).filter(Jo);function c(e,t,o){return o?h(e,t,Yo(o)):Jo(t)?Array.isArray(t)||typeof t=="object"&&"sel"in t?h(e,Yo(t)):h(e,t):h(e)}var ie=e=>({attrs:{"data-icon":e}});function Pe(e){let t=new Map;if(!e)return t;if(typeof e=="string")for(let o of e.split(" "))t.set(o.slice(0,2),o.slice(2).match(/.{2}/g));else for(let o in e)t.set(o,e[o].match(/.{2}/g));return t}var Qo=(e,t,o)=>({set(n){e=n},tab:{key:"tourStanding",name:o},view(){return h("div",{hook:D(n=>site.asset.loadCssPath("round.tour-standing"))},[t?h("h3.text",{attrs:{"data-icon":Uo}},t.name):null,h("table.slist",[h("tbody",e.map((n,r)=>h("tr."+n.n,[h("td.name",[h("span.rank",""+(r+1)),h("a.user-link.ulpt",{attrs:{href:`/@/${n.n}`}},(n.t?n.t+" ":"")+n.n)]),h("td.total",n.f?{class:{"is-gold":!0},attrs:{"data-icon":zo}}:{},""+n.s)])))])])}});async function Zo(e,t){var l;let o=e.data;o.tournament&&(document.body.dataset.tournamentId=o.tournament.id);let n=e.data.player.spectator?`/watch/${o.game.id}/${o.player.color}/v6`:`/play/${o.game.id}${o.player.id}/v6`;site.socket=new site.StrongSocket(n,o.player.version,{params:{userTv:o.userTv&&o.userTv.id},receive(u,p){s.socketReceive(u,p)},events:{tvSelect(u){o.tv&&o.tv.channel==u.channel?site.reload():$(".tv-channels ."+u.channel+" .champion").html(u.player?[u.player.title,u.player.name,o.pref.ratings?u.player.rating:""].filter(p=>p).join("&nbsp"):"Anonymous")},endData(){W(`${o.tv?"/tv":""}/${o.game.id}/${o.player.color}/sides`).then(u=>{let p=$(u),m=p.find(".game__meta");m.length&&$(".game__meta").replaceWith(m),$(".crosstable").replaceWith(p.find(".crosstable")),r(),site.contentLoaded()})},tourStanding(u){var p,m,k;(p=e.chat)!=null&&p.plugin&&((k=(m=e.chat)==null?void 0:m.instance)==null||k.then(R=>{e.chat.plugin.set(u),R.redraw()}))}}});let r=()=>{o.tournament&&$(".game__tournament .clock").each(function(){site.clockWidget(this,{time:parseFloat(this.dataset.time)})})},i=u=>{if(!u.player.spectator){if(u.steps.length<4)return"start";if(u.game.status.id>=30)return"end"}};e.element=document.querySelector(".round__app"),e.socketSend=site.socket.send;let s=t(e,site.blindMode?await site.asset.loadEsm("round.nvui"):void 0),a=e.chat;a&&((l=o.tournament)!=null&&l.top?(a.plugin=Qo(o.tournament.top,o.tournament.team,e.i18n.standing),a.alwaysEnabled=!0):!o.simul&&!o.swiss&&(a.preset=i(o),a.parseMoves=!0),a.noteId&&(a.noteAge||0)<10&&(a.noteText=""),a.instance=site.makeChat(a),!o.tournament&&!o.simul&&!o.swiss&&(e.onChange=u=>a.instance.then(p=>p.preset.setGroup(i(u))))),r(),$(".round__now-playing .move-on input").on("change",s.moveOn.toggle).prop("checked",s.moveOn.get()).on("click","a",()=>(site.unload.expected=!0,!0)),location.pathname.lastIndexOf("/round-next/",0)===0&&history.replaceState(null,"","/"+o.game.id),$("#zentog").on("click",()=>site.pubsub.emit("zen")),site.storage.make("reload-round-tabs").listen(site.reload),!o.player.spectator&&location.hostname!=document["Location".toLowerCase()].hostname&&(alert(`Games cannot be played through a web proxy. Please use ${location.hostname} instead.`),site.socket.destroy())}function en(){if("ontouchstart"in window)return;let e=200,t=8,o,n,r=s=>{o=s.pageX,n=s.pageY},i={};$("#topnav.hover").each(function(){let s=$(this).removeClass("hover"),a=()=>s.toggleClass("hover"),l=()=>{Math.sqrt((i.pX-o)*(i.pX-o)+(i.pY-n)*(i.pY-n))<t?(s.off(i.event,r),delete i.timeoutId,i.isActive=!0,a()):(i.pX=o,i.pY=n,i.timeoutId=setTimeout(l,e))},u=function(p){i.timeoutId&&(i.timeoutId=clearTimeout(i.timeoutId));let m=i.event="mousemove";if(p.type=="mouseover"){if(i.isActive||p.buttons)return;i.pX=p.pageX,i.pY=p.pageY,s.off(m,r).on(m,r),i.timeoutId=setTimeout(l,e)}else{if(!i.isActive)return;s.off(m,r),i={},a()}};s.on("mouseover",u).on("mouseleave",u)})}var Ge=(()=>{let e="mousemove",t=!1,o=[],n=0;function r(a){o.push({b:a.buttons!=0,x:a.clientX,y:a.clientY}),o.length>4&&(o.shift(),s())}let i=(a,l)=>Math.pow(l.x-a.x,2)+Math.pow(l.y-a.y,2);function s(){var a=o;!a[0].b&&a[1].b&&a[2].b&&!a[3].b&&i(a[0],a[1])>900&&i(a[1],a[2])===0&&i(a[2],a[3])===0&&n++}return{start(){t||(t=!1,document.addEventListener(e,r))},stop(){t&&(t=!1,document.removeEventListener(e,r))},hits:()=>n}})(),Se=[],Lt=6,tn=!1,se={holdAcc:0},on=!1;function zi(e,t){if(t.premove&&e.ply>1&&(on=!0),on||!t.holdTime||e.ply>30){Ge.stop();return}if(Se.push(t.holdTime),Se.length<=Lt)return;let o=!1,n;Se.shift();let r=Se.reduce((i,s)=>i+s)/Lt;r>2&&r<140&&(n=Se.map(s=>Math.pow(s-r,2)).reduce((s,a)=>s+a)/(Lt-1),o=n<256),(o||tn)&&$(".manipulable .cg-board").toggleClass("bh1",o&&Ge.hits()>2),o?(se.hold||(se.holdAcc++,se.holdAcc>5&&(e.socket.send("hold",{mean:Math.round(r),sd:Math.round(Math.sqrt(n))}),se.hold=!0)),Ge.start(),Ge.hits()>2&&!se.ick&&(e.socket.send("bye2"),Z(e.data,"ick2"),se.ick=!0)):se.holdAcc=0,tn=o}var qi=()=>navigator.userAgent.includes("Chrome/"),Z=(e,t)=>Wi(e.game.id+e.player.id,t),Wi=(e,t)=>rs("/jslog/"+e+"?n="+t,{method:"post"}),Fi=()=>!Object.keys(window.WebSocket).length,Ki=()=>{let e=Object.keys(window.WebSocket);return e[0]=="prototype"&&!e[1]},Ui=()=>!window.WebSocket.prototype.send.toString().includes("[native code]"),B=e=>$(atob(e)).length,je=0,Gi=()=>{if(je||!qi())return!1;je=1;try{document.querySelectorAll(".game__meta div").forEach(e=>{e.attachShadow({mode:"open"}).innerHTML="<slot>"})}catch(e){je=2}return je==2},ji=()=>{let e=()=>{let t="chess-master-autoclick",o=localStorage.getItem(t)!==null;return o&&localStorage.removeItem(t),o};return B("YVtocmVmKj0iY2hlc3Mub3JnZnJlZS5jb20iXTpub3QoW2hyZWYqPSJsaWNoZXNzLm9yZyJdKQ==")||e()?"cma20":($("body>div[id]>div[class]>div[style]>span[id][style]").attr("style")||"").includes("color:blue")?"cma22":!1},Vi=()=>{var e;return B("YVtocmVmPSJodHRwOi8vdGhhcGF3bmd1bi5saXZlIl0=")?"lga1":B("Lm1haW4tYm9hcmQgY2FudmFz")||B("aW1nW3NyYz0iaHR0cHM6Ly9saWNoZXNzLmdhLzEyOC5wbmciXQ==")?"lga3":B("I2JhckxvZ29bc3R5bGVd")?"lga4":!((e=$(".main-board cg-board > *:last-child")[0])===null||e===void 0)&&e.tagName.includes("-")?"lga14":Gi()?"lga16":!1},Yi=()=>B("I2F1dGhCYXI=")||B("I21vdmVfc3VnZ2VzdF9ib3g="),Xi=()=>B("Y2ctYm9hcmQ+ZGl2W3N0eWxlXQ==")==2,nn=!1,rn=["Y2hlc3NleHBlcnQ6Y2xpZW50OnNlbGVjdG9ycw==","Y2hlc3NleHBlcnQ6Y2xpZW50Om1vdmU="],sn=()=>{nn="cxp1",rn.forEach(e=>window.removeEventListener(atob(e),sn))};rn.forEach(e=>window.addEventListener(atob(e),sn));var Ji=()=>nn,Qi=()=>B("Ym9keSA+IGRpdiA+IGRpdi5nbWM=")?"sqn1":B("c3ZnW2RhdGEtaWNvbj0ibWludXMiXQ==")?"sqn2":B("Ym9keT5zdmc+bWFya2Vy")?"sqn3":!1,Zi=()=>window[atob("U1RPQ0tGSVNI")]?"kjf1":!1,es=()=>B("I2FzZE8=")?"kbf1":!1,ts=()=>B("Ym9keT5zdmc+cG9seWdvbg==")?"aca1":!1,os=()=>ln.length>0?"wpl1":!1,ns=()=>B("I0twYXdudQ==")?"kbg1":!1,At=8+Math.round(Math.random()*13);function an(e,t){if(zi(e,t),e.ply<=At+2&&e.ply>At)try{if(e.opts.userId||Math.random()<.2){let o=(r,i)=>{Math.random()<i&&setTimeout(()=>Math.random()<.5?Z(e.data,r):window.lichess.pubsub.emit("ab.rep",r),At*1500)},n;(n=ji())||(n=Vi())?o(n,.5):(n=Ji())?o(n,.3):(n=Qi())?o(n,.2):(n=Zi())?o(n,.3):(n=es())||(n=ts())?o(n,.5):((n=ns())||(n=os()))&&o(n,.3)}Yi()&&Z(e.data,"los"),e.opts.userId&&Ki()&&Z(e.data,"wst1"),Ui()&&Z(e.data,"wst2"),Xi()&&Z(e.data,"wrp")}catch(o){console.error(o),Z(e.data,"err "+(""+o).toString().slice(0,120))}}var rs=window.fetch,ln=[];WebSocket.prototype._bridge=WebSocket.prototype.addEventListener;WebSocket.prototype.addEventListener=function(e,t){e=="message"&&ln.push(t.toString()),this._bridge(e,t)};function cn(e){setTimeout(()=>{Fi()&&Z(e.data,"ih1")},1e3)}var X=e=>e.steps[0].ply,ee=e=>Et(e).ply,Et=e=>e.steps[e.steps.length-1],fe=(e,t)=>e.steps[t-X(e)],$t=e=>{e.clock&&(e.clock.showTenths=e.pref.clockTenths,e.clock.showBar=e.pref.clockBar),e.correspondence&&(e.correspondence.showBar=e.pref.clockBar),["horde","crazyhouse"].includes(e.game.variant.key)&&(e.pref.showCaptured=!1),e.expiration&&(e.expiration.movedAt=Date.now()-e.expiration.idleMillis)};var Re={created:10,started:20,aborted:25,mate:30,resign:31,stalemate:32,timeout:33,draw:34,outoftime:35,cheat:36,noStart:37,variantEnd:60},ss=e=>e.game.status.id>=Re.started,H=e=>e.game.status.id>=Re.mate,F=e=>e.game.status.id===Re.aborted,un=e=>ss(e)&&!H(e)&&!F(e);var A=e=>e.game.status.id<Re.aborted&&!mn(e),pe=e=>A(e)&&!e.player.spectator,z=e=>pe(e)&&e.game.player==e.player.color,as=e=>!!e.tournament||!!e.simul||!!e.swiss,Ye=e=>e.game.turns-(e.game.startedAtTurn||0),me=e=>Ye(e)>1,Ot=e=>{var t;return A(e)&&!me(e)&&!as(e)&&!(!((t=e.game.rules)===null||t===void 0)&&t.includes("noAbort"))},Xe=e=>{var t;return!(!((t=e.game.rules)===null||t===void 0)&&t.includes("noRematch"))},dn=e=>A(e)&&e.takebackable&&me(e)&&!e.player.proposingTakeback&&!e.opponent.proposingTakeback,fn=e=>A(e)&&e.game.turns>=2&&!e.player.offeringDraw&&!vn(e)&&Je(e),Je=e=>!e.swiss||Ye(e)>=60,Qe=e=>A(e)&&!Ot(e),Ze=e=>!!e.tournament&&e.tournament.berserkable&&pe(e)&&!me(e),pn=e=>pe(e)&&e.moretimeable&&(!!e.clock||!!e.correspondence&&e.correspondence[e.opponent.color]<e.correspondence.increment-3600),mn=e=>e.game.source==="import",hn=e=>mn(e)||H(e)||F(e)&&me(e);function gn(e,t){return e.player.color===t?e.player:e.opponent.color===t?e.opponent:null}var vn=e=>!!(e.player.ai||e.opponent.ai),bn=e=>H(e)||A(e)&&(!e.clock||!pe(e)),ls=e=>e.game.speed==="correspondence",et=(e,t,o)=>{let n=gn(e,t);o=o||!!n.ai,n.onGame=o,o&&Nt(e,t,!1)},Nt=(e,t,o)=>{let n=gn(e,t);n.isGone=!n.ai&&o,n.isGone===!1&&n.user&&(n.user.online=!0)};var yn=e=>!vn(e)&&(!!e.simul||ls(e));function ae(e,t,o){let n=e.game?e.game.id:e;return(o?"/embed/":"/")+n+(t?"/"+t:"")}function _t(e,t,o=!1){let n,r=0;return function(...i){let s=this;n&&clearTimeout(n),n=void 0;let a=performance.now()-r;r=performance.now(),o&&a>t?e.apply(s,i):n=setTimeout(()=>{n=void 0,e.apply(s,i)},t)}}var kn={Hidden:0,Inside:1,Outside:2},tt={Never:1,OnPremove:2,Always:3},Bt={Never:0,Below10Secs:1,Always:2},Le={Never:0,OnlyAtStart:1,Always:2},It={Click:0,Drag:1,ClickOrDrag:2},Ht={Never:0,OnlySlowGames:1,Always:2};function zt(e,t,o,n){if(t===Le.Never)return;let r=document.createElement("cg-resize");e.container.appendChild(r);let i=s=>{s.preventDefault();let a=s.type==="touchstart"?"touchmove":"mousemove",l=s.type==="touchstart"?"touchend":"mouseup",u=wn(s),p=parseInt(window.getComputedStyle(document.body).getPropertyValue("--zoom")),m=p,k=_t(()=>W(`/pref/zoom?v=${m}`,{method:"post"}),700),R=d=>{let g=wn(d),v=g[0]-u[0]+g[1]-u[1];m=Math.round(Math.min(100,Math.max(0,p+v/10))),document.body.style.setProperty("--zoom",m.toString()),window.dispatchEvent(new Event("resize")),k()};document.body.classList.add("resizing"),document.addEventListener(a,R),document.addEventListener(l,()=>{document.removeEventListener(a,R),document.body.classList.remove("resizing")},{once:!0})};if(r.addEventListener("touchstart",i,{passive:!1}),r.addEventListener("mousedown",i,{passive:!1}),t===Le.OnlyAtStart){let s=a=>r.classList.toggle("none",n?!n(a):a>=2);s(o),site.pubsub.on("ply",s)}}function wn(e){var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]}var qt=["a","b","c","d","e","f","g","h"],Wt=["1","2","3","4","5","6","7","8"];var Rl=[...Wt].reverse(),Ft=Array.prototype.concat(...qt.map(e=>Wt.map(t=>e+t))),Ee=e=>Ft[8*e[0]+e[1]],J=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],$e=e=>{if(e)return e[1]==="@"?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},xn=Ft.map(J);var j=e=>e==="white"?"black":"white",ot=(e,t)=>{let o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},Kt=(e,t)=>e.role===t.role&&e.color===t.color;var Cn=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`};var Mn=(e,t)=>{e.style.visibility=t?"visible":"hidden"},nt=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]};function Pn(e){let t=e.data,o=e.makeCgHooks(),n=fe(t,e.ply),r=e.isPlaying();return{fen:n.fen,orientation:Ut(t,e.flip),turnColor:n.ply%2===0?"white":"black",lastMove:$e(n.uci),check:!!n.check,coordinates:t.pref.coords!==kn.Hidden,addPieceZIndex:e.data.pref.is3d,addDimensionsCssVarsTo:document.body,highlight:{lastMove:t.pref.highlight,check:t.pref.highlight},events:{move:o.onMove,dropNewPiece:o.onNewPiece,insert(i){let s=X(e.data),a=(s%2===0?"white":"black")!==t.player.color,l=s+2+ +a;zt(i,r?e.data.pref.resizeHandle:Le.Always,e.ply,u=>u<=l)}},movable:{free:!1,color:r?t.player.color:void 0,dests:r?Pe(t.possibleMoves):new Map,showDests:t.pref.destination&&!e.blindfold(),rookCastle:t.pref.rookCastle,events:{after:o.onUserMove,afterNewPiece:o.onUserNewPiece}},animation:{enabled:!0,duration:t.pref.animationDuration},premovable:{enabled:t.pref.enablePremove,showDests:t.pref.destination&&!e.blindfold(),castle:t.game.variant.key!=="antichess",events:{set:o.onPremove,unset:o.onCancelPremove}},predroppable:{enabled:t.pref.enablePremove&&t.game.variant.key==="crazyhouse",events:{set:o.onPredrop,unset(){o.onPredrop(void 0)}}},draggable:{enabled:t.pref.moveEvent!==It.Click,showGhost:t.pref.highlight},selectable:{enabled:t.pref.moveEvent!==It.Drag},drawable:{enabled:!0,defaultSnapToValidMove:site.storage.boolean("arrow.snap").getOrDefault(!0)},disableContextMenu:!0}}var Tn=e=>e.chessground.set(Pn(e)),Ut=(e,t)=>e.game.variant.key==="racingKings"?t?"black":"white":t?e.opponent.color:e.player.color,Sn=e=>h("div.cg-wrap",{hook:D(t=>e.setChessground(site.makeChessground(t,Pn(e))))});var Gt=[],Rn=!1;function ds(){Rn||(Rn=!0,window.addEventListener("focus",()=>{Gt.forEach(e=>e.close()),Gt=[]}))}function fs(e){let t=site.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(t.get(),10)<1e3)return;t.set(""+Date.now()),$.isFunction(e)&&(e=e());let o=new Notification("lichess.org",{icon:site.asset.url("logo/lichess-favicon-256.png",{noVersion:!0}),body:e});o.onclick=()=>window.focus(),Gt.push(o),ds()}function rt(e){document.hasFocus()||!("Notification"in window)||Notification.permission==="granted"&&setTimeout(fs,10+Math.random()*500,e)}function Dn(e){let t,o;return function(...n){let r=this,i=()=>{o=void 0,t=e.apply(r,n).finally(()=>{t=void 0,o&&o()})};t?o=i:i()}}function ps(e,t){return function(...o){let n=this;return new Promise(r=>{t.apply(n,o).finally(()=>setTimeout(r,e.apply(n,o)))})}}function Ln(e,t){return Dn(ps(e,t))}function ge(e,t){return Dn(function(...o){return t.apply(this,o),new Promise(n=>setTimeout(n,e))})}var it=e=>{let t=e.data.player.spectator?`/${e.data.game.id}/${e.data.player.color}`:`/${e.data.game.id}${e.data.player.id}`;return Fe(t)};var An=e=>Fe(`/whats-next/${e.data.game.id}${e.data.player.id}`),En=e=>Fe("/challenge/rematch-of/"+e,{method:"post"}),$n=Ln(()=>1e3,e=>W("/pref/zen",{method:"post",body:Ke({zen:e?1:0})}));function ms(e,t,o){let n,r=0;return function(...i){let s=this,a=performance.now()-r,l=()=>{n=void 0,r=performance.now(),e*=t,o.apply(s,i)};n&&clearTimeout(n),a>e?l():n=setTimeout(l,e-a)}}function On(e,t){site.socket.sign(t.sign);let o=(r,i)=>{r&&r.t?(t.setLoading(!1),n[r.t](r.d)):it(t).then(s=>{site.socket.getVersion()>s.player.version?i?site.reload():o(r,!0):t.reload(s)},site.reload)},n={takebackOffers(r){t.data.player.proposingTakeback=r[t.data.player.color],(t.data.opponent.proposingTakeback=r[t.data.opponent.color])&&t.opponentRequest("takeback","yourOpponentProposesATakeback"),t.redraw()},move:t.apiMove,drop:t.apiMove,reload:o,redirect:t.setRedirecting,clockInc(r){t.clock&&(t.clock.addTime(r.color,r.time),t.redraw())},cclock(r){t.corresClock&&(t.data.correspondence.white=r.white,t.data.correspondence.black=r.black,t.corresClock.update(r.white,r.black),t.redraw())},crowd(r){["white","black"].forEach(i=>{U(r[i])&&et(t.data,i,r[i])}),t.redraw()},endData:t.endWithData,rematchOffer(r){t.data.player.offeringRematch=r===t.data.player.color,(t.data.opponent.offeringRematch=r===t.data.opponent.color)&&t.opponentRequest("rematch","yourOpponentWantsToPlayANewGameWithYou"),t.redraw()},rematchTaken(r){t.data.game.rematch=r,t.data.player.spectator?t.redraw():t.setLoading(!0)},drawOffer(r){if(t.isPlaying()&&(t.data.player.offeringDraw=r===t.data.player.color,(t.data.opponent.offeringDraw=r===t.data.opponent.color)&&t.opponentRequest("draw","yourOpponentOffersADraw")),r){let i=t.lastPly();r=="white"==(i%2==0)&&i++,t.data.game.drawOffers=(t.data.game.drawOffers||[]).concat([i])}t.redraw()},berserk(r){t.setBerserk(r)},gone:t.setGone,goneIn:t.setGone,checkCount(r){t.data.player.checks=t.data.player.color=="white"?r.white:r.black,t.data.opponent.checks=t.data.opponent.color=="white"?r.white:r.black,t.redraw()},simulPlayerMove(r){t.opts.userId&&t.data.simul&&t.opts.userId==t.data.simul.hostId&&r!==t.data.game.id&&t.moveOn.get()&&!z(t.data)&&(t.setRedirecting(),site.sound.play("move"),location.href="/"+r)},simulEnd(r){site.dialog.dom({htmlText:`<div><p>Simul complete!</p><br /><br /><a class="button" href="/simul/${r.id}">Back to ${r.name} simul</a></div>`})}};return site.pubsub.on("ab.rep",r=>e("rep",{n:r})),{send:e,handlers:n,moreTime:ge(300,()=>e("moretime")),outoftime:ms(500,1.1,()=>e("flag",t.data.game.player)),berserk:ge(200,()=>e("berserk",null,{ackable:!0})),sendLoading(r,i){t.setLoading(!0),e(r,i)},receive(r,i){let s=n[r];return s?(s(i),!0):!1},reload:o}}var hs=document.title,Vt=0,Nn=["/assets/logo/lichess-favicon-32.png","/assets/logo/lichess-favicon-32-invert.png"].map((e,t)=>()=>{Vt!==t&&(document.getElementById("favicon").href=e,Vt=t)}),ve;function _n(){ve&&clearTimeout(ve),ve=void 0,Nn[0]()}function gs(){function e(){document.hasFocus()||(Nn[1-Vt](),ve=setTimeout(e,1e3))}ve||(ve=setTimeout(e,200))}var Bn=()=>window.addEventListener("focus",_n);function In(e,t){e.data.player.spectator||(t||(F(e.data)||H(e.data)?t=e.noarg("gameOver"):z(e.data)?(t=e.noarg("yourTurn"),document.hasFocus()||gs()):(t=e.noarg("waitingForOpponent"),_n())),document.title=`${t} - ${hs}`)}var Hn=0,Yt=0;function zn(e){e||(Yt=Date.now()+1e4),window.addEventListener("focus",()=>Hn=Date.now())}var Xt=()=>Hn>=Yt,qn=()=>Yt=Date.now()+1e3;function Wn(e,t){for(let o=0;o<8;o++)for(let n=o%2===t?0:1;n<8;n+=2)if(/[bB]/.test(e[o*8+n]))return!0;return!1}function ys(e,t){if(e==="horde"||e==="kingOfTheHill"||e==="racingKings"||e==="crazyhouse"||e==="atomic"||e==="antichess")return!1;let o=t.split(" ")[0].replace(/[^a-z]/gi,"");if(/^[Kk]{2}$/.test(o))return!0;if(e==="threeCheck"||/[prq]/i.test(o))return!1;if(/n/.test(o))return o.length-o.replace(/[a-z]/g,"").length<=2&&!/[PBNR]/.test(o);if(/N/.test(o))return o.length-o.replace(/[A-Z]/g,"").length<=2&&!/[pbnr]/.test(o);if(/b/i.test(o)){for(let n=8;n>1;n--)o=o.replace(""+n,"1"+(n-1));return(!Wn(o,0)||!Wn(o,1))&&!/[pPnN]/.test(o)}return!1}function Oe(e){var t;let o=e.trans.noarg,n=e.data,r=n.game.winner?" \u2022 "+o(n.game.winner+"IsVictorious"):"";switch(n.game.status.name){case"started":return o("playingRightNow");case"aborted":return o("gameAborted")+r;case"mate":return o("checkmate")+r;case"resign":return o(n.game.winner=="white"?"blackResigned":"whiteResigned")+r;case"stalemate":return o("stalemate")+r;case"timeout":switch(n.game.winner){case"white":return o("blackLeftTheGame")+r;case"black":return o("whiteLeftTheGame")+r;default:return`${n.game.turns%2===0?o("whiteLeftTheGame"):o("blackLeftTheGame")} \u2022 ${o("draw")}`}case"draw":return n.game.fen.split(" ")[4]==="100"?`${o("fiftyMovesWithoutProgress")} \u2022 ${o("draw")}`:n.game.threefold?`${o("threefoldRepetition")} \u2022 ${o("draw")}`:ys(n.game.variant.key,n.game.fen)?`${o("insufficientMaterial")} \u2022 ${o("draw")}`:!((t=n.game.drawOffers)===null||t===void 0)&&t.some(i=>i>=n.game.turns)?o("drawByMutualAgreement"):o("draw");case"outoftime":return`${n.game.turns%2===0?o("whiteTimeOut"):o("blackTimeOut")}${r||` \u2022 ${o("draw")}`}`;case"noStart":return(n.game.winner=="white"?o("blackDidntMove"):o("whiteDidntMove"))+r;case"cheat":return o("cheatDetected")+r;case"variantEnd":switch(n.game.variant.key){case"kingOfTheHill":return o("kingInTheCenter")+r;case"threeCheck":return o("threeChecks")+r}return o("variantEnding")+r;case"unknownFinish":return n.game.winner?o(n.game.winner+"IsVictorious"):"Finished";default:return n.game.status.name+r}}var ks=[{"stroke-width":3.779,d:"m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"},{"stroke-width":4.157,d:"m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"},{"stroke-width":4.535,d:"m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"}],Fn=(e="-2 -2 54 54")=>h("div.spinner",{"aria-label":"loading"},[h("svg",{attrs:{viewBox:e}},[h("g",{attrs:{mask:"url(#mask)",fill:"none"}},ks.map(t=>h("path",{attrs:t})))])]);function ws(e){return e.game.variant.key==="racingKings"?"white":e.player.color}function xs(e,t){return"/#pool/"+e.initial/60+"+"+e.increment+(t?"/"+t.id:"")}function st(e){let t=e.data,o=ae(t,ws(t))+"#"+e.ply;return hn(t)&&c("a.fbt",{attrs:{href:o},hook:w("click",n=>{location.pathname===o.split("#")[0]&&location.reload()})},e.noarg("analysis"))}function Cs(e){let t=e.data,o=!!t.player.offeringRematch,n=!o&&!t.opponent.onGame&&(!!t.clock||!t.player.user||!t.opponent.user),r=!!t.opponent.offeringRematch&&!n,i=e.noarg;return Xe(t)?[r&&c("button.rematch-decline",{attrs:{"data-icon":de,title:i("decline")},hook:w("click",()=>e.socket.send("rematch-no"))},e.nvui?i("decline"):""),c("button.fbt.rematch.white",{class:{me:o,glowing:r,disabled:n},attrs:{title:r?i("yourOpponentWantsToPlayANewGameWithYou"):o?i("rematchOfferSent"):""},hook:w("click",()=>{let s=e.data;s.game.rematch?location.href=ae(s.game.rematch,s.opponent.color):s.player.offeringRematch?(s.player.offeringRematch=!1,e.socket.send("rematch-no")):(s.opponent.onGame||!s.clock)&&(s.player.offeringRematch=!0,s.opponent.onGame?e.socket.send("rematch-yes"):!n&&!s.opponent.onGame&&e.challengeRematch())},e.redraw)},[o?Fn():c("span",i("rematch"))])]:[]}function Ne(e,t,o,n,r,i){let s=()=>!t||t(e.data).enabled,a=()=>{var l;return((l=t==null?void 0:t(e.data))==null?void 0:l.overrideHint)||n};return c("button.fbt."+r,{attrs:{disabled:!s(),title:e.noarg(a())},hook:w("click",()=>{s()&&(i?i():e.socket.sendLoading(r))})},[c("span",e.nvui?[e.noarg(a())]:ie(o))])}function Kn(e){var o;let t=e.opponentGone();return(o=e.data.game.rules)!=null&&o.includes("noClaimWin")?null:t===!0?c("div.suggestion",[c("p",{hook:er},e.noarg("opponentLeftChoices")),c("button.button",{hook:w("click",()=>e.socket.sendLoading("resign-force"))},e.noarg("forceResignation")),c("button.button",{hook:w("click",()=>e.socket.sendLoading("draw-force"))},e.noarg("forceDraw"))]):t&&c("div.suggestion",c("p",e.trans.vdomPlural("opponentLeftCounter",t,c("strong",""+t))))}var Un=(e,t)=>c("button.fbt.no",{attrs:{title:e.noarg("cancel"),"data-icon":de},hook:w("click",()=>t(!1))}),Gn=e=>c("div.act-confirm",[c("button.fbt.yes",{attrs:{title:e.noarg("resign"),"data-icon":Ce},hook:w("click",()=>e.resign(!0))}),Un(e,e.resign)]),jn=e=>c("div.act-confirm",[c("button.fbt.yes.draw-yes",{attrs:{title:e.noarg("offerDraw"),"data-icon":re},hook:w("click",()=>e.offerDraw(!0))}),Un(e,e.offerDraw)]),Vn=(e,t)=>{var o;return c("button.button.draw-yes",{hook:w("click",()=>t(e.data).enabled?e.socket.sendLoading("draw-claim"):void 0),attrs:{title:e.noarg(((o=t(e.data))==null?void 0:o.overrideHint)||"claimADraw"),disabled:!t(e.data).enabled},class:{disabled:!t(e.data).enabled}},c("span","\xBD"))};function Yn(e){return e.data.game.threefold&&c("div.suggestion",[c("p",{hook:er},e.noarg("threefoldRepetition"))])}function Xn(e){var o;let t=e.data;return((o=t.tournament)==null?void 0:o.running)&&c("div.follow-up",[c("a.text.fbt.strong.glowing",{attrs:{"data-icon":St,href:"/tournament/"+t.tournament.id},hook:w("click",e.setRedirecting)},e.noarg("backToTournament")),c("form",{attrs:{method:"post",action:"/tournament/"+t.tournament.id+"/withdraw"}},[c("button.text.fbt.weak",ie(Fo),e.noarg("pause"))]),st(e)])}function Jn(e){var o;let t=e.data;return((o=t.swiss)==null?void 0:o.running)&&c("div.follow-up",[c("a.text.fbt.strong.glowing",{attrs:{"data-icon":St,href:"/swiss/"+t.swiss.id},hook:w("click",e.setRedirecting)},e.noarg("backToTournament")),st(e)])}function at(e){return pn(e.data)&&c("a.moretime",{attrs:{title:e.data.clock?e.trans("giveNbSeconds",e.data.clock.moretime):e.noarg("giveMoreTime"),"data-icon":Ho},hook:w("click",e.socket.moreTime)})}function Qn(e){let t=e.data,o=!t.game.rematch&&(H(t)||F(t)&&(!t.game.rated||!["lobby","pool"].includes(t.game.source)))&&!t.tournament&&!t.simul&&!t.swiss&&!t.game.boosted,n=(H(t)||F(t))&&(t.game.source==="lobby"||t.game.source==="pool"),r=o||t.game.rematch?Cs(e):[];return c("div.follow-up",[...r,t.tournament&&c("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")),t.swiss&&c("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")),n&&c("a.fbt",{attrs:{href:t.game.source==="pool"?xs(t.clock,t.opponent.user):"/?hook_like="+t.game.id}},e.noarg("newOpponent")),st(e)])}function Zn(e){let t=e.data,o=[t.game.rematch&&c("a.fbt.text",{attrs:{href:`/${t.game.rematch}/${t.opponent.color}`}},e.noarg("viewRematch")),t.tournament&&c("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")),t.swiss&&c("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")),st(e)];return o.find(n=>!!n)&&c("div.follow-up",o)}var er=D(e=>site.pubsub.emit("round.suggestion",e.textContent));function nr(e,t,o){let n=e.clock,r=n.millisOf(t.color),i=e.data.player.color===t.color,s=t.color===n.times.activeColor,a=u=>{let p=n.elements[t.color],m=n.millisOf(t.color),k=t.color===n.times.activeColor;p.time=u,p.clock=u.parentElement,u.innerHTML=rr(m,n.showTenths(m),k,n.opts.nvui)},l={insert:u=>a(u.elm),postpatch:(u,p)=>a(p.elm)};return c(`div.rclock.rclock-${o}.rclock-${t.color}`,{class:{outoftime:r<=0,running:s,emerg:r<n.emergMs}},n.opts.nvui?[c("div.time",{attrs:{role:"timer"},hook:l})]:[n.showBar&&me(e.data)?Ps(e,t.color):void 0,c("div.time",{class:{hour:r>3600*1e3},hook:l}),Ts(e,t.color,o),i?Ss(e):at(e),Rs(e,t.color,o)])}var Jt=e=>(e<10?"0":"")+e,or="<sep>:</sep>",Ms='<sep class="low">:</sep>';function rr(e,t,o,n){let r=new Date(e);if(n)return(e>=36e5?Math.floor(e/36e5)+"H:":"")+r.getUTCMinutes()+"M:"+r.getUTCSeconds()+"S";let i=r.getUTCMilliseconds(),s=o&&i<500?Ms:or,a=Jt(r.getUTCMinutes())+s+Jt(r.getUTCSeconds());if(e>=36e5)return Jt(Math.floor(e/36e5))+or+a;if(t){let l=Math.floor(i/100).toString();return!o&&e<1e3&&(l+="<huns>"+Math.floor(i/10)%10+"</huns>"),a+"<tenths><sep>.</sep>"+l+"</tenths>"}else return a}function Ps(e,t){let o=e.clock,n=r=>{if(r.animate!==void 0){let i=o.elements[t].barAnim;(i===void 0||!i.effect||i.effect.target!==r)&&(i=r.animate([{transform:"scale(1)"},{transform:"scale(0, 1)"}],{duration:o.barTime,fill:"both"}),o.elements[t].barAnim=i);let s=o.millisOf(t);i.currentTime=o.barTime-s,t===o.times.activeColor?s>0&&i.play():i.pause()}else o.elements[t].bar=r,r.style.transform="scale("+o.timeRatio(o.millisOf(t))+",1)"};return c("div.bar",{class:{berserk:!!e.goneBerserk[t]},hook:{insert:r=>n(r.elm),postpatch:(r,i)=>n(i.elm)}})}function ir(e,t,o){if(t.time&&(t.time.innerHTML=rr(o,e.showTenths(o),!0,e.opts.nvui)),t.bar&&(t.bar.style.transform="scale("+e.timeRatio(o)+",1)"),t.clock){let n=t.clock.classList;o<e.emergMs?n.add("emerg"):n.contains("emerg")&&n.remove("emerg")}}var sr=(e,t)=>!!e.goneBerserk[t]&&e.data.game.turns<=1&&A(e.data),Ts=(e,t,o)=>sr(e,t)?c("div.berserked."+o,ie(xe)):null,Ss=e=>{if(Ze(e.data)&&!e.goneBerserk[e.data.player.color])return c("button.fbt.go-berserk",{attrs:{title:"GO BERSERK! Half the time, no increment, bonus point","data-icon":xe},hook:w("click",e.goBerserk)})},Rs=(e,t,o)=>{var i,s;let n=e.data,r=((i=n.tournament)==null?void 0:i.ranks)||((s=n.swiss)==null?void 0:s.ranks);return r&&!sr(e,t)&&c("div.tour-rank."+o,{attrs:{title:"Current tournament rank"}},"#"+r[t])};var lt=class{constructor(t,o){this.opts=o;this.emergSound={play:()=>site.sound.play("lowTime"),delay:2e4,playable:{white:!0,black:!0}};this.elements={white:{},black:{}};this.timeRatio=t=>Math.min(1,t*this.timeRatioDivisor);this.setClock=(t,o,n,r=0)=>{let i=A(t)&&(Ye(t)>1||t.clock.running),s=r*10;this.times={white:o*1e3,black:n*1e3,activeColor:i?t.game.player:void 0,lastUpdate:performance.now()+s},i&&this.scheduleTick(this.times[t.game.player],s)};this.addTime=(t,o)=>{this.times[t]+=o*10};this.stopClock=()=>{let t=this.times.activeColor;if(t){let o=this.elapsed();return this.times[t]=Math.max(0,this.times[t]-o),this.times.activeColor=void 0,o}};this.hardStopClock=()=>this.times.activeColor=void 0;this.scheduleTick=(t,o)=>{this.tickCallback!==void 0&&clearTimeout(this.tickCallback),this.tickCallback=setTimeout(this.tick,this.opts.nvui?1e3:t%(this.showTenths(t)?100:500)+1+o)};this.tick=()=>{this.tickCallback=void 0;let t=this.times.activeColor;if(t===void 0)return;let o=performance.now(),n=Math.max(0,this.times[t]-this.elapsed(o));this.scheduleTick(n,0),n===0?this.opts.onFlag():ir(this,this.elements[t],n),this.opts.soundColor===t&&(this.emergSound.playable[t]?n<this.emergMs&&!(o<this.emergSound.next)&&(this.emergSound.play(),this.emergSound.next=o+this.emergSound.delay,this.emergSound.playable[t]=!1):n>1.5*this.emergMs&&(this.emergSound.playable[t]=!0))};this.elapsed=(t=performance.now())=>Math.max(0,t-this.times.lastUpdate);this.millisOf=t=>this.times.activeColor===t?Math.max(0,this.times[t]-this.elapsed()):this.times[t];this.isRunning=()=>this.times.activeColor!==void 0;this.speak=()=>{let t=["white","black"].map(o=>{let n=this.millisOf(o),r=new Date(n),i=(n>=36e5?Qt(Math.floor(n/36e5),"hour"):"")+" "+Qt(r.getUTCMinutes(),"minute")+" "+Qt(r.getUTCSeconds(),"second");return`${o} ${i}`});site.sound.say(t.join(". "))};let n=t.clock;if(n.showTenths===Bt.Never)this.showTenths=()=>!1;else{let r=n.showTenths===Bt.Below10Secs?1e4:36e5;this.showTenths=i=>i<r}this.showBar=n.showBar&&!this.opts.nvui,this.barTime=1e3*(Math.max(n.initial,2)+5*n.increment),this.timeRatioDivisor=1/this.barTime,this.emergMs=1e3*Math.min(60,Math.max(10,n.initial*.125)),this.setClock(t,n.white,n.black)}};function Qt(e,t){return`${e} ${t}${e!=1?"s":""}`}var ct=class{constructor(t,o,n){this.root=t;this.data=o;this.onFlag=n;this.timePercent=t=>Math.max(0,Math.min(100,this.times[t]*this.timePercentDivisor));this.update=(t,o)=>{this.times={white:t*1e3,black:o*1e3,lastUpdate:performance.now()}};this.tick=t=>{let o=performance.now();this.times[t]-=o-this.times.lastUpdate,this.times.lastUpdate=o,this.times[t]<=0&&this.onFlag()};this.millisOf=t=>Math.max(0,this.times[t]);this.timePercentDivisor=.1/o.increment,this.update(o.white,o.black)}};var _e=class{constructor(t,o){this.ctrl=t;this.key=o;this.storage=site.storage.boolean(this.key);this.toggle=()=>{this.storage.toggle(),this.next(!0)};this.get=this.storage.get;this.redirect=t=>{this.ctrl.setRedirecting(),window.location.href=t};this.next=t=>{let o=this.ctrl.data;o.player.spectator||!yn(o)||z(o)||!this.get()||(t?this.redirect("/round-next/"+o.game.id):o.simul?o.simul.hostId===this.ctrl.opts.userId&&o.simul.nbPlaying>1&&this.redirect("/round-next/"+o.game.id):An(this.ctrl).then(n=>{n.next&&this.redirect("/"+n.next)}))}}};var Be=class{constructor(t){this.socket=t;this.current=void 0;this.register=()=>{this.current=setTimeout(this.expire,1e4)};this.clear=()=>{this.current&&clearTimeout(this.current)};this.expire=()=>{W("/statlog?e=roundTransientExpire",{method:"post"}),this.socket.reload()}}};function ar(e,t){let o=[],n=new Map,r=J(t),i=Math.max(0,r[0]-1),s=Math.min(7,r[0]+1),a=Math.max(0,r[1]-1),l=Math.min(7,r[1]+1);for(let u=i;u<=s;u++)for(let p=a;p<=l;p++){let m=Ee([u,p]);o.push(m);let k=e.chessground.state.pieces.get(m);k&&(m===t||k.role!=="pawn")&&n.set(m,void 0)}e.chessground.setPieces(n),e.chessground.explode(o)}function Zt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function ut(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?Ee([n,r]):void 0}var dt=e=>e.orientation==="white";function cr(e,t,o,n){let r="a0";e.pieces.set(r,t),e.dom.redraw();let i=nt(o);e.draggable.current={orig:r,piece:t,origPos:i,pos:i,started:!0,element:()=>Ns(e,r),originTarget:o.target,newPiece:!0,force:!!n,keyHasChanged:!1},ur(e)}function ur(e){requestAnimationFrame(()=>{var t;let o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);let n=e.pieces.get(o.orig);if(!n||!Kt(n,o.piece))eo(e);else if(!o.started&&ot(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let i=o.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),o.element=i}let r=e.dom.bounds();Cn(o.element,[o.pos[0]-r.left-r.width/16,o.pos[1]-r.top-r.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==ut(o.pos,dt(e),r))}ur(e)})}function eo(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,Zt(e),Os(e),e.dom.redraw())}function Os(e){let t=e.dom.elements;t.ghost&&Mn(t.ghost,!1)}function Ns(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}function dr(e,t){e.dropmode={active:!0,piece:t},eo(e)}function fr(e){e.dropmode={active:!1}}var to=["pawn","knight","bishop","rook","queen"];function pr(e,t){if(t.button!==void 0&&t.button!==0||e.replaying()||!e.isPlaying())return;let o=t.target,n=o.getAttribute("data-role"),r=o.getAttribute("data-color"),i=o.getAttribute("data-nb");!n||!r||i==="0"||(t.stopPropagation(),t.preventDefault(),cr(e.chessground.state,{color:r,role:n},t))}var mr=!1,hr=!1,gr=!1;function ft(e,t,o){if(I.length===0?hr=!0:(mr=!0,gr||yr(e)),!z(e)||t==="pawn"&&(o[1]==="1"||o[1]==="8"))return!1;let n=e.possibleDrops;if(typeof n=="undefined"||n===null)return!0;let r=n.match(/.{2}/g);return(r==null?void 0:r.includes(o))===!0}function vr(){let e=site.storage.make("crazyKeyHist");if(mr)e.set(10);else if(hr){let t=parseInt(e.get());t>0&&t<=10?e.set(t-1):t!==0&&e.set(3)}}var I=[];function br(e){let t=site.mousetrap,o,n=()=>{if(o&&document.body.classList.remove(o),I.length>0){let i=to[I[I.length-1]-1],s=e.data.player.color,a=e.data.crazyhouse;if(!a)return;let l=a.pockets[s==="white"?0:1][i];dr(e.chessground.state,l>0?{color:s,role:i}:void 0),o=`cursor-${s}-${i}`,document.body.classList.add(o)}else fr(e.chessground.state),o=void 0};site.pubsub.on("ply",()=>{I.length>0&&n()});for(let i=1;i<=5;i++){let s=i.toString();t.bind(s,()=>{I.includes(i)||(I.push(i),n())}).bind(s,()=>{let a=I.indexOf(i);a>=0&&(I.splice(a,1),a===I.length&&n())},"keyup")}let r=()=>{I.length>0&&(I.length=0,n())};window.addEventListener("blur",r),window.addEventListener("focus",i=>{i.target&&i.target.localName==="input"&&r()},{capture:!0}),site.storage.get("crazyKeyHist")!=="0"&&yr(e.data)}function yr(e){let t=e.player.color[0];for(let o of"PNBRQ")fetch(site.asset.url(`piece/cburnett/${t}${o}.svg`));gr=!0}var pt=["queen","knight","rook","bishop"];function be(e,t,o){let n=e.state.pieces.get(t);n&&n.role=="pawn"&&e.setPieces(new Map([[t,{color:n.color,role:o,promoted:!0}]]))}var mt=class{constructor(t,o,n,r=tt.Never){this.withGround=t,this.onCancel=o,this.redraw=n,this.autoQueenPref=r,this.start=(i,s,a,l,u=!1)=>this.withGround(p=>{let m=p.state.pieces.get(i),k=m||p.state.pieces.get(s);return(k==null?void 0:k.role)=="pawn"&&(s[1]=="8"&&p.state.turnColor=="black"||s[1]=="1"&&p.state.turnColor=="white")?this.prePromotionRole&&(l!=null&&l.premove)?(this.doPromote({orig:i,dest:s,hooks:a},this.prePromotionRole),!0):!(l!=null&&l.ctrlKey)&&!this.promoting&&(this.autoQueenPref===tt.Always||this.autoQueenPref===tt.OnPremove&&m||u)?(m?this.setPrePromotion(s,"queen"):this.doPromote({orig:i,dest:s,hooks:a},"queen"),!0):(this.promoting={orig:i,dest:s,pre:!!m,hooks:a},this.redraw(),!0):!1})||!1,this.cancel=()=>{this.cancelPrePromotion(),this.promoting&&(this.promoting=void 0,this.onCancel(),this.redraw())},this.cancelPrePromotion=()=>{var i,s,a;(a=(i=this.promoting)===null||i===void 0?void 0:(s=i.hooks).show)===null||a===void 0||a.call(s,this,!1),this.prePromotionRole&&(this.withGround(l=>l.setAutoShapes([])),this.prePromotionRole=void 0,this.redraw())},this.view=i=>{var s,a;let l=this.promoting;if(l)return(a=(s=l.hooks).show)===null||a===void 0||a.call(s,this,i?[...pt,"king"]:pt),this.withGround(u=>this.renderPromotion(l.dest,i?pt.concat("king"):pt,j(u.state.turnColor),u.state.orientation))||null}}finish(t){var o,n;let r=this.promoting;r&&(this.promoting=void 0,r.pre?this.setPrePromotion(r.dest,t):this.doPromote(r,t),(n=(o=r.hooks).show)===null||n===void 0||n.call(o,this,!1),this.redraw())}doPromote(t,o){this.withGround(n=>be(n,t.dest,o)),t.hooks.submit(t.orig,t.dest,o)}setPrePromotion(t,o){this.prePromotionRole=o,this.withGround(n=>n.setAutoShapes([{orig:t,piece:{color:j(n.state.turnColor),role:o,opacity:.8},brush:""}]))}renderPromotion(t,o,n,r){let i=(7-J(t)[0])*12.5;return r==="white"&&(i=87.5-i),h("div#promotion-choice."+(n===r?"top":"bottom"),{hook:D(a=>{a.addEventListener("click",this.cancel),a.oncontextmenu=()=>!1})},o.map((a,l)=>{let u=(n===r?l:7-l)*12.5;return h("square",{attrs:{style:"top: "+u+"%;left: "+i+"%"},hook:w("click",p=>{p.stopPropagation(),this.finish(a)})},[h("piece."+a+"."+n)])}))}};var _s=[8,1,-8,-1],Bs=[9,-9,7,-7],lu=_s.concat(Bs);function wr(e){return site.asset.loadEsm("keyboardMove",{init:e})}var Ie=class{constructor(){this.keys=[],this.oks=0,this.kos=0,this.prev="",this.press=t=>{let o=t.target.value;o!=this.prev&&(this.prev=o,t.key.length==1?this.keys.push(t.key):o==""?this.clear():t.key=="Enter"&&o.length>1&&(o.split("").every(n=>this.keys.includes(n))?this.oks++:(this.kos++,this.kos==9&&this.kos>this.oks&&site.pubsub.emit("ab.rep","kbc"))))},this.clear=()=>{this.keys=[]}}};var xr={P:"pawn",N:"knight",B:"bishop",R:"rook",Q:"queen",K:"king"};function Cr(e){var t,o;let n=ce(!1,e.redraw),r=ce(!1,e.redraw),i,s,a=performance.now(),l,u=m=>{l.state.selected===m?l.cancelMove():(l.selectSquare(m,!0),a=performance.now())},p=!1;return{drop(m,k){let R=xr[k],d=e.data.crazyhouse,g=e.data.player.color;!e.crazyValid||!e.sendNewPiece||!R||!d||l.state.pieces.has(m)||d.pockets[g==="white"?0:1][R]&&e.crazyValid(R,m)&&(l.cancelMove(),l.newPiece({role:R,color:g},m),e.sendNewPiece(R,m,!1))},promote(m,k,R){let d=xr[R],g=e.data.game.variant.key;!d||d=="pawn"||d=="king"&&g!=="antichess"||(l.cancelMove(),be(l,k,d),e.auxMove(m,k,d))},update(m){m.cg&&(l=m.cg),i?i(m.fen,l.state.movable.dests,m.canMove):s=m.fen},registerHandler(m){i=m,s&&i(s,l.state.movable.dests)},san(m,k){p=!0,l.cancelMove(),u(m),u(k),l.cancelMove()},select:u,hasSelected:()=>l.state.selected,confirmMove:()=>e.submitMove?e.submitMove(!0):null,usedSan:p,jump(m){e.userJumpPlyDelta&&e.userJumpPlyDelta(m),e.redraw()},justSelected:()=>performance.now()-a<500,draw:()=>e.offerDraw?e.offerDraw(!0,!0):null,resign:(m,k)=>e.resign?e.resign(m,k):null,next:()=>{var m;return(m=e.nextPuzzle)===null||m===void 0?void 0:m.call(e)},vote:m=>{var k;return(k=e.vote)===null||k===void 0?void 0:k.call(e,m)},helpModalOpen:r,isFocused:n,checker:e.speakClock?new Ie:void 0,opponent:(o=(t=e.data.opponent)===null||t===void 0?void 0:t.user)===null||o===void 0?void 0:o.username,speakClock:e.speakClock,goBerserk:e.goBerserk}}function Mr(e){return h("div.keyboard-move",[h("input",{attrs:{spellcheck:"false",autocomplete:"off"},hook:D(t=>wr({input:t,ctrl:e}).then(o=>e.registerHandler(o)))}),e.isFocused()?h("em","Enter SAN (Nc3), ICCF (2133) or UCI (b1c3) moves, type ? to learn more"):h("strong","Press <enter> to focus"),e.helpModalOpen()?site.dialog.snab({class:"help.keyboard-move-help",htmlUrl:"/help/keyboard-move",onClose:()=>e.helpModalOpen(!1)}):null])}function Pr(e,t,o,n){let r="analyse."+e,i;return function(s){if(U(s)&&s!=i)i=s,site.storage.set(e,n(s));else if(!U(i)){let a=site.storage.get(r);Ao(a)&&(site.storage.set(e,a),site.storage.remove(r));let l=site.storage.get(e);i=l===null?t:o(l)}return i}}var Hs=(e,t)=>Pr(e,t,o=>o,o=>o),oo=(e,t)=>Pr(e,t,o=>o==="true",o=>o.toString()),Tr=(e,t,o)=>Mt(Hs(e,t),o),no=(e,t,o)=>Mt(oo(e,t),o);function io(e,t,o){var n,r;return c(`div#voice-bar${o?"."+o:""}`,[c("div#voice-status-row",[c("button#microphone-button",{hook:D(i=>i.addEventListener("click",()=>e.toggle()))}),c("span#voice-status",{hook:D(i=>site.mic.setController(zs(e,i)))}),c("button#voice-help-button",{attrs:{"data-icon":Ue,title:"Voice help"},hook:w("click",()=>e.showHelp(!0),void 0,!1)}),c("button#voice-settings-button",{attrs:{"data-icon":No,title:"Voice settings"},class:{active:e.showPrefs()},hook:w("click",()=>e.showPrefs.toggle(),t,!1)})]),e.showPrefs()&&c("div#voice-settings",{hook:D(We(()=>e.showPrefs(!1)))},[Fs(e,t),Ws(e),...(r=(n=e.module())===null||n===void 0?void 0:n.prefNodes(t))!==null&&r!==void 0?r:[],qs(e)]),e.showHelp()&&Ks(e)])}function Dr(){let e=$as("#voice-status-row");e.classList.add("flash"),e.onanimationend=()=>e.classList.remove("flash")}function zs(e,t){let o=$("button#microphone-button");return(n,r)=>{let i=[];i.push(["listening",site.mic.isListening]),i.push(["busy",site.mic.isBusy]),i.push(["push-to-talk",e.pushTalk()&&!site.mic.isListening&&!site.mic.isBusy]),i.map(([s,a])=>a?o.addClass(s):o.removeClass(s)),o.attr("data-icon",site.mic.isBusy?jo:Vo),r!=="partial"&&(t.innerText=n)}}function qs(e){return c("div.voice-setting",{attrs:{style:"align-self: center"}},[c("div.switch",{attrs:{title:"Hold the shift key while speaking"}},[c("input#wake-mode.cmn-toggle",{attrs:{type:"checkbox",checked:e.pushTalk()},hook:w("change",t=>e.pushTalk(t.target.checked))}),c("label",{attrs:{for:"wake-mode"}})]),c("label",{attrs:{for:"wake-mode"}},["Push ",c("strong","shift")," key to talk"])])}function Ws(e){return ro.length>1&&c("div.voice-setting",[c("label",{attrs:{for:"voice-lang"}},"Language"),c("select#voice-lang",{attrs:{name:"lang"},hook:w("change",t=>e.lang(t.target.value))},[...ro.map(t=>c("option",{attrs:t[0]===e.lang()?{value:t[0],selected:""}:{value:t[0]}},t[1]))])])}var Lr={deviceId:"null",label:"None selected",groupId:"",kind:"audioinput",toJSON:()=>"[]"},Rr=[Lr];function Fs(e,t){return c("div.voice-setting",[c("label",{attrs:{for:"voice-mic"}},"Microphone"),c("select#voice-mic",{hook:D(o=>{o.addEventListener("change",()=>e.micId(o.value)),site.mic.getMics().then(n=>{Rr=n.length?n:[Lr],t()})})},Rr.map(o=>c("option",{attrs:{value:o.deviceId,selected:o.deviceId===e.micId()}},o.label)))])}function Ks(e){let t=o=>{var n,r,i;let s='<table class="big-table"><tbody>',a=(i=(r=(n=e.module())===null||n===void 0?void 0:n.allPhrases())===null||r===void 0?void 0:r.sort((p,m)=>p[0].localeCompare(m[0])))!==null&&i!==void 0?i:[],l=Math.min(3,Math.ceil(window.innerWidth/399)),u=Math.ceil(a.length/l);for(let p=0;p<u;p++){s+="<tr>";for(let m=p;m<a.length;m+=u)s+=`<td>${a[m][0]}</td><td>${a[m][1]}</td>`;s+="</tr>"}s+="</tbody></table>",o.view.innerHTML=s,o.open||o.showModal()};return site.dialog.snab({class:"help.voice-move-help",htmlUrl:`/help/voice/${e.moduleId}`,css:[{themed:"voiceMove.help"}],onClose:()=>e.showHelp(!1),onInsert:async o=>{if(e.showHelp()==="list"){t(o);return}let n=e.moduleId==="coords"?[]:await Tt(site.asset.url(`compiled/grammar/${e.moduleId}-${e.lang()}.json`)),r=(i,s)=>{var a;return(a=n.entries.find(l=>{var u,p;return((u=l.val)!==null&&u!==void 0?u:l.tok)===i&&(!s||((p=l.tags)===null||p===void 0?void 0:p.includes("phonetic")))}))===null||a===void 0?void 0:a.in};$(".val-to-word",o.view).each(function(){let i=s=>this.classList.contains("phonetic")&&r(s,!0)||r(s,!1);this.innerText=this.innerText.split(",").map(s=>i(s)).join(" ")}),$(".all-phrases-button",o.view).on("click",()=>t(o)),o.showModal()}})}function Ar(e,t,o){let n="abset-"+e.id;return h("div.setting."+n+(e.cls?"."+e.cls:""),e.title?{attrs:{title:t.noarg(e.title)}}:{},[h("div.switch",[h("input#"+n+".cmn-toggle",{attrs:{type:"checkbox",checked:e.checked,disabled:!!e.disabled},hook:w("change",r=>e.change(r.target.checked),o)}),h("label",{attrs:{for:n}})]),h("label",{attrs:{for:n}},t.noarg(e.name))])}var so=(e,t,o=site.reload)=>Y(t,async n=>{await W(`/pref/${e}`,{method:"post",body:Ke({[e]:n?"1":"0"})}),o()});function ao(e,t){let o,n=Er({redraw:e.redraw,module:()=>o,tpe:"move"});return site.asset.loadEsm("voice.move",{init:{root:e,ui:n,initial:t}}).then(r=>o=r),{ui:n,initGrammar:()=>o==null?void 0:o.initGrammar(),update:r=>o==null?void 0:o.update(r),listenForResponse:(r,i)=>o==null?void 0:o.listenForResponse(r,i),question:()=>o==null?void 0:o.question(),promotionHook:()=>o==null?void 0:o.promotionHook(),allPhrases:()=>o==null?void 0:o.allPhrases(),prefNodes:()=>o==null?void 0:o.prefNodes()}}var ro=[["en","English"]];function Er(e){function t(){r()?(n(!1),r(!1)):n(!n())?site.mic.start():site.mic.stop(),e.tpe==="move"&&site.once("voice.rtfm")&&s(!0)}function o(l){return l&&site.mic.setMic(l),site.mic.micId}let n=oo("voice.on",!1),r=no("voice.pushTalk",!1,l=>{site.mic.stop(),n(l),n()&&site.mic.start(!l)}),i=Tr("voice.lang","en",l=>{var u;l!==site.mic.lang&&(site.mic.setLang(l),(u=e.module)===null||u===void 0||u.call(e).initGrammar().then(()=>{n()&&site.mic.start(!r())}))}),s=ce(!1,e.redraw),a;return document.addEventListener("keydown",l=>{l.key!=="Shift"||!r()||(site.mic.start(),clearTimeout(a))}),document.addEventListener("keyup",l=>{l.key!=="Shift"||!r()||(clearTimeout(a),a=setTimeout(()=>site.mic.stop(),600))}),site.mic.setLang(i()),r()?site.mic.start(!1):n()&&site.mic.start(!0),{lang:i,micId:o,enabled:n,toggle:t,showHelp:s,pushTalk:r,flash:Dr,showPrefs:Y(!1,e.redraw),module:()=>{var l;return(l=e.module)===null||l===void 0?void 0:l.call(e)},moduleId:e.tpe}}var $r=e=>h("a",{class:{"user-link":!0,ulpt:e.name!="ghost",online:!!e.online},attrs:{href:`/@/${e.name}`,...e.attrs}},[Ys(e),...Js(e),e.rating&&` ${Qs(e)} `]),Vs=e=>e.flair?h("img.uflair",{attrs:{src:site.asset.flairSrc(e.flair)}}):void 0,Ys=e=>e.line!==!1?h("i.line",{class:{patron:!!e.patron,moderator:!!e.moderator},attrs:e.patron?{title:"Lichess Patron"}:{}}):void 0,Xs=e=>e.title?h("span.utitle",e.title=="BOT"?{attrs:{"data-bot":!0}}:{},[e.title,"\xA0"]):void 0,Js=e=>[Xs(e),e.name,Vs(e)],Qs=e=>{if(e.rating){let t=`${e.rating}${e.provisional?"?":""}`;return e.brackets!==!1?`(${t})`:t}},Or=e=>e.ratingDiff===0?h("span","\xB10"):e.ratingDiff&&e.ratingDiff>0?h("good","+"+e.ratingDiff):e.ratingDiff&&e.ratingDiff<0?h("bad","\u2212"+-e.ratingDiff):void 0;var lo=(e,t)=>e.trans("aiNameLevelAiLevel","Stockfish",t);function Nr(e,t,o){var u;let n=e.data,r=t.user,i=((r==null?void 0:r.perfs)||{})[n.game.perf],s=t.rating||(i==null?void 0:i.rating),a=(r==null?void 0:r.id)===((u=n.opponent.user)==null?void 0:u.id)?n.opponentSignal:void 0;if(r){let p=!t.onGame&&e.firstSeconds&&r.online;return c(`div.ruser-${o}.ruser.user-link`,{class:{online:t.onGame,offline:!t.onGame,long:r.username.length>16,connecting:p}},[c("i.line"+(r.patron?".patron":""),{attrs:{title:p?"Connecting to the game":t.onGame?"Joined the game":"Left the game"}}),$r({name:r.username,...r,attrs:{"data-pt-pos":"s",...e.isPlaying()?{target:"_blank",rel:"noopener"}:{}},online:!1,line:!1}),!!a&&Zs(a),!!s&&c("rating",s+(t.provisional?"?":"")),!!s&&Or(t),t.engine&&c("span",{attrs:{"data-icon":Go,title:e.noarg("thisAccountViolatedTos")}})])}let l=!t.onGame&&e.firstSeconds;return c(`div.ruser-${o}.ruser.user-link`,{class:{online:t.onGame,offline:!t.onGame,connecting:l}},[c("i.line",{attrs:{title:l?"Connecting to the game":t.onGame?"Joined the game":"Left the game"}}),c("name",t.name||e.noarg("anonymous"))])}var Zs=e=>{let t=[];for(let o=1;o<=4;o++)t.push(c(o<=e?"i":"i.off"));return c("signal.q"+e,t)},_r=(e,t)=>t.user?(t.user.title?t.user.title+" ":"")+t.user.username:t.ai?lo(e,t.ai):e.noarg("anonymous");var Ir=!1,Hr=e=>e.split(" ")[0];function zr(e){var t;e.data.opponent.ai||((t=e.data.player.user)==null?void 0:t.title)!="BOT"&&(site.storage.fire("ceval.disable"),site.storage.make("ceval.fen").listen(o=>{let n=e.data,r=Et(e.data);!Ir&&r.ply>14&&e.isPlaying()&&o.value&&Hr(r.fen)===Hr(o.value)&&(W(`/jslog/${n.game.id}${n.player.id}?n=ceval`,{method:"post"}),Ir=!0)}))}function qr(e,t){e.opponent.ai&&site.storage.fire("ceval.fen",t.fen)}var co=e=>e.userJump(e.ply-1),uo=e=>e.userJump(e.ply+1),Wr=e=>site.mousetrap.bind(["left","k"],()=>{co(e),e.redraw()}).bind(["right","j"],()=>{uo(e),e.redraw()}).bind(["up","0","home"],()=>{e.userJump(0),e.redraw()}).bind(["down","$","end"],()=>{e.userJump(e.data.steps.length-1),e.redraw()}).bind("f",e.flipNow).bind("z",()=>site.pubsub.emit("zen")).bind("B",()=>e.blindfold(!e.blindfold())).bind("?",()=>{e.keyboardHelp=!e.keyboardHelp,e.redraw()}),Fr=e=>site.dialog.snab({class:"help",htmlUrl:"/round/help",onClose(){e.keyboardHelp=!1,e.redraw()}});var fo=["touchend","pointerup","pointerdown","mousedown","keydown"],q=null,ht=!1;function Ur(){ht=!0,po()}function Gr(){ht=!1,q==null||q.release().catch(()=>{}),q=null}function jr(){!q&&ht&&po()}function po(){var e;(e=navigator.wakeLock)===null||e===void 0||e.request("screen").then(t=>{q=t,fo.forEach(o=>window.removeEventListener(o,jr,{capture:!0})),fo=[]}).catch(()=>q=null)}fo.forEach(e=>window.addEventListener(e,jr,{capture:!0}));document.addEventListener("visibilitychange",()=>{ht&&(!q||q.released)&&document.visibilityState==="visible"?po():document.visibilityState==="hidden"&&(q==null||q.release().catch(()=>{}),q=null)});var oa=["mousedown","touchstart"];function gt(e,t,o){let n=fe(e.data,e.ply);if(!n.crazy)return;let r=e.justDropped,i=e.preDrop,s=n.crazy.pockets[t==="white"?0:1],a=o===(e.flip?"top":"bottom"),l=a&&!e.replaying()&&e.isPlaying(),u=t===e.data.player.color,p=e.justCaptured,m=p&&(p.promoted?"pawn":p.role);return h("div.pocket.is2d.pocket-"+o,{class:{usable:l},hook:D(k=>oa.forEach(R=>k.addEventListener(R,d=>{o===(e.flip?"top":"bottom")&&I.length==0&&pr(e,d)})))},to.map(k=>{let R=s[k]||0;return u&&(r===k&&R--,m===k&&R++),h("div.pocket-c1",h("div.pocket-c2",h("piece."+k+"."+t,{class:{premove:u&&i===k},attrs:{"data-role":k,"data-color":t,"data-nb":R}})))}))}function Vr(e){let t=0;return o=>{t+=o.deltaY*(o.deltaMode?40:1),Math.abs(t)>=4?(e(o,!0),t=0):e(o,!1)}}var Qd=ue(()=>{let e=document.createElement("div");e.style.position="absolute",e.style.overflow="scroll",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t});var mo=(e,t)=>(e/Math.pow(10,t)).toFixed(t).slice(2),vt=e=>`<b>${e}</b>`;function na(e,t){let o=new Date(t),n=mo(o.getUTCMinutes(),2),r=mo(o.getSeconds(),2),i,s="";if(t>=86400*1e3){let a=o.getUTCDate()-1;i=o.getUTCHours(),s+=(a===1?e("oneDay"):e.pluralSame("nbDays",a))+" ",i!==0&&(s+=e.pluralSame("nbHours",i))}else t>=3600*1e3?(i=o.getUTCHours(),s+=vt(mo(i,2))+":"+vt(n)):s+=vt(n)+":"+vt(r);return s}function Yr(e,t,o,n,r){let i=e.millisOf(o),s=u=>{u.innerHTML=na(t,i)},a=e.root.data.player.color===o,l=document.dir=="rtl"&&i<86400*1e3?"ltr":void 0;return c("div.rclock.rclock-correspondence.rclock-"+n,{class:{outoftime:i<=0,running:r===o}},[e.data.showBar&&c("div.bar",[c("span",{attrs:{style:`width: ${e.timePercent(o)}%`}})]),c("div.time",{attrs:l&&{style:`direction: ${l}`},hook:{insert:u=>s(u.elm),postpatch:(u,p)=>s(p.elm)}}),!a&&at(e.root)])}var ye="init";function He(){return typeof ye=="string"&&(ye=="init"&&(window.addEventListener("resize",()=>{ye="rec"}),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame(()=>{ye="rec"})),ye=!!window.getComputedStyle(document.body).getPropertyValue("--col1")),ye}var ho=(e,t)=>o=>{for(let n of["touchstart","mousedown"])o.addEventListener(n,r=>{e(r),r.preventDefault(),t&&t()},{passive:!1})};var ra=()=>(navigator==null?void 0:navigator.maxTouchPoints)>2&&/iPad|Macintosh/.test(navigator.userAgent);var uf=ue(()=>{let e=[];if(typeof WebAssembly=="object"&&typeof WebAssembly.validate=="function"&&WebAssembly.validate(Uint8Array.from([0,97,115,109,1,0,0,0]))&&(e.push("wasm"),ia())){e.push("sharedMem");let t=Uint8Array.from([0,97,115,109,1,0,0,0,1,12,2,96,2,123,123,1,123,96,1,123,1,123,3,3,2,0,1,7,9,2,1,97,0,0,1,98,0,1,10,19,2,9,0,32,0,32,1,253,186,1,11,7,0,32,0,253,253,1,11]);WebAssembly.validate(t)&&e.push("simd")}return Object.freeze(e)}),df=ue(()=>/iPhone|iPod/.test(navigator.userAgent)||ra()),ff=ue(()=>window.matchMedia("(hover: hover) and (pointer: fine)").matches);function ia(){if(typeof Atomics!="object"||typeof SharedArrayBuffer!="function")return!1;let e;try{if(e=new WebAssembly.Memory({shared:!0,initial:1,maximum:2}),!(e.buffer instanceof SharedArrayBuffer))return!1;window.postMessage(e.buffer,"*")}catch(t){return!1}return e.buffer instanceof SharedArrayBuffer}var bt=(e,t)=>h("button.fbt.board-menu-toggle",{class:{active:e()},attrs:{title:t,"data-icon":Ko},hook:D(ho(e.toggle))}),Xr=(e,t,o,n)=>o()?h("div.board-menu",{hook:D(We(()=>o(!1)))},n(new go(e,t))):void 0,go=class{constructor(t,o){this.trans=t,this.redraw=o,this.anonymous=document.querySelector("body[data-user]")===null,this.flip=(n,r,i)=>h("button.button.text",{class:{active:r},attrs:{title:"Hotkey: f",...Xo(Bo)},hook:D(ho(i))},n),this.zenMode=(n=!0)=>this.cmnToggle({name:"Zen mode",id:"zen",checked:$("body").hasClass("zen"),change:()=>site.pubsub.emit("zen"),disabled:!n}),this.voiceInput=(n,r=!0)=>this.cmnToggle({name:"Voice input",id:"voice",checked:n(),change:n,title:this.anonymous?"Must be logged in":"",disabled:this.anonymous||!r}),this.keyboardInput=(n,r=!0)=>this.cmnToggle({name:"Keyboard input",id:"keyboard",checked:n(),change:n,title:this.anonymous?"Must be logged in":"",disabled:this.anonymous||!r}),this.blindfold=(n,r=!0)=>this.cmnToggle({name:"Blindfold",id:"blindfold",checked:n(),change:n,disabled:!r}),this.confirmMove=(n,r=!0)=>this.cmnToggle({name:"Confirm move",id:"confirmmove",checked:n(),change:n,disabled:!r}),this.cmnToggle=n=>Ar(n,this.trans,this.redraw)}};function Jr(e){return Xr(e.trans,e.redraw,e.menu,t=>{let o=e.data,n=o.player.spectator;return[h("section",[t.flip(e.noarg("flipBoard"),e.flip,e.flipNow)]),h("section",[t.zenMode(!0),t.blindfold(Y(e.blindfold(),r=>e.blindfold(r)),!n),t.voiceInput(so("voice",!!e.voiceMove),!n),t.keyboardInput(so("keyboardMove",!!e.keyboardMove),!n),!n&&o.pref.submitMove?t.confirmMove(e.confirmMoveEnabled):void 0]),h("section.board-menu__links",[h("a",{attrs:{target:"_blank",href:"/account/preferences/display"}},"Game display preferences"),h("a",{attrs:{target:"_blank",href:"/account/preferences/game-behavior "}},"Game behavior preferences")])]})}var Qr=99999,vo="kwdb",ti="i5z",sa=ti.toUpperCase(),aa="l4x",la="rm6",ca=ge(100,(e,t)=>window.requestAnimationFrame(()=>{if(t.data.steps.length<7)return;let o;if(t.ply<3)o=0;else if(t.ply==ee(t.data))o=Qr;else{let n=e.querySelector(".a1t");n&&(o=He()?n.offsetLeft-e.offsetWidth/2+n.offsetWidth/2:n.offsetTop-e.offsetHeight/2+n.offsetHeight/2)}typeof o=="number"&&(o==Qr?e.scrollLeft=e.scrollTop=o:He()?e.scrollLeft=o:e.scrollTop=o)})),ua=()=>c("draw",{attrs:{title:"Draw offer"}},"\xBD?"),Zr=(e,t,o,n)=>e?c(vo,{class:{a1t:e.ply===t}},[e.san[0]==="P"?e.san.slice(1):e.san,n.has(e.ply)?ua():void 0]):o&&c(vo,"\u2026");function oi(e){let t;if(H(e.data))switch(e.data.game.winner){case"white":t="1-0";break;case"black":t="0-1";break;default:t="\xBD-\xBD"}if(t||F(e.data))return c("div.result-wrap",[c("p.result",t||""),c("p.status",{hook:D(()=>{e.autoScroll?e.autoScroll():setTimeout(()=>e.autoScroll(),200)})},Oe(e))])}function da(e){let t=e.data.steps,o=X(e.data),n=ee(e.data),r=Math.trunc(o/2)+1,i=new Set(e.data.game.drawOffers||[]);if(typeof n=="undefined")return[];let s=[],a=1;o%2===1&&(s.push([null,t[1]]),a=2);for(let p=a;p<t.length;p+=2)s.push([t[p],t[p+1]]);let l=[],u=e.ply;for(let p=0;p<s.length;p++)l.push(c(ti,p+r+"")),l.push(Zr(s[p][0],u,!0,i)),l.push(Zr(s[p][1],u,!1,i));return l.push(oi(e)),l}function bo(e){let t=e.data.forecastCount;return bn(e.data)&&c("a.fbt.analysis",{class:{text:!!t},attrs:{title:e.noarg("analysis"),href:ae(e.data,e.data.player.color)+"/analysis#"+e.ply,"data-icon":_o}},t?[""+t]:[])}function fa(e){let t=e.data,o=X(t),n=ee(t);return c("div.buttons",{hook:w("mousedown",r=>{let i=r.target,s=parseInt(i.getAttribute("data-ply")||"");isNaN(s)||e.userJump(s)},e.redraw)},[bo(e)||c("div.noop"),...[[Wo,o],[Dt,e.ply-1],[Rt,e.ply+1],[qo,n]].map((r,i)=>{let s=e.ply!==r[1]&&r[1]>=o&&r[1]<=n;return c("button.fbt",{class:{glowing:i===3&&e.isLate()},attrs:{disabled:!s,"data-icon":r[0],"data-ply":s?r[1]:"-"}})}),bt(e.menu,e.noarg("menu"))])}function pa(e){let t=e.data;return(e.replayEnabledByPref()||!He())&&A(t)&&t.game.turns===0&&!t.player.spectator&&c("div.message",ie(Ue),[c("div",[e.trans(t.player.color==="white"?"youPlayTheWhitePieces":"youPlayTheBlackPieces"),...t.player.color==="white"?[c("br"),c("strong",e.trans("itsYourTurn"))]:[]])])}var ei=(e,t,o,n)=>c("button.fbt",{attrs:{disabled:n,"data-icon":o,"data-ply":e.ply+t},hook:w("mousedown",r=>{r.preventDefault(),e.userJump(e.ply+t),e.redraw()})});function yo(e){let t=e.data,o=e.replayEnabledByPref()&&c(aa,{hook:D(r=>{r.addEventListener("mousedown",i=>{let s=i.target,a=-2;if(s.tagName===vo.toUpperCase()){for(;s=s.previousSibling;)if(a++,s.tagName===sa){e.userJump(2*parseInt(s.textContent||"")+a),e.redraw();break}}}),e.autoScroll=()=>ca(r,e),e.autoScroll()})},da(e)),n=o||oi(e);return!e.nvui&&c(la,[fa(e),Jr(e),pa(e)||(He()?c("div.col1-moves",[ei(e,-1,Dt,e.ply==X(t)),n,ei(e,1,Rt,e.ply==ee(t))]):n)])}var ni=!1;function ri(e){let t=A(e.data)&&e.data.expiration;if(!t)return;let o=Math.max(0,t.movedAt-Date.now()+t.millisToMove),n=Math.floor(o/1e3),r=z(e.data),i=r&&o<8e3;!ni&&i&&(site.sound.play("lowTime"),ni=!0);let s=r!=e.flip?"bottom":"top";return h("div.expiration.expiration-"+s,{class:{emerg:i,"bar-glider":r}},e.trans.vdomPlural("nbSecondsToPlayTheFirstMove",n,h("strong",""+n)))}function ii(e,t){let o=e.playerAt(t);return e.nvui?void 0:o.ai?c("div.user-link.online.ruser.ruser-"+t,[c("i.line"),c("name",lo(e,o.ai))]):Nr(e,o,t)}var ko=e=>e.loading||e.redirecting,wo=()=>c("i.ddloader"),ai=(e,t)=>[yo(e),t.find(o=>!!o)&&c("div.rcontrols",t)],ha=e=>ai(e,[ko(e)?wo():Xn(e)||Jn(e)||Qn(e)]),ga=e=>ai(e,[ko(e)?wo():A(e.data)?void 0:Zn(e)]),va=e=>{let t=e.question();if(!t)return{};let o=(i,s,a,l)=>e.nvui?c("button",{hook:w("click",l)},e.noarg(a)):c(`a.${i}`,{attrs:{"data-icon":s},hook:w("click",l)}),n=t.no&&o("no",t.no.icon||de,t.no.key||"decline",t.no.action),r=t.yes&&o("yes",t.yes.icon||Io,t.yes.key||"accept",t.yes.action);return{promptVNode:c("div.question",{key:t.prompt},[n,c("p",t.prompt),r]),isQuestion:t.no!==void 0||t.yes!==void 0}},ba=e=>{let t=e.data,o=ko(e),{promptVNode:n,isQuestion:r}=va(e),i=o||r?[]:[Ot(t)?Ne(e,void 0,de,"abortGame","abort"):Ne(e,a=>({enabled:dn(a)}),Me,"proposeATakeback","takeback-yes",e.takebackYes),e.drawConfirm?jn(e):e.data.game.threefold?Vn(e,a=>{let l=Je(a);return{enabled:l,overrideHint:l?void 0:"noDrawBeforeSwissLimit"}}):Ne(e,a=>({enabled:e.canOfferDraw(),overrideHint:Je(a)?void 0:"noDrawBeforeSwissLimit"}),re,"offerDraw","draw-yes",()=>e.offerDraw(!0)),e.resignConfirm?Gn(e):Ne(e,a=>({enabled:Qe(a)}),Ce,"resign","resign",()=>e.resign(!0)),bo(e),bt(e.menu,e.noarg("menu"))],s=o?[wo()]:[n,Kn(e),Yn(e)];return[yo(e),c("div.rcontrols",[c("div.ricons",{class:{confirm:!!(e.drawConfirm||e.resignConfirm)}},i),...s])]};function ya(e,t,o){let n=e.data;if(!(H(n)||F(n)))return c("div.rclock.rclock-turn.rclock-"+o,n.game.player===t&&c("div.rclock-turn__text",n.player.spectator?e.trans(n.game.player+"Plays"):e.trans(n.game.player===n.player.color?"yourTurn":"waitingForOpponent")))}function si(e,t){let o=e.playerAt(t);return e.clock?nr(e,o,t):e.data.correspondence&&e.data.game.turns>1?Yr(e.corresClock,e.trans,o.color,t,e.data.game.player):ya(e,o.color,t)}var li=e=>[c("div.round__app__table"),ri(e),ii(e,"top"),...e.data.player.spectator?ga(e):A(e.data)?ba(e):ha(e),ii(e,"bottom"),si(e,"top"),si(e,"bottom")];var ka={p:"pawn",n:"knight",b:"bishop",r:"rook",q:"queen",k:"king"};function ci(e){let t={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};for(let o=0,n=0;o<e.length&&n<8;o++){let r=e[o],i=r.toLowerCase(),s=ka[i];if(s){let a=r==i?"black":"white",l=t[j(a)];l[s]>0?l[s]--:t[a][s]++}else{if(r=="["||r==" ")break;r=="/"&&n++}}return t}function ui(e){return(e.white.queen-e.black.queen)*9+(e.white.rook-e.black.rook)*5+(e.white.bishop-e.black.bishop)*3+(e.white.knight-e.black.knight)*3+(e.white.pawn-e.black.pawn)}var xo={white:0,black:0};function di(e,t){let o={...xo};for(let n of e){if(t<n.ply)break;n.check&&(n.ply%2===1?o.white++:o.black++)}return o}function fi(e,t,o,n){let r=[],i;for(i in e)if(e[i]>0){let s=[];for(let a=0;a<e[i];a++)s.push(h("mpiece."+i));r.push(h("div",s))}if(n)for(let s=0;s<n;s++)r.push(h("div",h("mpiece.king")));return t>0&&r.push(h("score","+"+t)),h("div.material.material-"+o,r)}function pi(e,t,o,n,r,i){let s=ci(e?o:""),a=ui(s)*(t==="white"?1:-1),l=n?di(r,i):xo,u=j(t);return[fi(s[u],-a,"top",l[u]),fi(s[t],a,"bottom",l[t])]}function Co(e){let t=e.data,o=t[e.flip?"player":"opponent"].color,n=t[e.flip?"opponent":"player"].color,r=pi(e.data.pref.showCaptured,e.flip?e.data.opponent.color:e.data.player.color,e.stepAt(e.ply).fen,!!(e.data.player.checks||e.data.opponent.checks),e.data.steps,e.ply),i=e.data.player.blindfold&&A(e.data);return e.nvui?e.nvui.render(e):c("div.round__app.variant-"+t.game.variant.key,[c("div.round__app__board.main-board"+(i?".blindfold":""),{hook:"ontouchstart"in window||!site.storage.boolean("scrollMoves").getOrDefault(!0)?void 0:w("wheel",Vr((s,a)=>{e.isPlaying()||(s.preventDefault(),s.deltaY>0&&a?uo(e):s.deltaY<0&&a&&co(e),e.redraw())}),void 0,!1)},[Sn(e),e.promotion.view(e.data.game.variant.key==="antichess")]),e.voiceMove&&io(e.voiceMove.ui,e.redraw),e.keyboardHelp&&Fr(e),gt(e,o,"top")||r[0],...li(e),gt(e,n,"bottom")||r[1],e.keyboardMove&&Mr(e.keyboardMove)])}function mi(){$("body").hasClass("zen-auto")&&$("body").hasClass("zen")&&($("body").toggleClass("zen"),window.dispatchEvent(new Event("resize")))}var ze=class{constructor(t,o,n){this.opts=t;this.redraw=o;this.nvui=n;this.firstSeconds=!0;this.flip=!1;this.confirmMoveEnabled=Y(!0);this.loading=!1;this.redirecting=!1;this.goneBerserk={};this.resignConfirm=void 0;this.drawConfirm=void 0;this.preventDrawOffer=void 0;this.autoScroll=()=>{};this.shouldSendMoveTime=!1;this.sign=Math.random().toString(36);this.keyboardHelp=location.hash==="#keyboard";this.showExpiration=()=>{this.data.expiration&&(this.redraw(),setTimeout(this.showExpiration,250))};this.onUserMove=(t,o,n)=>{var r;(r=this.keyboardMove)!=null&&r.usedSan||an(this,n),this.startPromotion(t,o,n)||this.sendMove(t,o,void 0,n)};this.onUserNewPiece=(t,o,n)=>{!this.replaying()&&ft(this.data,t,o)?this.sendNewPiece(t,o,!!n.predrop):this.jump(this.ply)};this.onMove=(t,o,n)=>{n||this.enpassant(t,o)?this.data.game.variant.key==="atomic"?(site.sound.play("explosion"),ar(this,o)):site.sound.move({name:"capture",filter:"game"}):site.sound.move({name:"move",filter:"game"})};this.startPromotion=(t,o,n)=>{var r,i;return this.promotion.start(t,o,{submit:(s,a,l)=>this.sendMove(s,a,l,n),show:(r=this.voiceMove)==null?void 0:r.promotionHook()},n,(i=this.keyboardMove)==null?void 0:i.justSelected())};this.onPremove=(t,o,n)=>this.startPromotion(t,o,n);this.onCancelPremove=()=>this.promotion.cancelPrePromotion();this.onNewPiece=(t,o)=>{t.role==="pawn"&&(o[1]==="1"||o[1]==="8")||site.sound.move()};this.onPredrop=(t,o)=>{this.preDrop=t,this.redraw()};this.isSimulHost=()=>this.data.simul&&this.data.simul.hostId===this.opts.userId;this.enpassant=(t,o)=>{var r;if(t[0]===o[0]||((r=this.chessground.state.pieces.get(o))==null?void 0:r.role)!=="pawn")return!1;let n=o[0]+t[1];return this.chessground.setPieces(new Map([[n,void 0]])),!0};this.lastPly=()=>ee(this.data);this.makeCgHooks=()=>({onUserMove:this.onUserMove,onUserNewPiece:this.onUserNewPiece,onMove:this.onMove,onNewPiece:this.onNewPiece,onPremove:this.onPremove,onCancelPremove:this.onCancelPremove,onPredrop:this.onPredrop});this.replaying=()=>this.ply!==this.lastPly();this.userJump=t=>{this.cancelMove(),this.chessground.selectSquare(null),t!=this.ply&&this.jump(t)?site.sound.saySan(this.stepAt(this.ply).san,!0):this.redraw()};this.userJumpPlyDelta=t=>this.userJump(this.ply+t);this.isPlaying=()=>pe(this.data);this.jump=t=>{t=Math.max(X(this.data),Math.min(this.lastPly(),t));let o=t===this.ply+1;this.ply=t,this.justDropped=void 0,this.preDrop=void 0;let n=this.stepAt(t),r={fen:n.fen,lastMove:$e(n.uci),check:!!n.check,turnColor:this.ply%2===0?"white":"black"};return this.replaying()?this.chessground.stop():r.movable={color:this.isPlaying()?this.data.player.color:void 0,dests:Pe(this.data.possibleMoves)},this.chessground.set(r),n.san&&o&&site.sound.move(n),this.autoScroll(),this.auxUpdate(n.fen),site.pubsub.emit("ply",t),!0};this.canMove=()=>!this.replaying()&&this.data.player.color===this.chessground.state.turnColor;this.replayEnabledByPref=()=>{let t=this.data;return t.pref.replay===Ht.Always||t.pref.replay===Ht.OnlySlowGames&&(t.game.speed==="classical"||t.game.speed==="correspondence")};this.isLate=()=>this.replaying()&&un(this.data);this.playerAt=t=>this.flip^t==="top"?this.data.opponent:this.data.player;this.flipNow=()=>{this.flip=!this.nvui&&!this.flip,this.chessground.set({orientation:Ut(this.data,this.flip)}),this.redraw()};this.setTitle=()=>In(this);this.actualSendMove=(t,o,n={})=>{let r={sign:this.sign,ackable:!0};if(this.clock)if(r.withLag=!this.shouldSendMoveTime||!this.clock.isRunning(),n.premove&&this.shouldSendMoveTime)this.clock.hardStopClock(),r.millis=0;else{let i=this.clock.stopClock();i!==void 0&&this.shouldSendMoveTime&&(r.millis=i)}this.socket.send(t,o,r),this.justDropped=n.justDropped,this.justCaptured=n.justCaptured,this.preDrop=void 0,this.transientMove.register(),this.redraw()};this.auxMove=(t,o,n)=>{!n&&(this.chessground.move(t,o),this.chessground.state.movable.dests=void 0,this.chessground.state.turnColor=j(this.chessground.state.turnColor),this.startPromotion(t,o,{premove:!1}))||this.sendMove(t,o,n,{premove:!1})};this.auxUpdate=t=>{var o,n;(o=this.voiceMove)==null||o.update({fen:t,canMove:this.canMove()}),(n=this.keyboardMove)==null||n.update({fen:t,canMove:this.canMove()})};this.sendMove=(t,o,n,r)=>{let i={u:t+o};n&&(i.u+=n==="knight"?"n":n[0]),Xt()&&(i.b=1),this.resign(!1),this.data.pref.submitMove&&this.confirmMoveEnabled()&&!r.premove?(this.moveToSubmit=i,this.redraw()):this.actualSendMove("move",i,{justCaptured:r.captured,premove:r.premove})};this.sendNewPiece=(t,o,n)=>{let r={role:t,pos:o};Xt()&&(r.b=1),this.resign(!1),this.data.pref.submitMove&&this.confirmMoveEnabled()&&!n?(this.dropToSubmit=r,this.redraw()):this.actualSendMove("drop",r,{justDropped:t,premove:n})};this.showYourMoveNotification=()=>{let t=this.data,o=$("body").hasClass("zen")?"Your opponent":_r(this,t.opponent),n=`${o}
joined the game.`;z(t)?rt(()=>{let r=this.noarg("yourTurn");if(this.ply<1)r=`${n}
${r}`;else{let i=t.steps[t.steps.length-1].san;i=`${Math.floor((this.ply-1)/2)+1}${this.ply%2===1?".":"..."} ${i}`,r=`${o}
played ${i}.
${r}`}return r}):this.isPlaying()&&this.ply<1&&rt(n)};this.playerByColor=t=>this.data[t===this.data.player.color?"player":"opponent"];this.apiMove=t=>{var a,l;let o=this.data,n=this.isPlaying();o.game.turns=t.ply,o.game.player=t.ply%2===0?"white":"black";let r=t.ply%2===0?"black":"white",i=o.player.color===o.game.player;if(t.status&&(o.game.status=t.status),t.winner&&(o.game.winner=t.winner),this.playerByColor("white").offeringDraw=t.wDraw,this.playerByColor("black").offeringDraw=t.bDraw,o.possibleMoves=i?t.dests:void 0,o.possibleDrops=i?t.drops:void 0,o.crazyhouse=t.crazyhouse,this.setTitle(),!this.replaying()){if(this.ply++,t.role)this.chessground.newPiece({role:t.role,color:r},t.uci.slice(2,4));else{let u=$e(t.uci),p=this.chessground.state.pieces;(!t.castle||((a=p.get(t.castle.king[0]))==null?void 0:a.role)==="king"&&((l=p.get(t.castle.rook[0]))==null?void 0:l.role)==="rook")&&this.chessground.move(u[0],u[1])}t.promotion&&be(this.chessground,t.promotion.key,t.promotion.pieceClass),this.chessground.set({turnColor:o.game.player,movable:{dests:n?Pe(o.possibleMoves):new Map},check:!!t.check}),t.check&&site.sound.play("check"),qn(),site.pubsub.emit("ply",this.ply)}o.game.threefold=!!t.threefold;let s={ply:this.lastPly()+1,fen:t.fen,san:t.san,uci:t.uci,check:t.check,crazy:t.crazyhouse};if(o.steps.push(s),this.justDropped=void 0,this.justCaptured=void 0,et(o,r,!0),this.data.forecastCount=void 0,t.clock){this.shouldSendMoveTime=!0;let u=t.clock,p=n&&i?0:u.lag||1;this.clock?this.clock.setClock(o,u.white,u.black,p):this.corresClock&&this.corresClock.update(u.white,u.black)}if(this.data.expiration&&(this.data.steps.length>2?this.data.expiration=void 0:this.data.expiration.movedAt=Date.now()),this.redraw(),n&&r==o.player.color&&(this.transientMove.clear(),this.moveOn.next(),qr(o,t)),!this.replaying()&&r!=o.player.color){let u=o.game.variant.key==="atomic"?100:1;setTimeout(()=>{this.nvui?this.nvui.playPremove(this):!this.chessground.playPremove()&&!this.playPredrop()&&(this.promotion.cancel(),this.showYourMoveNotification())},u)}return this.autoScroll(),this.onChange(),this.auxUpdate(s.fen),site.sound.move({...t,filter:"music"}),site.sound.saySan(s.san),!0};this.crazyValid=(t,o)=>ft(this.data,t,o);this.playPredrop=()=>this.chessground.playPredrop(t=>ft(this.data,t.role,t.key));this.reload=t=>{t.steps.length!==this.data.steps.length&&(this.ply=t.steps[t.steps.length-1].ply),$t(t),this.data=t,this.clearJust(),this.shouldSendMoveTime=!1,this.clock&&this.clock.setClock(t,t.clock.white,t.clock.black),this.corresClock&&this.corresClock.update(t.correspondence.white,t.correspondence.black),this.replaying()||Tn(this),this.setTitle(),this.moveOn.next(),this.setQuietMode(),this.redraw(),this.autoScroll(),this.onChange(),this.setLoading(!1),this.auxUpdate(t.steps[t.steps.length-1].fen)};this.endWithData=t=>{var n,r;let o=this.data;if(o.game.winner=t.winner,o.game.status=t.status,o.game.boosted=t.boosted,o.player.blindfold=!1,this.userJump(this.lastPly()),o.game.fen=o.steps[o.steps.length-1].fen,t.status.name==="outoftime"&&o.player.color!==t.winner&&this.chessground.state.turnColor===o.opponent.color&&this.reload(o),this.promotion.cancel(),this.chessground.stop(),t.ratingDiff&&(o.player.ratingDiff=t.ratingDiff[o.player.color],o.opponent.ratingDiff=t.ratingDiff[o.opponent.color]),!o.player.spectator&&o.game.turns>1){let i=t.winner?o.player.color===t.winner?"victory":"defeat":"draw";site.sound.play(i),i!="victory"&&o.game.turns>6&&!o.tournament&&!o.swiss&&site.storage.boolean("courtesy").get()&&((r=(n=this.opts.chat)==null?void 0:n.instance)==null||r.then(s=>s.post("Good game, well played")))}mi(),o.crazyhouse&&vr(),this.clearJust(),this.setTitle(),this.moveOn.next(),this.setQuietMode(),this.setLoading(!1),this.clock&&t.clock&&this.clock.setClock(o,t.clock.wc*.01,t.clock.bc*.01),this.redraw(),this.autoScroll(),this.onChange(),o.tv&&setTimeout(site.reload,1e4),Gr(),this.data.game.status.name==="started"?site.sound.saySan(this.stepAt(this.ply).san,!1):site.sound.say(Oe(this),!1,!1,!0)};this.challengeRematch=async()=>{await En(this.data.game.id),site.pubsub.emit("challenge-app.open"),site.once("rematch-challenge")&&setTimeout(()=>{site.asset.hopscotch(function(){window.hopscotch.configure({i18n:{doneBtn:"OK, got it"}}).startTour({id:"rematch-challenge",showPrevButton:!0,steps:[{title:"Challenged to a rematch",content:"Your opponent is offline, but they can accept this challenge later!",target:"#challenge-app",placement:"bottom"}]})})},1e3)};this.makeCorrespondenceClock=()=>{this.data.correspondence&&!this.corresClock&&(this.corresClock=new ct(this,this.data.correspondence,this.socket.outoftime))};this.corresClockTick=()=>{this.corresClock&&A(this.data)&&(this.corresClock.tick(this.data.game.player),this.redraw())};this.setQuietMode=()=>{let t=site.quietMode,o=this.isPlaying();t!==o&&(site.quietMode=o,$("body").toggleClass("no-select",o&&this.clock&&this.clock.millisOf(this.data.player.color)<=3e5))};this.question=()=>{var t;return this.moveToSubmit||this.dropToSubmit?(setTimeout(()=>{var o;return(o=this.voiceMove)==null?void 0:o.listenForResponse("submitMove",this.submitMove)}),{prompt:this.noarg("confirmMove"),yes:{action:()=>this.submitMove(!0)},no:{action:()=>this.submitMove(!1),key:"cancel"}}):this.data.player.proposingTakeback?((t=this.voiceMove)==null||t.listenForResponse("cancelTakeback",this.cancelTakebackPreventDraws),{prompt:this.noarg("takebackPropositionSent"),no:{action:this.cancelTakebackPreventDraws,key:"cancel"}}):this.data.player.offeringDraw?{prompt:this.noarg("drawOfferSent")}:this.data.opponent.offeringDraw?{prompt:this.noarg("yourOpponentOffersADraw"),yes:{action:()=>this.socket.send("draw-yes"),icon:re},no:{action:()=>this.socket.send("draw-no")}}:this.data.opponent.proposingTakeback?{prompt:this.noarg("yourOpponentProposesATakeback"),yes:{action:this.takebackYes,icon:Me},no:{action:()=>this.socket.send("takeback-no")}}:this.voiceMove?this.voiceMove.question():!1};this.takebackYes=()=>{this.socket.sendLoading("takeback-yes"),this.chessground.cancelPremove(),this.promotion.cancel()};this.resign=(t,o)=>{t?(this.resignConfirm||!this.data.pref.confirmResign||o?(this.socket.sendLoading("resign"),clearTimeout(this.resignConfirm)):this.resignConfirm=setTimeout(()=>this.resign(!1),3e3),this.redraw()):this.resignConfirm&&(clearTimeout(this.resignConfirm),this.resignConfirm=void 0,this.redraw())};this.goBerserk=()=>{Ze(this.data)&&(this.goneBerserk[this.data.player.color]||(this.socket.berserk(),site.sound.play("berserk")))};this.setBerserk=t=>{this.goneBerserk[t]||(this.goneBerserk[t]=!0,t!==this.data.player.color&&site.sound.play("berserk"),this.redraw(),$(`<i data-icon="${xe}">`).appendTo($(`.game__meta .player.${t} .user-link`)))};this.setLoading=(t,o=1500)=>{clearTimeout(this.loadingTimeout),t?(this.loading=!0,this.loadingTimeout=setTimeout(()=>{this.loading=!1,this.redraw()},o),this.redraw()):this.loading&&(this.loading=!1,this.redraw())};this.setRedirecting=()=>{this.redirecting=!0,site.unload.expected=!0,setTimeout(()=>{this.redirecting=!1,this.redraw()},2500),this.redraw()};this.submitMove=t=>{let o=this.moveToSubmit||this.dropToSubmit;t&&o?(this.moveToSubmit?this.actualSendMove("move",this.moveToSubmit):this.actualSendMove("drop",this.dropToSubmit),site.sound.play("confirmation")):this.jump(this.ply),this.cancelMove(),o&&this.setLoading(!0,300)};this.cancelMove=()=>{this.moveToSubmit=void 0,this.dropToSubmit=void 0};this.onChange=()=>{this.opts.onChange&&setTimeout(()=>this.opts.onChange(this.data),150)};this.setGone=t=>{Nt(this.data,this.data.opponent.color,t),clearTimeout(this.goneTick),Number(t)>1&&(this.goneTick=setTimeout(()=>{let o=Number(this.opponentGone());o>1&&this.setGone(o-1)},1e3)),this.redraw()};this.opponentGone=()=>{let t=this.data;return U(t.opponent.isGone)&&t.opponent.isGone!==!1&&!z(t)&&Qe(t)&&t.opponent.isGone};this.canOfferDraw=()=>!this.preventDrawOffer&&fn(this.data)&&(this.data.player.lastDrawOfferAtPly||-99)<this.ply-20;this.cancelTakebackPreventDraws=()=>{this.socket.sendLoading("takeback-no"),clearTimeout(this.preventDrawOffer),this.preventDrawOffer=setTimeout(()=>{this.preventDrawOffer=void 0,this.redraw()},4e3)};this.offerDraw=(t,o)=>{this.canOfferDraw()&&(this.drawConfirm?(t&&this.doOfferDraw(),clearTimeout(this.drawConfirm),this.drawConfirm=void 0):t&&(this.data.pref.confirmResign&&!o?this.drawConfirm=setTimeout(()=>{this.offerDraw(!1)},3e3):this.doOfferDraw())),this.redraw()};this.doOfferDraw=()=>{this.data.player.lastDrawOfferAtPly=this.ply,this.socket.sendLoading("draw-yes",null)};this.setChessground=t=>{var n;this.chessground=t;let o={fen:this.stepAt(this.ply).fen,canMove:this.canMove(),cg:t};this.isPlaying()&&(this.data.pref.keyboardMove&&((n=this.keyboardMove)!=null||(this.keyboardMove=Cr(this)),this.keyboardMove.update(o)),this.data.pref.voiceMove&&(this.voiceMove?this.voiceMove.update(o):this.voiceMove=ao(this,o)),(this.keyboardMove||this.voiceMove)&&requestAnimationFrame(()=>this.redraw()))};this.stepAt=t=>fe(this.data,t);this.speakClock=()=>{var t;(t=this.clock)==null||t.speak()};this.blindfold=t=>{var o;return t===void 0||t===this.data.player.blindfold?(o=this.data.player.blindfold)!=null?o:!1:(this.blindfoldStorage.set(t),this.data.player.blindfold=t,this.socket.send(`blindfold-${t?"yes":"no"}`),this.redraw(),t)};this.delayedInit=()=>{site.requestIdleCallback(()=>{let t=this.data;this.isPlaying()&&(t.simul||zn(t.steps.length>2),Bn(),this.setTitle(),t.crazyhouse&&br(this),!this.nvui&&t.clock&&!t.opponent.ai&&!this.isSimulHost()&&window.addEventListener("beforeunload",o=>{if(site.unload.expected||!this.isPlaying())return;this.socket.send("bye2");let n="There is a game in progress!";return(o||window.event).returnValue=n,n}),!this.nvui&&t.pref.submitMove&&site.mousetrap.bind("esc",()=>{this.submitMove(!1),this.chessground.cancelMove()}).bind("return",()=>this.submitMove(!0)),zr(this)),this.nvui||Wr(this),this.isPlaying()&&t.steps.length===1&&(site.storage.get("blindfold")==="true"&&(site.storage.remove("blindfold"),this.blindfoldStorage.set(!0)),this.blindfold(this.blindfoldStorage.get())),Ur(),setTimeout(()=>{$("#KeyboardO,#show_btn,#shadowHostId").length&&(alert("Play enhancement extensions are no longer allowed!"),site.socket.destroy(),this.setRedirecting(),location.href="/page/play-extensions")},1e3),this.onChange()},800)};var i,s,a;$t(t.data);let r=this.data=t.data;this.ply=ee(r),this.goneBerserk[r.player.color]=r.player.berserk,this.goneBerserk[r.opponent.color]=r.opponent.berserk,setTimeout(()=>{this.firstSeconds=!1,this.redraw()},3e3),this.socket=On(t.socketSend,this),this.blindfoldStorage=site.storage.boolean(`blindfold.${(s=(i=this.data.player.user)==null?void 0:i.id)!=null?s:"anon"}`),r.clock?this.clock=new lt(r,{onFlag:this.socket.outoftime,soundColor:r.simul||r.player.spectator||!r.pref.clockSound?void 0:r.player.color,nvui:!!this.nvui}):(this.makeCorrespondenceClock(),setInterval(this.corresClockTick,1e3)),this.promotion=new mt(l=>l(this.chessground),()=>{this.chessground.cancelPremove(),it(this).then(this.reload,site.reload)},this.redraw,r.pref.autoQueen),this.setQuietMode(),this.moveOn=new _e(this,"move-on"),this.transientMove=new Be(this.socket),this.menu=Y(!1,o),this.trans=site.trans(t.i18n),this.noarg=this.trans.noarg,setTimeout(this.delayedInit,200),setTimeout(this.showExpiration,350),(a=document.referrer)!=null&&a.includes("/serviceWorker.")||setTimeout(this.showYourMoveNotification,500),site.pubsub.on("jump",l=>{this.jump(parseInt(l)),this.redraw()}),site.pubsub.on("zen",()=>{let l=$("body").toggleClass("zen").hasClass("zen");window.dispatchEvent(new Event("resize")),$("body").hasClass("zen-auto")||$n(l)}),!this.opts.noab&&this.isPlaying()&&cn(this)}clearJust(){this.justDropped=void 0,this.justCaptured=void 0,this.preDrop=void 0}opponentRequest(t,o){var n;(n=this.voiceMove)==null||n.listenForResponse(t,r=>this.socket.sendLoading(`${t}-${r?"yes":"no"}`)),rt(this.noarg(o))}rematch(t){if(t===void 0)return this.data.opponent.offeringRematch===!0||this.data.player.offeringRematch===!0;if(t){if(this.data.game.rematch&&(location.href=ae(this.data.game.rematch,this.data.opponent.color)),!Xe(this.data))return!1;this.data.opponent.offeringRematch||(this.data.player.offeringRematch=!0),this.socket.send("rematch-yes")}else{if(!this.data.opponent.offeringRematch)return!1;this.socket.send("rematch-no")}return this.redraw(),!0}};var hi=wt([Ct,xt]);function zp(e){Zo(e,wa)}function wa(e,t){let o=new ze(e,i,t),n=Co(o);e.element.innerHTML="";let r=hi(e.element,n);function i(){r=hi(r,Co(o))}return window.addEventListener("resize",i),o.isPlaying()&&en(),site.sound.preloadBoardSounds(),{socketReceive:o.socket.receive,moveOn:o.moveOn}}export{zp as initModule};
/*!
 * hoverIntent v1.10.0 // 2019.02.25 // jQuery v1.7.0+
 * http://briancherne.github.io/jquery-hoverIntent/
 *
 * You may use hoverIntent under the terms of the MIT license. Basically that
 * means you are free to use hoverIntent as long as this header is left intact.
 * Copyright 2007-2019 Brian Cherne
 */
